<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.81.0"><link rel=canonical type=text/html href=https://kubecube-io.github.io/blog/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>博客 | KubeCube</title><meta name=description content="开源容器平台"><meta property="og:title" content="博客"><meta property="og:description" content="开源容器平台"><meta property="og:type" content="website"><meta property="og:url" content="https://kubecube-io.github.io/blog/"><meta property="og:site_name" content="KubeCube"><meta itemprop=name content="博客"><meta itemprop=description content="开源容器平台"><meta name=twitter:card content="summary"><meta name=twitter:title content="博客"><meta name=twitter:description content="开源容器平台"><link rel=preload href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css as=style><link href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class="td-section td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="4984" height="1e3" viewBox="0 0 4984 1e3" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3551.54 432.823C3552.84 435.556 3555.59 437.298 3558.62 437.298H3658.46C3663.69 437.298 3667.45 432.277 3665.98 427.259 3634.56 319.831 3535.31 241.352 3417.7 241.352H3402.03c-142.85.0-258.65 115.801-258.65 258.648v31.352c0 142.847 115.8 258.648 258.65 258.648H3417.7c117.61.0 216.86-78.48 248.28-185.907C3667.45 599.075 3663.69 594.054 3658.46 594.054H3558.62C3555.59 594.054 3552.84 595.796 3551.54 598.529 3526.37 651.507 3472.39 688.108 3409.87 688.108 3323.29 688.108 3253.11 617.926 3253.11 531.352V5e2C3253.11 413.426 3323.29 343.243 3409.87 343.243c62.52.0 116.5 36.601 141.67 89.58z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4970.89 651.516C4972.68 646.419 4968.9 641.081 4963.5 641.081H4867.67C4865.09 641.081 4862.68 642.35 4861.21 644.474 4842.85 671.15 4813.84 688.108 4781.45 688.108 4736.6 688.108 4698.03 655.443 4685.65 609.73h288.5C4978.15 609.73 4981.51 606.719 4981.95 602.744 4982.82 594.747 4983.27 586.616 4983.27 578.378c0-116.507-90-211.621-201.820000000001-211.621-111.83.0-201.83 95.114-201.83 211.621S4669.62 790 4781.45 790C4868.6 790 4942.57 732.144 4970.89 651.516zM4781.45 468.649C4819.59 468.649 4853.14 492.229 4869.98 527.433H4692.92C4709.75 492.229 4743.3 468.649 4781.45 468.649z" fill="#333"/><path d="M3727 386C3727 381.582 3730.58 378 3735 378h86C3825.42 378 3829 381.582 3829 386V612.5C3829 654.197 3862.8 688 3904.5 688s75.5-33.803 75.5-75.5V386C3980 381.582 3983.58 378 3988 378h86C4078.42 378 4082 381.582 4082 386V770C4082 774.418 4078.42 778 4074 778h-86C3983.58 778 3980 774.418 3980 770V764.6C3954.53 780.689 3924.35 790 3892 790 3800.87 790 3727 716.127 3727 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M3072.22 651.516C3074.01 646.419 3070.22 641.081 3064.82 641.081H2968.99C2966.42 641.081 2964 642.35 2962.54 644.474 2944.17 671.15 2915.17 688.108 2882.77 688.108 2837.92 688.108 2799.35 655.443 2786.97 609.73h288.51C3079.48 609.73 3082.84 606.719 3083.27 602.744 3084.15 594.747 3084.59 586.616 3084.59 578.378c0-116.507-90-211.621-201.82-211.621s-201.82 95.114-201.82 211.621S2770.95 790 2882.77 790C2969.93 790 3043.9 732.144 3072.22 651.516zM2882.77 468.649C2920.92 468.649 2954.47 492.229 2971.3 527.433H2794.24C2811.07 492.229 2844.62 468.649 2882.77 468.649z" fill="#333"/><path d="M1342 770.243C1342 774.661 1345.58 778.243 1350 778.243H1435.89c4.41999999999985.0 8-3.58200000000011 8-8V592.206L1495.37 540.725l196.9 234.656C1693.79 777.193 1696.04 778.239 1698.4 778.239h112.12C1817.32 778.239 1821.02 770.302 1816.65 765.096L1567.7 468.401l244.74-244.744C1817.48 218.617 1813.91 210 1806.78 210H1685.31C1683.19 210 1681.16 210.843 1679.66 212.343L1443.89 448.109V218C1443.89 213.582 1440.31 210 1435.89 210H1350C1345.58 210 1342 213.582 1342 218V770.243z" fill="#333"/><path d="M1828 386C1828 381.582 1831.58 378 1836 378h86C1926.42 378 1930 381.582 1930 386V612.5c0 41.697 33.8 75.5 75.5 75.5s75.5-33.803 75.5-75.5V386C2081 381.582 2084.58 378 2089 378h86C2179.42 378 2183 381.582 2183 386V770C2183 774.418 2179.42 778 2175 778h-86C2084.58 778 2081 774.418 2081 770V764.6C2055.53 780.689 2025.35 790 1993 790 1901.87 790 1828 716.127 1828 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M2254 210C2249.58 210 2246 213.582 2246 218V770C2246 774.418 2249.58 778 2254 778h86C2344.42 778 2348 774.418 2348 770V757.487C2378.39 778.082 2414.4 790 2453 790c108.8.0 197-94.692 197-211.5S2561.8 367 2453 367C2414.4 367 2378.39 378.918 2348 399.513V218C2348 213.582 2344.42 210 2340 210h-86zm94 368.5c0 60.475 44.77 109.5 1e2 109.5s1e2-49.025 1e2-109.5S2503.23 469 2448 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4153 210C4148.58 210 4145 213.582 4145 218V770C4145 774.418 4148.58 778 4153 778h86C4243.42 778 4247 774.418 4247 770V757.487C4277.39 778.082 4313.4 790 4352 790c108.8.0 197-94.692 197-211.5S4460.8 367 4352 367C4313.4 367 4277.39 378.918 4247 399.513V218C4247 213.582 4243.42 210 4239 210h-86zm94 368.5C4247 638.975 4291.77 688 4347 688s1e2-49.025 1e2-109.5S4402.23 469 4347 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path d="M554.586 39C564.593 21.6667 552.084.0 532.069.0H346.41c-35.726.0-68.739 19.0599-86.602 50L28.8676 450C11.0043 480.94 11.0042 519.06 28.8675 550L259.808 950C277.671 980.94 310.684 1e3 346.41 1e3H447.276C456.208 1e3 464.461 995.235 468.927 987.5L612.399 739C622.406 721.667 609.897 7e2 589.882 7e2H427.239C412.949 7e2 399.743 692.376 392.598 680L300.222 520C293.077 507.624 293.077 492.376 300.222 480l85.964-148.894L386 330.999 554.586 39z" fill="#0056ff"/><path d="M564.401 3e2C544.386 3e2 531.877 278.333 541.884 261L685.356 12.5C689.822 4.76496 698.075.0 707.006.0H808.29C844.017.0 877.03 19.06 894.893 50.0001L1125.83 450C1143.7 480.94 1143.7 519.06 1125.83 550L894.893 950C877.03 980.94 844.017 1e3 808.29 1e3H622.214C602.199 1e3 589.69 978.333 599.697 961L750.385 7e2H750.555L854.478 520C861.624 507.624 861.624 492.376 854.478 480L762.102 320C754.957 307.624 741.752 3e2 727.461 3e2H564.401z" fill="#0056ff"/></svg></span><span class="text-uppercase font-weight-bold">KubeCube</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/kubecube-io/kubecube target=_blank><i class="fab fa-github"></i><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.d5a631f6a2fe4c00c21a0bc429b81434.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/blog/>返回本页常规视图</a>.</p></div><h1 class=title>博客</h1><ul><li><a href=#pg-7a02a638f7e4da5168f4bcb1b7c13531>KubeCube v1.8 版本发布</a></li><li><a href=#pg-503022344b40d5ace4dc2d9e909a02b2>KubeCube 版本转换：大幅提升K8s版本适配能力</a></li><li><a href=#pg-463fe74f7f10b41310a5836409b09d4e>KubeCube v1.1 版本发布</a></li><li><a href=#pg-4ab1727c2dc711d75ee8df94398b303f>深入解读 KubeCube 多集群管理</a></li><li><a href=#pg-baa4390a8c5d8984591e024686901ec7>KubeCube 多级租户模型</a></li><li><a href=#pg-c143c5399df70c6b147a347702ce6967>KubeCube设计实践，初学者玩好Kubernetes的正确姿势</a></li><li><a href=#pg-62afa3b932f60499a0ebd57d10189faa>KubeCube开源：魔方六面，降阶Kubernetes落地应用</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-7a02a638f7e4da5168f4bcb1b7c13531>KubeCube v1.8 版本发布</h1><div class="td-byline mb-4">By <b>蔡鑫涛</b> |
<time datetime=2023-04-10 class=text-muted>Monday, April 10, 2023</time></div><p>在本次的 KubeCube 新版本中，日志模块<strong>集成了 <a href=https://github.com/loggie-io/loggie>Loggie</a></strong>，它是一个基于Golang的轻量级、高性能、云原生日志采集Agent和中转处理Aggregator，支持多Pipeline和组件热插拔。</p><p>在部署方面 KubeCube 提供了<strong>通过 Helm 安装 KubeCube</strong> 的方式，这使得 KubeCube 更加专注容器平台自身。关于 K8s 的安装，KubeCube 保留了通过 All-In-One 部署脚本进行的单节点 K8s 集群的安装。关于自定义的 K8s 集群安装，可以使用 kubeadm、<a href=https://github.com/gopixiu-io/kubez-ansible>kubez-ansible</a> 等开源工具，之后 kubez-ansible 中也会集成 KubeCube。</p><p>除此之外，KubeCube 新增了一些 Features，比如支持自定义启用 controller、支持删除租户项目、支持使用 http 模式启动等特性。在<strong>稳定性方面</strong>，进行了一些 Bug 修复。</p><h2 id=为什么使用-loggie>为什么使用 Loggie</h2><p>KubeCube 在 1.8 之前使用 filebeat 作为日志 agent，在使用过程中，我们遇到了一些特性的短板，比如容器内部日志文件的采集，多 pipeline 和多输出源，以及在 K8s 场景下，我们更希望通过原生的方式进行动态的配置变更。出于以上考量，我们决定在 1.8 版本使用 loggie 替换 filebeat，loggie 的性能优异，轻量，并且提供了：</p><ul><li><strong>一栈式日志解决方案</strong>：同时支持日志中转、过滤、解析、切分、日志报警等。</li><li><strong>云原生的日志形态</strong>：快速便捷的容器日志采集方式，原生的Kubernetes动态配置下发。</li><li><strong>生产级的特性</strong>：Loggie吸收了我们长期的大规模运维经验，形成了全方位的可观测性、快速排障、异常预警、自动化运维能力。</li></ul><p>关于 Loggie 的更多特性以及使用方式，请参考 <a href=https://loggie-io.github.io/docs/>Loggie 官方文档</a>。</p><h3 id=使用-hotplug-开启-loggie>使用 hotplug 开启 Loggie</h3><p>请参考 <a href=https://www.kubecube.io/docs/installation-guide/hotplug/open-loggie>开启loggie文档</a> 来在 KubeCube 中开启 Loggie 特性。</p><h3 id=使用-loggie-进行日志采集>使用 Loggie 进行日志采集</h3><p>请参考 <a href=https://www.kubecube.io/docs/user-guide/logs>日志使用文档</a> 来进行采集任务的管理和相关的日志查询。</p><h2 id=使用-helm-方式简化-kubecube-部署>使用 Helm 方式简化 KubeCube 部署</h2><p>KubeCube 新增了 <a href=https://github.com/kubecube-io/kubecube-chart>kubecube-chart</a> 工程，用于维护 KubeCube 的部署 chart，用户可以直接使用该工程进行 KubeCube 的管控面和计算面的部署。</p><p>KubeCube 新增了 <a href=https://github.com/kubecube-io/hotplugs>hotplugs</a> 工程，用于维护 KubeCube 所用的热插拔部署包，上文提到的 Loggie，就是作为 KubeCube 的一个热插拔组件，维护在该工程中。后期，用户也可以通过自己的热插拔部署包，使用 KubeCube 的热插拔框架进行能力拓展。</p><p>KubeCube 更加专注容器平台自身，提供通过 helm 的方式在已有的 k8s 上安装 KubeCube，同时，为了让用户在裸机上快速体验 KubeCube，KubeCube 保留了 All-In-One 的安装方式，注意，All-In-One 的部署模式，只能用作 POC，不能用于生产。关于 K8s 的安装，社区已经有许多成熟的方案，比如标准的 kubeadm 安装方式，更加自动化的 kubez-ansible 方式等，用户可以根据自己的需求，进行自定义的 K8s 集群安装，随后在已有的 K8s 上安装 KubeCube。</p><h2 id=稳定性提升>稳定性提升</h2><p>除了上述内容外，KubeCube 还进行了一些问题修复和功能增强。</p><ul><li>对服务发现接口增加缓存以提升服务发现的性能和稳定性：使用 client-go/discovery/cached/memory 对首次服务发现的结果进行缓存，以缓解每次进行服务发现都需要请求 k8s-apiserver 接口的 IO 瓶颈。</li><li>优化了用户从属关系判断：原先 KubeCube 通过查询 user 相关 RoleBinding 来判断用户所属的项目租户，优化后通过 RoleBinding Controller 将用户的关系写入 user.Status 中，判断用户的从属关系只需要查询 user.Status 即可，提升了从属判断的准确性和效率。</li><li>修复了认证 http.Client 连接泄漏问题：在对接第三方认证时，每一次认证请求，都会初始化一个新的 http.Client 句柄，并且再请求完成后没有释放该连接，在请求量大的时候，导致客户端侧端口被用尽。修复后，复用了同一个 http.Client 句柄，并且在连接空闲释放连接。</li><li>允许自定义 controllers 的启动：KubeCube 拥有若干用于监听 K8s 资源的 controllers，在一些场景下，我们并不需要某些 controllers 工作，此时，全量启动 controllers 会造成资源浪费，新版本中，KubeCube 允许用户指定所需的 conntrollers。</li><li>优化了代理 filter 接口：KubeCube 代理了 k8s-apiserver 服务，并对外提供类 k8s-apiserver 的接口，同时，KubeCube 增强了接口的处理能力，支持更加丰富的分页、过滤、模糊搜索等能力，新版本中，优化了 filter 的性能，增加了接口响应速度。</li></ul><h2 id=写在最后>写在最后</h2><p>未来我们会持续提供更多功能，帮助企业简化容器化落地。也欢迎大家参与贡献，提出宝贵的建议。添加以下微信进入 KubeCube 交流群。</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=zoom:40%></p><p><strong>作者简介：</strong> 蔡鑫涛，网易数帆轻舟容器平台资深开发，KubeCube Committer，Kubernetes Member</p></div><div class=td-content style=page-break-before:always><h1 id=pg-503022344b40d5ace4dc2d9e909a02b2>KubeCube 版本转换：大幅提升K8s版本适配能力</h1><div class="td-byline mb-4">By <b>蔡鑫涛</b> |
<time datetime=2022-09-13 class=text-muted>Tuesday, September 13, 2022</time></div><p>KubeCube 迎来了新版本的发布，新增了 K8s 版本转化、HNC GA 版本适配、审计信息国际化、warden 主动上报模式，为集群和项目设置 Ingress 域名后缀等特性，也修复了若干已知问题，详见 <a href=https://github.com/kubecube-io/KubeCube/blob/release-v1.4/docs/changelog.md>ChangeLog</a>。</p><p>该版本中最主要的特性是 Version-Conversion 能力的支持，使得接入 KubeCube 的用户无需感知被 KubeCube 接管的 K8s 集群版本，可以使用指定版本的 K8s API 来操作 K8s 资源，KubeCube 会做自适应转化；同时 KubeCube 也将这个能力包装成 SDK 供外部使用。</p><h2 id=为什么需要多-k8s-版本转化>为什么需要多 K8s 版本转化？</h2><p>在实际的生产场景中，用户的 K8s 版本往往固置于某一稳定版本，随着时间的推移，用户往往在该 k8s 集群中沉淀了大量的业务、工具、方案等，同时 K8s 社区又会不断的推出更高的版本，此时的 k8s 版本升级往往需要比较高的代价。</p><p>然而K8s 的版本升级，并不总是保证 API 的完美兼容，绝大多数的 API 会经历从 Development level &ndash;> Alpha level &ndash;> Beta level &ndash;> Stable level 的发展阶段，理想情况下，用户应该使用 Stable level 的 api 用于生产环境，但是现实中，用户所使用的某一资源的 API 很可能处于 Stable level 以下的阶段，比如 extensions/v1beta1 的 Deployment 和 apps/v1 的 Deployment。详见 <a href=https://kubernetes.io/docs/reference/using-api/deprecation-guide/#migrate-to-non-deprecated-apis>K8S API 变动规划</a>。</p><p>当用户需要在控制面纳管多 K8s 集群时，用户暂时不希望升级老的稳定的 K8s 集群，又希望新增的 K8s 集群是比较高的版本，这时，管控面的 KubeCube，就能够提供访问多版本 K8s 的能力，对外暴露统一的 K8s 风格的 RESTfule API，用户既可以使用精确的 GVR 去访问不同版本的 K8s 资源，也可用使用统一版本的 GVR 去访问不同版本的 K8s 资源，KubeCube 会做自适应转化。</p><p><img src=imgs/multi-k8s-version.png alt=multi-k8s-version></p><h2 id=k8s-native-convert>K8s native convert</h2><h3 id=1-k8s-api-workflow>1. K8s api workflow</h3><p><img src=imgs/k8s-api-flow.png alt=k8s-api-flow></p><h3 id=2-k8s-version-convert>2. K8s version convert</h3><p><img src=imgs/k8s-version-convert.png alt=k8s-version-convert></p><p><strong>k8s 版本转换原则</strong></p><ol><li>同一个 group 的不同 version 都可以转换成该 group 的 internalVersion</li><li>某一 group 的 internalVersion 可以转换成该 group 下的任一 version</li></ol><p><strong>K8s 版本转化的核心——scheme</strong></p><p>Scheme 中拥有 <code>concerter</code> 转化器，其内部存放了各个 API 注册的版本转化函数。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Scheme</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#ce5c00;font-weight:700>...</span>

	<span style=color:#8f5902;font-style:italic>// converter stores all registered conversion functions. It also has
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// default converting behavior.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>converter</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>conversion</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Converter</span>

	<span style=color:#ce5c00;font-weight:700>...</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Converter knows how to convert one type to another.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Converter</span> <span style=color:#204a87;font-weight:700>struct</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// Map from the conversion pair to a function which can
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#8f5902;font-style:italic>// do the conversion.
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>conversionFuncs</span>          <span style=color:#000>ConversionFuncs</span>
	<span style=color:#000>generatedConversionFuncs</span> <span style=color:#000>ConversionFuncs</span>

	<span style=color:#8f5902;font-style:italic>// Set of conversions that should be treated as a no-op
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ignoredUntypedConversions</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>typePair</span><span style=color:#000;font-weight:700>]</span><span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>我们已经知道 internalVersion 和指定 version 之间的转换规则，它们的转换函数位于 k8s apis 的定义文件夹下，如：pkg/apis/apps/v1/zz_generated.conversion.go</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// Code generated by conversion-gen. DO NOT EDIT.
</span><span style=color:#8f5902;font-style:italic></span>
<span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>v1</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>localSchemeBuilder</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Register</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>RegisterConversions</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// RegisterConversions adds conversion functions to the given scheme.
</span><span style=color:#8f5902;font-style:italic>// Public to allow building arbitrary schemes.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>RegisterConversions</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>这些转化函数，一般由 install 包下的 <code>Install(scheme)</code>函数注册到 <code>Scheme</code> 中。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// Package install installs the apps API group, making it available as
</span><span style=color:#8f5902;font-style:italic>// an option to all of the API encoding/decoding machinery.
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>package</span> <span style=color:#000>install</span>

<span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000;font-weight:700>)</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>init</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>Install</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>legacyscheme</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#8f5902;font-style:italic>// Install registers the API group and adds types to a scheme
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>Install</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>scheme</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>runtime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>utilruntime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Must</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>apps</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddToScheme</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>scheme</span><span style=color:#000;font-weight:700>))</span>
	<span style=color:#000>utilruntime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Must</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v1beta1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddToScheme</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>scheme</span><span style=color:#000;font-weight:700>))</span>
	<span style=color:#000>utilruntime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Must</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v1beta2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddToScheme</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>scheme</span><span style=color:#000;font-weight:700>))</span>
	<span style=color:#000>utilruntime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Must</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddToScheme</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>scheme</span><span style=color:#000;font-weight:700>))</span>
	<span style=color:#000>utilruntime</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Must</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>scheme</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetVersionPriority</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SchemeGroupVersion</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v1beta2</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SchemeGroupVersion</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>v1beta1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SchemeGroupVersion</span><span style=color:#000;font-weight:700>))</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>注册完的转会函数，将会在 Convert() 方法中使用。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// Convert will translate src to dest if it knows how. Both must be pointers.
</span><span style=color:#8f5902;font-style:italic>// If no conversion func is registered and the default copying mechanism
</span><span style=color:#8f5902;font-style:italic>// doesn&#39;t work on this type pair, an error will be returned.
</span><span style=color:#8f5902;font-style:italic>// &#39;meta&#39; is given to allow you to pass information to conversion functions,
</span><span style=color:#8f5902;font-style:italic>// it is not used by Convert() other than storing it in the scope.
</span><span style=color:#8f5902;font-style:italic>// Not safe for objects with cyclic references!
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Converter</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Convert</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>dest</span> <span style=color:#204a87;font-weight:700>interface</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#000>meta</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Meta</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 转换函数 map 的 key
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>pair</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>typePair</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>reflect</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TypeOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>reflect</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TypeOf</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dest</span><span style=color:#000;font-weight:700>)}</span>
  
  <span style=color:#8f5902;font-style:italic>// 实际的 convert 句柄
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>scope</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>scope</span><span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>converter</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#000>meta</span><span style=color:#000;font-weight:700>:</span>      <span style=color:#000>meta</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// ignore conversions of this type
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ignoredUntypedConversions</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pair</span><span style=color:#000;font-weight:700>];</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
	<span style=color:#000;font-weight:700>}</span>
  <span style=color:#8f5902;font-style:italic>// 使用预先注册的转换函数进行转换
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>fn</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>conversionFuncs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>untyped</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pair</span><span style=color:#000;font-weight:700>];</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fn</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>dest</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>scope</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>fn</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>generatedConversionFuncs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>untyped</span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pair</span><span style=color:#000;font-weight:700>];</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fn</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>dest</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>scope</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>dv</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>EnforcePtr</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>dest</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>err</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000>sv</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>EnforcePtr</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>src</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>err</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Errorf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;converting (%s) to (%s): unknown conversion&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>sv</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Type</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>dv</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Type</span><span style=color:#000;font-weight:700>())</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=kubecube-version-conversion>KubeCube version conversion</h2><p>了解了 k8s 版本转换的大致思路后，KubeCube 如果需要做版本转换的能力，需要做到以下几点：</p><ol><li>维护版本转换专用的 Scheme</li><li>注册所有的 k8s 的 api 转换函数，并提供拓展方法</li><li>使用 discovery client 提早做 src api 和 dest api 的转换检查</li></ol><h3 id=1-conversion-func-register>1. Conversion func register</h3><p><img src=imgs/conversion-func-register.png alt=conversion-func-register></p><p>KubeCube 会默认注册所有 k8s 原生资源的转换函数，同时也提供注册自定义资源转换函数的入口。</p><h3 id=2-greeting-target-cluster>2. Greeting target cluster</h3><p><img src=imgs/version-greeting.png alt=version-greeting></p><h3 id=3-controller-runtime-client-support>3. Controller-runtime client support</h3><p>KubeCube 的版本转化 SDK 提供了 Wrap controller-runtime 的 client.Client 的能力，可以将 client.Client 升级为具有版本转化能力的句柄。</p><h2 id=写在最后>写在最后</h2><p>未来我们会持续提供更多功能，帮助企业简化容器化落地。也欢迎大家参与贡献，提出宝贵的建议。添加以下微信进入 KubeCube 交流群。</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=zoom:40%></p><p><strong>作者简介：</strong> 蔡鑫涛，网易数帆轻舟容器平台资深开发，KubeCube Committer</p></div><div class=td-content style=page-break-before:always><h1 id=pg-463fe74f7f10b41310a5836409b09d4e>KubeCube v1.1 版本发布</h1><div class="td-byline mb-4">By <b>蔡鑫涛</b> |
<time datetime=2021-12-24 class=text-muted>Friday, December 24, 2021</time></div><p>KubeCube 迎来了 v1.1 版本的发布，新增了 OAuth2 的 GitHub 登录支持、租户配额的算法优化、Warden 热插拔安装包的本地和远端拉取支持等新的特性，也修复了若干已知问题，详见 <a href=https://github.com/kubecube-io/KubeCube/blob/release-v1.1/docs/changelog.md>ChangeLog</a>。</p><p>v1.1 版本中最主要的特性是 Auth-Proxy 能力的支持，使得部署更加轻量，无需侵入修改 kube-apiserver 的配置。用户可以使用 RESTful、client-go、kubectl 等方式访问被 KubeCube 纳管的 K8s 集群，享受统一的认证能力。</p><h2 id=使用-auth-webhook-的困境>使用 Auth-Webhook 的困境</h2><p><img src=imgs/auth-webhook.png alt=Auth-Webhook></p><p>在 KubeCube v1.1 版本之前，KubeCube 使用 K8s 提供的 Auth-Webook 方式来拓展认证能力，该方式通过为 kube-apiserver 指定认证后端来达到认证拓展的目的，kube-apiserver 会使用认证 Webhook 返回的 UserInfo 去进行下一步的鉴权流程。</p><p>该方式虽然能够使用 K8s 原生的方式拓展认证能力，但是在实际使用中存在一定的不足。如 <a href=https://github.com/kubecube-io/KubeCube/issues/62>Issues#62</a> 中所指出的，该方式需要修改 kube-apiserver 的启动参数，为其<a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/#webhook-token-authentication>指定额外的认证 Webhook 后端</a>，当我们的 K8s 集群是多 Master 节点的高可用集群时，需要修改每一个 Master 节点的 kube-apiserver 的配置，这在很多场景几乎是无法接受的。另外在一些云厂商的托管 K8s 场景下，往往只对用户提供工作节点，此时想修改 kube-apiserver 的配置是非常困难的。</p><h2 id=warden-auth-proxy>Warden-Auth-Proxy</h2><p><img src=imgs/auth-proxy.png alt=Auth-Proxy></p><p>对于 Auth-Webhook 面临的困境，我们设计了 Warden-Auth-Proxy 模块来解决问题。Warden-Auth-Proxy 即 K8s 集群的认证代理，它对外提供了类似 <code>kubectl proxy</code> 的代理能力。不同的是，它会解析 request 中的 Bearer Token 为 UserInfo，然后使用 K8s 的 <a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/#user-impersonation>impersonation 能力</a>进行用户伪装。</p><p>值得一提的是，Auth-Proxy 模块之所以集成在作为 Cluster Agent 的 Warden 中，而不是集成在管控集群的 KubeCube 中，是因为在设计上希望做到两点：</p><ol><li>对于各个集群的请求能够就近访问本集群的代理服务，而不是跨集群访问 KubeCube 中的代理服务。</li><li>即使当 KubeCube 发生 Crash 的时候，各个集群的认证鉴权能力依然能够保持正常。</li></ol><p>Auth-Proxy 的原理并不复杂，但是在实现中，需要注意以下几个问题：</p><h3 id=1-kubectl-exec-命令代理协议问题>1. kubectl exec 命令代理协议问题</h3><p>对于代理 <code>kubectl exec</code> 的场景，使用普通的 HTTP 代理并不可行，究其原因是因为通信协议不匹配。</p><p>不同于其他的 HTTP RESTful 请求，<code>kubectl exec</code> 命令实际是使用的 <a href=https://en.wikipedia.org/wiki/SPDY>SPDY 协议</a>，SPDY 协议是 google 开发的 TCP 会话层协议, SPDY 协议中将 HTTP 的 request/response 称为 Stream，并支持 TCP 的链接复用，同时多个 stream之间通过 stream-id 来进行标记，简单来说就是支持在单个链接同时进行多个请求响应的处理，并且互不影响 。</p><p>在代理 <code>kubectl exec</code> 请求时，需要 Upgrade HTTP 协议，即通过 101(switching protocal) 状态码切换至 SPDY 协议来继续与下游服务通信。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>UpgradeAwareHandler</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>ServeHTTP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResponseWriter</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>req</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Request</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 尝试协议 upgrade
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tryUpgrade</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>req</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpgradeRequired</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Responder</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>req</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errors</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewBadRequest</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Upgrade request required&#34;</span><span style=color:#000;font-weight:700>))</span>
		<span style=color:#204a87;font-weight:700>return</span>
	<span style=color:#000;font-weight:700>}</span>

  <span style=color:#ce5c00;font-weight:700>...</span>

  <span style=color:#8f5902;font-style:italic>// 构建 golang 经典的 ReverseProxy
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>httputil</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewSingleHostReverseProxy</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>url</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>URL</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Host</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Host</span><span style=color:#000;font-weight:700>})</span>
	<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Transport</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Transport</span>
	<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FlushInterval</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FlushInterval</span>
	<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrorLog</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>noSuppressPanicError</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LstdFlags</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Responder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrorHandler</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Responder</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServeHTTP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>newReq</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=2-kubeconfig-配置问题>2. kubeconfig 配置问题</h3><p>对于使用 kubeconfig 与集群通信的场景，默认的 kubeconfig 中的 <code>cluster server</code> 的地址往往直接指向 kube-apiserver，这使得用户与集群的通信没有经过 Warden-Auth-Proxy 代理。</p><p>因此，对于上述场景，我们需要在 kubeconfig 上做文章。KubeCube 提供下载 kubeconfig 的能力，使用当前 user 下载的 kubeconfig，包含了 user 的访问凭证，包含了该 user 所能访问的所有 cluster 的 context，user 可以自行切换 context 来对 KubeCube 纳管的集群进行访问。KubeCube 通过改写 kubeconfig 中的 kube-apiserver 地址为 Warden-Auth-Proxy 地址来使得用户通过该 kubeconfig 执行的 kubectl 或 client-go 请求会被 Warden-Auth-Proxy 所代理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>clusters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>certificate-authority-data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>member_1_cluster_ca_data}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>member_1_warden_auth_proxy_addr}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>certificate-authority-data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>pivot_cluster_ca_data}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>pivot_warden_auth_proxy_addr}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>contexts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>context</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1-admin@member-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>context</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster-admin@pivot-cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>current-context</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1-admin@member-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>token</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>user_token}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>token</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>user_token}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=3-security-通信安全问题>3. security 通信安全问题</h3><p><img src=imgs/auth-proxy-security.png alt=Auth-Proxy-security></p><p>在对通信安全有较高要求的场景下，我们需要保证从 <code>Client——>Warden-Auth-Proxy——>kube-apiserver</code> 的通信链路是加密的，可靠的。我们使用以下方式加以保证：</p><ul><li>KubeCube 使用 Bearer Token 作为用户访问凭证，Invalid Bearer Token 会被 Warden-Auth-Proxy 拒绝，相当于服务端要求验证客户端身份。</li><li>应使用 TLS 对 Warden-Auth-Proxy 进行服务端身份校验，需要相应的 CA 证书，该 TLS 能力在规划中，还未支持。当前使用 <code>insecure-skip-tls-verify</code> 跳过，在后续版本中，会增加对 TLS 能力的支持。</li><li>Warden-Auth-Proxy 与 kube-apiserver 之间，通过 mTLS 进行双向加密通信，Warden-Auth-Proxy 持有 K8s 集群的 admin 证书，并以 admin 身份伪装成目标 user 与 kube-apiserver 进行通信。</li></ul><h2 id=写在最后>写在最后</h2><p>未来我们会持续提供更多功能，帮助企业简化容器化落地。也欢迎大家参与贡献，提出宝贵的建议。添加以下微信进入 KubeCube 交流群。</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=height:200px></p><p><strong>作者简介：</strong> 蔡鑫涛，网易数帆轻舟容器平台资深开发，KubeCube Committer</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4ab1727c2dc711d75ee8df94398b303f>深入解读 KubeCube 多集群管理</h1><div class="td-byline mb-4">By <b>蔡鑫涛</b> |
<time datetime=2021-10-29 class=text-muted>Friday, October 29, 2021</time></div><p><strong>为什么需要多集群？</strong></p><ul><li>生产级落地，需要经过多个环境验证，单个集群往往不能满足隔离需求</li><li>当业务规模超过了单集群的承载能力时</li><li>当企业考虑使用多云或者混合云架构时</li><li>当架构设计上考虑云容灾，异地多活等场景时</li></ul><p><strong>k8s 多集群管理现状</strong></p><p>多集群管理并不是 kubernetes 社区的一个主要目标，虽然社区提出了 mcs 的多集群 service 标准，但是这依然无法满足企业想要管理多集群的需求。如果仅仅使用 k8s 原生的能力进行多集群建设，k8s 管理者往往需要管理大量的不同 k8s 集群的配置文件，需要管理不同用户的认证以及权限信息，并且对于应用的多集群发布、运维需要大量的人工的介入，很容易出现<strong>配置管理混乱、因操作不当导致故障</strong>等问题</p><p><strong>KubeCube 多集群能力</strong></p><p>KubeCube 可以接管任意标准 Kubernetes 集群，对接管的所有 Kubernetes 集群提供统一的用户管理和基于 Kubernetes 原生 RBAC 扩展的访问控制。为提升用户管理多个Kubernetes集群的效率，KubeCube提供了在线运维工具，可以通过KubeCube这一统一入口，快速管理多集群资源：CloudShell 可以在线对各集群使用<code>kubectl</code>，WebConsole 可以在线访问各集群中的Pod</p><p>另外，考虑到混合云场景下 KubeCube 管控集群与业务集群间的网络抖动、异常等问题。我们提供了业务集群自治能力，当业务集群与KubeCube管控集群失联时，业务集群的访问控制等可正常生效，不会受到影响</p><h2 id=kubecube-的多集群模型>KubeCube 的多集群模型</h2><p><img src=imgs/kubecube多集群模型.png alt=kubecube多集群模型 style=zoom:40%></p><p>KubeCube 基于多集群模型，实现了<strong>多集群管理能力</strong>，<strong>多集群统一认证和鉴权的能力</strong>，<strong>多集群多租户管理能力</strong>以及<strong>多集群的容错能力</strong>，了解多集群模型能够帮助你更加深入地了解 KubeCube。下文会对 KubeCube 和 Warden 中的各个多集群模块的设计进行探索。</p><h2 id=kubecube-中的多集群模块>KubeCube 中的多集群模块</h2><p>KubeCube 是管控集群上的核心组件，它实现了多集群的生命周期管理，同时也作为 UI/openAPI 的操作入口。了解 KubeCube 中的多集群模块，我们需要关注以下几个 topic</p><ol><li>cluster cr 与 InternalCluster 的关系</li><li>multi-cluster-manager 如何管理 InternalCluster</li><li>cluster reconcile 的流程</li><li>scout 如何侦查计算集群的心跳</li></ol><h3 id=multi-cluster-manager----多集群管理器>Multi-Cluster-Manager &ndash; 多集群管理器</h3><p><img src=imgs/multi-cluster-mgr.png alt=MultiClusterMgr></p><p>多集群管理器本质上就是对<code>InternalCluster</code>的管理，接口中包含了操作<code>InternalCluster</code>的所需方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// MultiClustersManager access to internal cluster
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>MultiClustersManager</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// Add runtime cache in memory
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>internalCluster</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>InternalCluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span>
	<span style=color:#000>Get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>InternalCluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>Del</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span>

	<span style=color:#8f5902;font-style:italic>// FuzzyCopy return fuzzy cluster of raw
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>FuzzyCopy</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>FuzzyCluster</span>

	<span style=color:#8f5902;font-style:italic>// ScoutFor scout heartbeat for warden
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ScoutFor</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span>

	<span style=color:#8f5902;font-style:italic>// GetClient get client for cluster
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>GetClient</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>kubernetes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p><code>InternalCluster</code> 是真实<code>Cluster</code>cr 的运行时映射，<code>Cluster</code>cr 代表了被<code>KubeCube</code>纳管的集群。</p><p><code>InternalCluster</code> 包含四个字段：</p><ul><li><strong>Client</strong> 包含了沟通指定集群所需的所有 k8s client，包括<code>sig/client-go</code>中的<code>clientset</code>，<code>sig/controller-manager</code>中的<code>client.Client</code>和<code>cache.Cache</code>，以及<code>k8s.io/metric</code>中的<code>clientset</code>，通过 <code>Client</code>，我们可以以各种姿势沟通不同 k8s 集群的 k8s-apiserver，这也是实现多集群的基础</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Client</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>Cache</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>cache</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cache</span>
	<span style=color:#000>Direct</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span>
	<span style=color:#000>Metrics</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>versioned</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Interface</span>
	<span style=color:#000>ClientSet</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>kubernetes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Interface</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><ul><li><strong>Scout</strong> 为探测指定集群健康状况的侦察员，在下文会详细阐述</li><li><strong>Config</strong> 为沟通指定集群所需的<code>rest.Config</code>，由 <code>Cluster</code>cr 中的 <code>KubeConfig</code> 转化而来</li><li><strong>StopCh</strong> 是用来关闭 <code>Scout</code>对指定集群的侦查行为，以及停止与该集群相关的所有<code>informer</code>行为</li></ul><h3 id=scout----计算集群侦查员>Scout &ndash; 计算集群侦查员</h3><p><img src=imgs/scout%E5%A4%84%E7%90%86.png alt=scout处理></p><p>scout 的职责是侦查指定集群的健康状况，它对外提供 http 接口来接收来自不同集群的心跳，随后将心跳包发送到对应的 scout 的 Receiver channel 中，对内则是起了一个 goroutine 循环接收来自 Receiver channel 的心跳包，并且根据健康和超时两种情况做不同的 callback 处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// Collect will scout a specified warden of cluster
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Scout</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Collect</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Receiver</span><span style=color:#000;font-weight:700>:</span>
			<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>healthWarden</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tick</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitTimeoutSeconds</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>):</span>
			<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>illWarden</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
			<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Warn</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;scout of %v warden stopped: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>())</span>
			<span style=color:#204a87;font-weight:700>return</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=cluster-controller----集群-cr-控制器>Cluster-Controller &ndash; 集群 cr 控制器</h3><p><img src=imgs/cluster-reconcile.png alt=cluster-reconcile></p><p>Cluster 的 controller 主要负责感知 KubeCube 纳管的集群变更，并且初始化计算集群的相关设置</p><ol><li>watch 到新的 cluster cr 的 create 事件</li><li>尝试使用 cluster cr 中的元信息去沟通对应 k8s 集群的 apiserver</li><li>如果与对应的 k8s 集群建联失败，则会使该事件进入 retry 队列（详见下文的多集群容错）</li><li>与 k8s 集群建联成功后会创建对应的<code>InternalCluster</code>，并将其添加到<code>MultiClustersManager</code>管理的缓存中</li><li>向对应的集群下方 warden 的 deployment 以及一些必要的 crd 资源</li><li>创建该集群对应的 scout，并开启对该集群的侦查</li></ol><h2 id=warden-中的多集群模块>Warden 中的多集群模块</h2><p>Warden 是作为一种 cluster agent 的身份存在于每个计算集群中，它提供了计算集群与管控集群之间的资源同步能力、热插拔能力、统一鉴权的能力、资源配置管理能力、心跳上报能力等等。了解 warden 中的多集群模块，我们需要关注以下几个 topic</p><ol><li>warden 如何向管控集群上报心跳信息</li><li>warden 如何从管控集群同步资源</li></ol><h3 id=reporter----集群信息上报者>Reporter &ndash; 集群信息上报者</h3><p>Warden 的 reporter 上报者是与 KubeCube 的 scout 侦察员一一对应，遥相呼应的</p><p>Warden 需要会在启动时根据已注册的健康检查方法去检查各个模块的健康状态，等到它所依赖的各个模块都达到健康状态后，才会开始向管控集群上报心跳，如果健康检查超时，warden 将会启动失败</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// waitForReady wait all components of warden ready
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Reporter</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>waitForReady</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>checkFuncs</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>counts</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Errorf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;less 1 components to check ready&#34;</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// wait all components ready in specified time
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cancel</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitSecond</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>cancel</span><span style=color:#000;font-weight:700>()</span>

	<span style=color:#000>readyzCh</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>make</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{})</span>

	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>fn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000>checkFuncs</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>go</span> <span style=color:#000>readyzCheck</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>readyzCh</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>fn</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>()</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>readyzCh</span><span style=color:#000;font-weight:700>:</span>
			<span style=color:#000>counts</span><span style=color:#ce5c00;font-weight:700>--</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>counts</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Warden 为它自身所有的模块提供了健康检查入口，所有的会影响 warden 正常运行的模块都需要通过<code>RegisterCheckFunc</code>方法注册健康检查函数以确保 warden 的正常启动</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>checkFuncs</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>checkFunc</span>

<span style=color:#8f5902;font-style:italic>// RegisterCheckFunc should be used to register readyz check func
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>RegisterCheckFunc</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fn</span> <span style=color:#000>checkFunc</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>checkFuncs</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>checkFuncs</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>fn</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>readyzCheck</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ch</span> <span style=color:#204a87;font-weight:700>chan</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#000>checkFn</span> <span style=color:#000>checkFunc</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tick</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waitPeriod</span><span style=color:#000;font-weight:700>):</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>checkFn</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{}{}</span>
				<span style=color:#204a87;font-weight:700>return</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
			<span style=color:#204a87;font-weight:700>return</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>完成各个模块的健康检查后，warden 启动就绪，开始向管控集群上报包含集群信息的心跳，并且根据与管控集群的通信情况来触发对应的函数回掉。KubeCube 中的对应的 scout 会根据收到的上报信息做相应的处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// report do real report loop
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Reporter</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>report</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>stop</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tick</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PeriodSecond</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>):</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>do</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>illPivotCluster</span><span style=color:#000;font-weight:700>()</span>
			<span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>healPivotCluster</span><span style=color:#000;font-weight:700>()</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>stop</span><span style=color:#000;font-weight:700>:</span>
			<span style=color:#204a87;font-weight:700>return</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=sync-manager----集群资源同步器>Sync-Manager &ndash; 集群资源同步器</h3><p>Sync-Manager 实现了从管控集群同步资源到计算集群的能力，这也是实现多集群统一认证和鉴权能力的基础</p><p><img src=imgs/kubecube%E8%B5%84%E6%BA%90%E5%90%8C%E6%AD%A5.png alt=kubecube资源同步></p><h2 id=多集群容错>多集群容错</h2><p>不可否认的是，多 k8s 集群在现实情况中可能会出现跨集群通信故障，有时候是因为集群与集群之间的网络故障，有时候是某一集群的 k8s 故障，总之会造成跨集群访问不可用。就 KubeCube 而言，目前主要关心两种情况：</p><ol><li><p>KubeCube 运行时，member cluster 失联</p></li><li><p>KubeCube 启动时，member cluster 失联</p></li></ol><p>针对上述的两种情况，KubeCube 分别在 cluster-controller、scout 以及 kubecube-apiserver 的 middleware 中做出了相应的处理</p><p><strong>Cluster-Controller</strong></p><p>上文我们提到了 cluster-controller 的 reconcile 逻辑，已知当我们在初始化纳管一个集群时，我们会将通信失败的 cluster 放进 retry 队列中，并且将 cluster cr 的状态 update 为 initFailed</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>		<span style=color:#8f5902;font-style:italic>// generate internal cluster for current cluster and add
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// it to the cache of multi cluster manager
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>skip</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>multiclustermgr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddInternalCluster</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>currentCluster</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
		<span style=color:#000;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>skip</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>updateFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>clusterv1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>initFailedState</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clusterv1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterInitFailed</span>
				<span style=color:#000>reason</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %s init failed&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
				<span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>initFailedState</span>
				<span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>reason</span>
			<span style=color:#000;font-weight:700>}</span>

			<span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>utils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateStatus</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>currentCluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>updateFn</span><span style=color:#000;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;update cluster %v status failed&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>currentCluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ctrl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Result</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#000>err</span>
			<span style=color:#000;font-weight:700>}</span>

			<span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>enqueue</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>currentCluster</span><span style=color:#000;font-weight:700>)</span>

			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ctrl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Result</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#204a87;font-weight:700>nil</span>
		<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>初始化失败的集群会在一个单独的 goroutine 中进行定时重试重联操作，并将重连成功的 cluster 通过 k8s 的 GenericEvent 重新做 reconcile，同时会在重试队列中删除该重试任务。重试超时默认为 12h，重试间隔为 7s</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// try to reconnect with cluster api server, requeue if every is ok
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>go</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v init failed, keep retry background&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#8f5902;font-style:italic>// pop from retry queue when reconnected or context exceed or context canceled
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>retryQueue</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tick</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>retryInterval</span><span style=color:#000;font-weight:700>):</span>
				<span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Options</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>})</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
					<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;enqueuing cluster %v for reconciliation&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
					<span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Affected</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>event</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GenericEvent</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>return</span>
				<span style=color:#000;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
				<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v retry task stopped: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>())</span>

				<span style=color:#8f5902;font-style:italic>// retrying timeout need update status
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>// todo(weilaaa): to allow user reconnect cluster manually
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;context deadline exceeded&#34;</span> <span style=color:#000;font-weight:700>{</span>
					<span style=color:#000>updateFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>clusterv1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
						<span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clusterv1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterReconnectedFailed</span>
						<span style=color:#000>reason</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %s reconnect timeout: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>retryTimeout</span><span style=color:#000;font-weight:700>)</span>
						<span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>state</span>
						<span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>reason</span>
					<span style=color:#000;font-weight:700>}</span>
					<span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>utils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateStatus</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>updateFn</span><span style=color:#000;font-weight:700>)</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
						<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Warn</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;update cluster %v status failed: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
					<span style=color:#000;font-weight:700>}</span>
				<span style=color:#000;font-weight:700>}</span>

				<span style=color:#204a87;font-weight:700>return</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}()</span>
</code></pre></div><p>当然，当用户主动删除该 cluster cr 时，controller 会调用 context 的 cancel 方法停止该 cluster 的重试任务，并将其从重试队列中删除。未来会支持用户手动触发重试重连的能力</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#8f5902;font-style:italic>// stop retry task if cluster in retry queue
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>cancel</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>retryQueue</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Load</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>cancel</span><span style=color:#000;font-weight:700>.(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CancelFunc</span><span style=color:#000;font-weight:700>)()</span>
		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Debug</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;stop retry task of cluster %v success&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
	<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p><strong>Scout</strong></p><p>Scout 作为计算集群的侦察员，当它感知到 member cluster 失联时，它会更新对应的 cluster cr 的 status 为 clusterAbnormal，并且告知 multiClusterManger 该集群的异常状态</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>isDisconnected</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitTimeoutSeconds</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// going here means cluster heartbeat is normal
</span><span style=color:#8f5902;font-style:italic></span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v connected&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#000;font-weight:700>}</span>

		<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span>
		<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span>
		<span style=color:#204a87;font-weight:700>return</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>reason</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %s disconnected&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#000>updateFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterAbnormal</span>
			<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>state</span>
			<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>reason</span>
			<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span><span style=color:#000;font-weight:700>}</span>
		<span style=color:#000;font-weight:700>}</span>

		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Warn</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;%v, last heartbeat: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>reason</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>utils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateStatus</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>updateFn</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterAbnormal</span>
</code></pre></div><p>当 Scout 感知到 member cluster 重新上报心跳，恢复连接时，它会更新对应 cluster cr 的 status 为 normal，并告知 multiClusterManger 该集群恢复正常</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v connected&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>()</span>

	<span style=color:#000>updateFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span>
		<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>state</span>
		<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;receive heartbeat from cluster %s&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span><span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>utils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateStatus</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>updateFn</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
		<span style=color:#204a87;font-weight:700>return</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span>
</code></pre></div><p><strong>KubeCube-Apiserver-Middlewares</strong></p><p>作为一个 http server 的预处理函数，它提供了集群状态预检的能力。当你想要通过 KubeCube 访问某一集群的资源时，它会向 multiClusterManager 询问该集群的状态，如果对应集群不健康，它会做快速失败</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// PreCheck do cluster health check, early return
</span><span style=color:#8f5902;font-style:italic>// if cluster if unhealthy
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>PreCheck</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>gin</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HandlerFunc</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>gin</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fetchCluster</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Debug</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;request path: %v, request cluster: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FullPath</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>multicluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Interface</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Warn</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v unhealthy, err: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
				<span style=color:#000>response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FailReturn</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errcode</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CustomReturn</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StatusInternalServerError</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;cluster %v unhealthy&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>))</span>
				<span style=color:#204a87;font-weight:700>return</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=多集群统一的认证和鉴权能力>多集群统一的认证和鉴权能力</h2><p>KubeCube 的认证和鉴权能力是基于 k8s 原生的 rbac 之上的，不同的是 KubeCube 在此之上做了多集群统一认证和鉴权能力的拓展。</p><p><img src=imgs/kubecub%E7%BB%9F%E4%B8%80%E9%89%B4%E6%9D%83.png alt="kubecub 统一鉴权"></p><p><strong>权限规则同步</strong></p><p>要做到同一个用户在不同集群中有同样的认证和鉴权结果，即需要保证不同集群间的权限规则相同</p><ol><li>新建用户时，KubeCube 会为其创建对应的 user cr，也就是 roleBinding 中的 subject 主体</li><li>集群管理员为新用户分配角色时，KubeCube 会为该 user 创建对应的 rbac 规则</li><li>Warden 的资源同步管理器会将 user cr 以及 rbac 规则从管控集群同步到计算集群</li></ol><p><strong>用户访问</strong></p><p>KubeCube 支持灵活的用户访问方式，包括通过 KubeCube 的前端访问 k8s，通过 kubectl 访问 k8s 以及直接使用 rest-ful 的方式访问 k8s，本质都是使用 user 对应的 token 去访问 k8s</p><ol><li><p>KubeCube 会为每一个 user 生成复合 jwt 标准的 token，用户可以获取由此生成的 KubeConfig，前端凭借此 token 与 KubeCube 交互</p></li><li><p>携带 token 去请求 k8s-apiserver 时，k8s-apiserver 会根据我们事先在它的启动参数中配置的<code>authentication-token-webhook-config-file: "/etc/cube/warden/webhook.config"</code>参数去访问 warden 的 authR webhook api，并获取认证结果，比如持有 vela 的 token:xxxx，去访问 warden 的认证服务后，得到 vela 这个 user</p></li><li><p>然后 k8s-apiserver 通过 vela user，以及与之匹配的 rbac 规则作为鉴权</p><blockquote><p>从架构上看，即使 KubeCube 遭遇故障，只有 warden 正常运行，用户依然可以通过 kubectl 和 rest-ful 的方式，通过统一的 k8s 认证和鉴权去访问对应的 k8s 资源</p></blockquote></li></ol><h2 id=总结>总结</h2><p>KubeCube 的多集群模型实现依靠的是 KubeCube 和 Warden 的相辅相成，在使用上提供了多集群统一的认证、鉴权以及多租户管理能力，在故障处理上提供了多集群容错以及单集群自治的能力。</p><h2 id=写在最后>写在最后</h2><p>未来我们会持续提供更多功能，帮助企业简化容器化落地。也欢迎大家的宝贵建议，添加以下微信进入KubeCube交流群。</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=height:200px></p><p><strong>作者简介：</strong> 蔡鑫涛，网易数帆轻舟容器平台开发，KubeCube Committer</p></div><div class=td-content style=page-break-before:always><h1 id=pg-baa4390a8c5d8984591e024686901ec7>KubeCube 多级租户模型</h1><div class="td-byline mb-4">By <b>傅思达</b> |
<time datetime=2021-09-16 class=text-muted>Thursday, September 16, 2021</time></div><h2 id=kubecube-多级租户模型>KubeCube 多级租户模型</h2><blockquote><p>KubeCube (<a href=https://kubecube.io>https://kubecube.io</a>) 是由网易数帆近期开源的一个轻量化的企业级容器平台，为企业提供 kubernetes 资源可视化管理以及统一的多集群多租户管理功能。KubeCube 社区将通过系列技术文章解读 KubeCube 的设计特点和技术实现，帮助开发者和用户更快地理解和上手 KubeCube。本文是第二篇，深度解读 KubeCube 的多级租户模型设计。</p></blockquote><p><img src=imgs/logo+kubecube.png alt=img></p><h3 id=背景>背景</h3><p>在我们跟企业交流时，发现不同企业虽然规模不一样，但选择进⾏容器化的初衷还是为了降本增效、很多企业会选择多个部⻔共⽤ K8s 集群或者物理资源，在共享资源的同时，希望有⾜够的隔离性。</p><p>多租户是一种软件架构技术，可以实现多个租户之间资源复用和共享基础设施，方便运营管理，有效节省开发应用成本；同时又可以实现个性化定制，每个租户的数据是隔离的。</p><p>当前大部分云供应商都提供了多租户的解决方案来实现 K8s 资源共享和隔离，以满足企业不同组织架构共享一个 K8s 基础设施的需求。我们将容器服务在以往企业落地实施过程中的经验进行了总结，去数据库化采用更轻量更原生的 CRD + Operator 机制，在传统多租户模型基础上加入了项目层级与软件管理过程相对应，形成了新的多级租户模型，适配企业组织架构和软件资源管理的规范，使得企业可以更好的建立统一的多 K8s 集群管理平台。</p><h3 id=租户模型介绍>租户模型介绍</h3><p>KubeCube 的多级租户模型通过租户和项目实现权限隔离和资源分配。一个租户表示一个组织（部门、团队），做资源隔离。一个项目通常可以表示一个完整业务应用系统，与企业的软件项目管理过程相对应，可以根据业务系统功能分解拆分多个命名空间管理应用子系统。</p><p>租户和项目都是跨集群的概念，所有租户共享多套 K8s 集群基础设施，通过权限限定和配额管理保证必要的隔离，防止恶意操作带来的风险。</p><h3 id=多级租户模型设计>多级租户模型设计</h3><p>KubeCube 多级租户模型提供租户、项目、空间 3 层模型以满足不同规模企业的组织架构层级，从架构上看是一种<strong>层级树形结构</strong>，一个租户包含多个项目，一个项目包含多个命名空间，项目包含的命名空间可以位于不同的 K8s 集群。这里的命名空间指的是 K8s 的<code>Namespace</code>，用于实际承接业务应用的部署，是管理的最小单元。</p><p><img src=imgs/tenant-project-structure.png alt=image-20210916173931577></p><p>租户和项目在实现上是一个 CRD ，用户只需要在管控 K8s 集群上创建租户和项目的 CR，KubeCube会将租户和项目的 CR 实时同步到所有的计算 K8s 集群。运维人员可以集中式的管理所有的计算 K8s 集群，新增集群时会自动同步租户项目等基础信息，项目管理员只需要在任一 K8s 集群（包括管控和计算集群）创建命名空间即可。</p><p><img src=imgs/tenant-project-in-multicluster.png alt=image-20210916174102135></p><p><strong>租户、项目和命名空间三者之间的关联关系是通过层级命名空间实现的</strong>，每一个租户都关联一个<code>Namespace</code>，每一个项目也都关联一个<code>Namespace</code>，通过租户和项目的Manifest里<code>.spec.namespace</code>字段指定关联的<code>Namespace</code>名称。租户和项目关联的命名空间与实际承载应用的命名空间不同，它是为了解决管理员仅可以在拥有权限的租户和项目下面创建命名空间而引入的一个特殊命名空间。</p><p>为了避免供应商锁定和更好的兼容原生 K8s 能力，KubeCube 的权限模型是基于 K8s 原生的 RBAC 能力实现的，我们期望项目管理员仅可以在他拥有权限的项目下面创建命名空间。假设授权给一个项目管理员<code>ClusterRole</code>定义赋予创建<code>Namespace</code>的权限，由于<code>Namespace</code>是集群级别资源，那么他将拥有超出项目范围任意创建命名空间的权限，这与我们的期望不符合。</p><p>这里我们引入 HNC （The Hierarchical Namespace Controller）的<code>SubNamespace</code>的概念，它是命名空间级别的资源，负责自动生成和控制<code>Namespace</code>的生命周期。在 KubeCube 的设计中，租户和项目管理员都没有直接创建命名空间的权限，他们通过拥有创建<code>SubNamespace</code>的权限来间接获得创建命名空间权利。<code>SubNamespace</code>是命名空间级别的资源，通过 RBAC 限制<code>SubNamespace</code>操作权限，租户管理员只能在自己租户关联的<code>Namespace</code>下创建<code>SubNamespace</code>，项目管理员只能在自己项目关联的<code>Namespace</code>下创建<code>SubNamespace</code>，再由 HNC 控制器组件根据<code>SubNamespace</code>自动创建<code>Namespace</code>，最终实现管理员仅可以在拥有权限的租户和项目下面创建命名空间的权限。</p><p><img src=imgs/tenant-hnc.png alt=image-20210916185015532></p><p>实际使用中，用户创建租户和项目的 CR 时，KubeCube 程序会自动监听并创建相应的<code>SubeNamespace</code>，再由 HNC 控制器监听并创建<code>Namespace</code>，继而将租户和项目与命名空间关联起来。</p><p>KubeCube 租户模型采用多层级命名空间的设计除了考虑权限限定能够兼容原生 K8s 的 RBAC 外，还额外考虑到一个因素是可以放置租户级的公共配置和项目级的公共配置，如针对整个项目的统一监控配置。在必要的时候，还可以指定 HNC 控制器将父级命名空间的资源复制传递到子命名空间，如用户权限绑定<code>RoleBinding</code>配置。</p><h3 id=租户项目权限设计>租户项目权限设计</h3><p>KubeCube 多级租户模型中预设了四种角色，它们的权限由大到小分别是：</p><ul><li>平台管理员：拥有最高权限，负责管理 K8s 集群，创建租户，设定角色权限和租户配额。</li><li>租户管理员：拥有某个租户的所有权限，主要负责租户下的项目管理。</li><li>项目管理员：负责在 K8s 集群上创建命名空间，部署应用，配置监控。</li><li>项目观察员：仅拥有项目下命名空间和资源的查询权限，可以查看应用日志和监控。</li></ul><p>在实现上，四种角色是四个<code>ClusterRole</code>定义，使用<code>CluaterRoleBinding</code>可以给用户授予平台管理员权限，使用<code>RoleBinding</code>可以给用户授予受限的租户管理员、项目管理员和项目观察员权限。在层级命名空间结构中，授予一个用户租户管理员权限相当于在租户关联的命名空间及它所有下级命名空间下创建<code>RoleBinding</code>，同理授予一个用户项目管理员和项目观察员权限相当于在项目关联的命名空间及它所有下级命名空间下创建<code>RoleBinding</code>。</p><p><img src=imgs/rbac-design.png alt=image-20210906190824488></p><p>HNC 控制器组件在创建<code>Namespace</code>的时候，可以指定把<code>SubNamespace</code>所在的父命名空间的所有 <code>RoleBinding</code>信息往下复制传递。因此给用户授予租户管理员权限时只需要在指定租户关联的命名空间下创建<code>RoleBinding</code>，授权项目管理员和项目观察员权限时只需要在指定项目关联的命名空间下创建<code>RoleBinding</code>，权限绑定关系会随着命名空间的创建逐级复制下发，最终在命名空间下会拥有不同人不同角色的<code>RoleBinding</code>信息。</p><h3 id=资源配额管理设计>资源配额管理设计</h3><p>KubeCube 的配额管理主要是针对多租户共享的 K8s 基础设施集群的资源分配，平台管理员可以为每一个租户划分每一个 K8s 集群的资源使用额度，包括 CPU、内存、磁盘和GPU的配额大小。租户管理员可以继续给项目划分配额，项目管理员可以给每一个承载应用系统的命名空间划分配额。集群信息<code>Cluster</code> （CRD）里记录着整个集群的可用配额信息，租户和项目的配额信息和已分配信息存储在<code>CubeResourceQuta</code>（CRD）里，命名空间的配额信息使用 K8s 原生<code>ResourceQuota</code>。</p><p><img src=imgs/quota-mgr.png alt=image-20210916185102212></p><p>实际使用的时候，项目配额可以省略，如 KubeCube 默认集成的管理平台，平台管理员只需要给每一个租户划分每一个 K8s 集群的可用额度，项目管理员在每一个 K8s 集群上创建命名空间的时候都不能分配超出所属租户的资源额度。</p><h3 id=总结>总结</h3><p>KubeCube 多级租户模型突破传统的容器服务多租户模式，采用租户、项目和空间的三级结构，与企业组织架构和软件管理适配，实现更细粒度的资源配额管理，满足企业统一容器平台的构建需求。以多层级命名空间为基础，租户项目权限隔离兼容原生 RBAC，使得 KubeCube 多级租户模型可以更好的兼容原生 K8s 集群，完全能够在已有 K8s 集群上进行原地升级安装 KubeCube。</p><p>作者：傅思达</p><p>更多内容请访问：https://www.kubecube.io</p><p>KubeCube技术交流群：</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=height:200px></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c143c5399df70c6b147a347702ce6967>KubeCube设计实践，初学者玩好Kubernetes的正确姿势</h1><div class="td-byline mb-4">By <b>KubeCube</b> |
<time datetime=2021-08-31 class=text-muted>Tuesday, August 31, 2021</time></div><p>8月30日，KubeCube开源项目负责人祝剑锋为大家进行了一次线上分享，结合开源项目KubeCube的设计实践，梳理Kubernetes落地面临的实际问题，逐一给出如何破解Kubernetes落地难题的思路，并介绍具体的架构实现。</p><p>点击观看 <a href="https://trclive.huodongxing.com/?eid=4611817956423&roomid=367092716">视频回放</a></p><p>点击下载 <a href=./KubeCube%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5%EF%BC%9A%E5%88%9D%E5%AD%A6%E8%80%85%E7%8E%A9%E5%A5%BDKubernetes%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF.pdf>分享PPT</a></p><p>未来我们会持续提供更多功能，帮助企业简化容器化落地。也欢迎大家的宝贵建议，添加以下微信进入KubeCube交流群。</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=height:200px></p></div><div class=td-content style=page-break-before:always><h1 id=pg-62afa3b932f60499a0ebd57d10189faa>KubeCube开源：魔方六面，降阶Kubernetes落地应用</h1><div class="td-byline mb-4">By <b>祝剑锋</b> |
<time datetime=2021-08-25 class=text-muted>Wednesday, August 25, 2021</time></div><p>容器技术发展至今，各行各业对其所带来的好处，如多环境交付一致性、弹性伸缩、故障自愈等，已经达成普遍共识。这些好处的实现，依赖于当前容器编排领域的事实标准——Kubernetes平台。然而，Kubernetes的复杂性、学习曲线陡峭也是不争的事实，这对容器技术落地应用造成很大影响。</p><p>根据IDC最新发布的软件定义计算软件市场半年跟踪报告显示，容器软件市场在未来五年仍然会保持超过40%的复合增长率，但 2020 年容器基础架构软件占整体软件定义计算市场的比例仅为16.2%。容器在互联网、金融、AI 等领域已经规模落地，大批头部企业已经基于容器构建新一代企业基础设施平台，但在多数传统企业、中小型企业落地率并不高。</p><p><img src=imgs/idc-forecast.png alt=中国软件定义计算软件市场预测></p><p>这其中的原因，很大程度上是因为企业在落地容器技术时所面临的各种问题，导致落地成本较高，比如：</p><ul><li>Kubernetes学习曲线陡峭，配置复杂度高：Kubernetes是一个强大的容器编排系统，但不可否认它也是一个很复杂的分布式系统，其学习门槛高，学习曲线较长，企业需要具备较丰富的经验才能很好的使用和维护Kubernetes集群。这就需要企业付出不小的人力成本及时间成本，对很多中小型企业来说，这个成本是不容小觑的。</li><li>单Kubernetes集群无法满足企业需求，多集群管理效率低：我们接触到的不少客户在生产级容器化落地时，发现单个Kubernetes集群根本无法满足需求，典型的场景是需要开发、测试、演练、预发、生产等多种环境，线下环境需要与线上环境进行隔离，这就需要使用多个Kubernetes集群，独立操作多个Kubernetes集群的效率问题就体现出来了。</li><li>不能较小代价的获得企业落地所需的特性：企业选择Kubernetes，目标还是想利用Kubernetes实现降本、增效，因此多个部门或者同部门下多项目组共享资源是很常见的场景，但还需要不同项目保持必要的隔离性，保证租户之间公平地分配共享集群资源。并且Kubernetes专注于单集群单租户容器编排能力，虽然社区有相关的项目，但在生产级落地使用还是有较高的门槛。</li><li>监控、告警、日志等可观测方面需要建设：社区主流的监控方案是Prometheus、告警是AlertManager、日志方案较多，但使用时配置较复杂，维护难度也较高，这就提升了对运维、研发的要求，势必会影响业务研发的效率。</li><li>国产化支持：近几年国际环境的变化，让我们更进一步认识到了自主可控的重要性，企业底层环境越来越多采用国产处理器、国产操作系统，而容器化涉及的系统，并不是全部支持国产“芯”，这也成为一个影响容器化落地的因素。</li></ul><h2 id=kubecube开源>KubeCube开源</h2><p><img src=imgs/logo+kubecube.png alt="kubecube logo"></p><p>为了帮助企业加快容器化落地进程，网易数帆将沉淀多年的容器平台KubeCube开源，希望为新基建做出一份贡献，同时希望以此促进国内相关领域的创新，打造国内开放、安全、自主可控的云原生底座，关键时刻，不会被人“卡脖子”。</p><p>KubeCube (<a href=https://kubecube.io>https://kubecube.io</a>) 是一个轻量化的企业级容器平台，为企业提供kubernetes资源可视化管理以及统一的多集群多租户管理功能，具有简化应用部署、管理应用的生命周期和丰富的监控和日志审计能力。Cube有魔方之意，寓意通过KubeCube的能力组合，企业可以快速构建一个强大和功能丰富的云原生底座，并增强 DevOps 团队的能力。下面我们具体来看KubeCube这个魔方的六面，都提供了哪些能力。</p><h3 id=一键部署>一键部署</h3><p>KubeCube针对用户的使用场景提供了多种部署方式：适用于POC环境的<a href=https://www.kubecube.io/docs/installation-guide/all-in-one/>All In One部署</a>，适用于生产环境的<a href=https://www.kubecube.io/docs/installation-guide/install-on-multi-node/>多节点高可用部署</a>。仅需要一条命令即可完成 Kubernetes+KubeCube 的部署，同时提供了开箱即用的多集群管理、多租户、可观测功能。</p><p>同时考虑到企业可能已有部分能力建设，如日志平台等，KubeCube可以只部署核心服务，提供多集群多租户能力，可观测等组件可以通过热插拔的方式开启或关闭，同时通过热插拔配置完成用户已有系统对接，用户可以根据实际场景灵活选择。</p><p>通过提供Kubernetes资源可视化管理，降低用户的学习曲线，除扩展了必要的企业特性如多租户等能力，其他贴近原生，使用户的学习路线没有断层。</p><p><img src=imgs/dashboard.png alt=dashboard></p><h3 id=多kubernetes集群统一管理>多Kubernetes集群统一管理</h3><p>KubeCube可以接管任意标准Kubernetes集群，对接管的所有Kubernetes集群提供统一的用户管理和基于Kubernetes原生RBAC扩展的访问控制。为提升用户管理多个Kubernetes集群的效率，KubeCube提供了在线运维工具，可以通过KubeCube这一统一入口，快速管理多集群资源：CloudShell可以在线对各集群使用<code>kubectl</code>，WebConsole可以在线访问各集群中的Pod。</p><p>另外，考虑到混合云场景下KubeCube管控集群与业务集群间的网络抖动、异常等问题。我们提供了业务集群自治能力，当业务集群与KubeCube管控集群失联时，业务集群的访问控制等可正常生效，不会受到影响。</p><h3 id=多租户隔离>多租户隔离</h3><p>在我们跟企业交流时，发现不同企业虽然规模不一样，但选择进行容器化的初衷还是为了降本增效、很多企业会选择多个部门共用Kubernetes集群或者物理资源，在共享资源的同时，希望有足够的隔离性。</p><p>因此KubeCube基于HNC进行了部分扩展，提供租户、项目、空间3层模型，以满足不同规模企业的组织架构层级，并以此提供资源可见性隔离、配额控制等。使企业不同部门通过共享降低成本的同时，保证必要的隔离，防止恶意操作带来的风险。</p><h3 id=完全兼容原生-kubernetes-api>完全兼容原生 Kubernetes API</h3><p>KubeCube除能够通过UI管理Kubernetes资源外，还提供了OpenAPI以及Kubernetes API访问（可以使用<code>kubectl</code>、<code>client-go</code>直接访问集群），所有访问方式均通过统一的身份认证及权限访问控制。通过OpenAPI可以方便的与企业已有系统进行集成，如果企业已有部分能力建设，如使用<code>kubectl</code>的运维脚本等，都可以无缝迁移。</p><h3 id=开箱即用的可观测功能>开箱即用的可观测功能</h3><p><img src=imgs/ctrl-monitor.png alt=管控组件监控 style=zoom:30%></p><p>提供日志、监控、告警功能，提升问题定位及运维效率，可视化配置，告别复杂的配置规则。</p><p>提供多维度基础指标监控，覆盖集群、物理节点、工作负载等多种维度，提供CPU、内存、磁盘、网络、GPU等常用指标，满足日常运维需求，帮助用户快速发现、定位问题。</p><p>基于自研的日志配置分发服务，动态感知Pod变化，使日志采集对业务无侵入，同时可减少资源占用，降低成本。</p><h3 id=arm及国产化支持>ARM及国产化支持</h3><p>KubeCube支持AMD及ARM架构，同时支持目前主流的国产处理器及操作系统，如飞腾处理器、麒麟操作系统等。</p><h2 id=一图看懂kubecube>一图看懂KubeCube</h2><p>以上是KubeCube的六大特性介绍。我们在下图中更全面地总结了KubeCube的核心信息，可以帮助大家更好地了解KubeCube的能力和用途。</p><p><img src=imgs/kubecube-long-pic.jpg alt=KubeCube长图></p><h2 id=写在最后>写在最后</h2><p>未来我们会持续提供更多功能，帮助企业简化容器化落地。也欢迎大家的宝贵建议，添加以下微信进入KubeCube交流群。</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=height:200px></p><p><strong>作者简介：</strong> 祝剑锋，网易数帆轻舟容器平台负责人，KubeCube社区核心维护者，主导KubeCube容器平台的开源工作，负责网易数帆轻舟容器平台集团内大规模落地及产品化建设。具有六年Kubernetes及容器平台相关研发及大规模实践经验。</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kubecube-io/kubecube aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2024 KubeCube Project Authors All Rights Reserved</small>
<small class=ml-1><a href=http://www.apache.org/licenses/LICENSE-2.0 target=_blank rel=noopener>隐私政策</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>