<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.81.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>深入解读 KubeCube 多集群管理 | KubeCube</title><meta name=description content="开源容器平台"><meta property="og:title" content="深入解读 KubeCube 多集群管理"><meta property="og:description" content="深入解读 KubeCube 多集群管理"><meta property="og:type" content="article"><meta property="og:url" content="https://kubecube-io.github.io/blog/2021/10/29/%E6%B7%B1%E5%85%A5%E8%A7%A3%E8%AF%BB-kubecube-%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-10-29T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-15T10:50:37+08:00"><meta property="og:site_name" content="KubeCube"><meta itemprop=name content="深入解读 KubeCube 多集群管理"><meta itemprop=description content="深入解读 KubeCube 多集群管理"><meta itemprop=datePublished content="2021-10-29T00:00:00+00:00"><meta itemprop=dateModified content="2022-08-15T10:50:37+08:00"><meta itemprop=wordCount content="1162"><meta itemprop=keywords content="KubeCube,"><meta name=twitter:card content="summary"><meta name=twitter:title content="深入解读 KubeCube 多集群管理"><meta name=twitter:description content="深入解读 KubeCube 多集群管理"><link rel=preload href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css as=style><link href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="4984" height="1e3" viewBox="0 0 4984 1e3" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3551.54 432.823C3552.84 435.556 3555.59 437.298 3558.62 437.298H3658.46C3663.69 437.298 3667.45 432.277 3665.98 427.259 3634.56 319.831 3535.31 241.352 3417.7 241.352H3402.03c-142.85.0-258.65 115.801-258.65 258.648v31.352c0 142.847 115.8 258.648 258.65 258.648H3417.7c117.61.0 216.86-78.48 248.28-185.907C3667.45 599.075 3663.69 594.054 3658.46 594.054H3558.62C3555.59 594.054 3552.84 595.796 3551.54 598.529 3526.37 651.507 3472.39 688.108 3409.87 688.108 3323.29 688.108 3253.11 617.926 3253.11 531.352V5e2C3253.11 413.426 3323.29 343.243 3409.87 343.243c62.52.0 116.5 36.601 141.67 89.58z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4970.89 651.516C4972.68 646.419 4968.9 641.081 4963.5 641.081H4867.67C4865.09 641.081 4862.68 642.35 4861.21 644.474 4842.85 671.15 4813.84 688.108 4781.45 688.108 4736.6 688.108 4698.03 655.443 4685.65 609.73h288.5C4978.15 609.73 4981.51 606.719 4981.95 602.744 4982.82 594.747 4983.27 586.616 4983.27 578.378c0-116.507-90-211.621-201.820000000001-211.621-111.83.0-201.83 95.114-201.83 211.621S4669.62 790 4781.45 790C4868.6 790 4942.57 732.144 4970.89 651.516zM4781.45 468.649C4819.59 468.649 4853.14 492.229 4869.98 527.433H4692.92C4709.75 492.229 4743.3 468.649 4781.45 468.649z" fill="#333"/><path d="M3727 386C3727 381.582 3730.58 378 3735 378h86C3825.42 378 3829 381.582 3829 386V612.5C3829 654.197 3862.8 688 3904.5 688s75.5-33.803 75.5-75.5V386C3980 381.582 3983.58 378 3988 378h86C4078.42 378 4082 381.582 4082 386V770C4082 774.418 4078.42 778 4074 778h-86C3983.58 778 3980 774.418 3980 770V764.6C3954.53 780.689 3924.35 790 3892 790 3800.87 790 3727 716.127 3727 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M3072.22 651.516C3074.01 646.419 3070.22 641.081 3064.82 641.081H2968.99C2966.42 641.081 2964 642.35 2962.54 644.474 2944.17 671.15 2915.17 688.108 2882.77 688.108 2837.92 688.108 2799.35 655.443 2786.97 609.73h288.51C3079.48 609.73 3082.84 606.719 3083.27 602.744 3084.15 594.747 3084.59 586.616 3084.59 578.378c0-116.507-90-211.621-201.82-211.621s-201.82 95.114-201.82 211.621S2770.95 790 2882.77 790C2969.93 790 3043.9 732.144 3072.22 651.516zM2882.77 468.649C2920.92 468.649 2954.47 492.229 2971.3 527.433H2794.24C2811.07 492.229 2844.62 468.649 2882.77 468.649z" fill="#333"/><path d="M1342 770.243C1342 774.661 1345.58 778.243 1350 778.243H1435.89c4.41999999999985.0 8-3.58200000000011 8-8V592.206L1495.37 540.725l196.9 234.656C1693.79 777.193 1696.04 778.239 1698.4 778.239h112.12C1817.32 778.239 1821.02 770.302 1816.65 765.096L1567.7 468.401l244.74-244.744C1817.48 218.617 1813.91 210 1806.78 210H1685.31C1683.19 210 1681.16 210.843 1679.66 212.343L1443.89 448.109V218C1443.89 213.582 1440.31 210 1435.89 210H1350C1345.58 210 1342 213.582 1342 218V770.243z" fill="#333"/><path d="M1828 386C1828 381.582 1831.58 378 1836 378h86C1926.42 378 1930 381.582 1930 386V612.5c0 41.697 33.8 75.5 75.5 75.5s75.5-33.803 75.5-75.5V386C2081 381.582 2084.58 378 2089 378h86C2179.42 378 2183 381.582 2183 386V770C2183 774.418 2179.42 778 2175 778h-86C2084.58 778 2081 774.418 2081 770V764.6C2055.53 780.689 2025.35 790 1993 790 1901.87 790 1828 716.127 1828 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M2254 210C2249.58 210 2246 213.582 2246 218V770C2246 774.418 2249.58 778 2254 778h86C2344.42 778 2348 774.418 2348 770V757.487C2378.39 778.082 2414.4 790 2453 790c108.8.0 197-94.692 197-211.5S2561.8 367 2453 367C2414.4 367 2378.39 378.918 2348 399.513V218C2348 213.582 2344.42 210 2340 210h-86zm94 368.5c0 60.475 44.77 109.5 1e2 109.5s1e2-49.025 1e2-109.5S2503.23 469 2448 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4153 210C4148.58 210 4145 213.582 4145 218V770C4145 774.418 4148.58 778 4153 778h86C4243.42 778 4247 774.418 4247 770V757.487C4277.39 778.082 4313.4 790 4352 790c108.8.0 197-94.692 197-211.5S4460.8 367 4352 367C4313.4 367 4277.39 378.918 4247 399.513V218C4247 213.582 4243.42 210 4239 210h-86zm94 368.5C4247 638.975 4291.77 688 4347 688s1e2-49.025 1e2-109.5S4402.23 469 4347 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path d="M554.586 39C564.593 21.6667 552.084.0 532.069.0H346.41c-35.726.0-68.739 19.0599-86.602 50L28.8676 450C11.0043 480.94 11.0042 519.06 28.8675 550L259.808 950C277.671 980.94 310.684 1e3 346.41 1e3H447.276C456.208 1e3 464.461 995.235 468.927 987.5L612.399 739C622.406 721.667 609.897 7e2 589.882 7e2H427.239C412.949 7e2 399.743 692.376 392.598 680L300.222 520C293.077 507.624 293.077 492.376 300.222 480l85.964-148.894L386 330.999 554.586 39z" fill="#0056ff"/><path d="M564.401 3e2C544.386 3e2 531.877 278.333 541.884 261L685.356 12.5C689.822 4.76496 698.075.0 707.006.0H808.29C844.017.0 877.03 19.06 894.893 50.0001L1125.83 450C1143.7 480.94 1143.7 519.06 1125.83 550L894.893 950C877.03 980.94 844.017 1e3 808.29 1e3H622.214C602.199 1e3 589.69 978.333 599.697 961L750.385 7e2H750.555L854.478 520C861.624 507.624 861.624 492.376 854.478 480L762.102 320C754.957 307.624 741.752 3e2 727.461 3e2H564.401z" fill="#0056ff"/></svg></span><span class="text-uppercase font-weight-bold">KubeCube</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/kubecube-io/kubecube target=_blank><i class="fab fa-github"></i><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.d5a631f6a2fe4c00c21a0bc429b81434.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.d5a631f6a2fe4c00c21a0bc429b81434.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>博客</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-li><input type=checkbox id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-check>
<label for=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-check><a href=/blog/2023/04/10/kubecube-v1.8-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883><span>KubeCube v1.8 版本发布</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-li><input type=checkbox id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-check>
<label for=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-check><a href=/blog/2022/09/13/kubecube-%E7%89%88%E6%9C%AC%E8%BD%AC%E6%8D%A2%E5%A4%A7%E5%B9%85%E6%8F%90%E5%8D%87k8s%E7%89%88%E6%9C%AC%E9%80%82%E9%85%8D%E8%83%BD%E5%8A%9B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b><span>KubeCube 版本转换：大幅提升K8s版本适配能力</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-li><input type=checkbox id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-check>
<label for=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-check><a href=/blog/2021/12/24/kubecube-v1.1-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883><span>KubeCube v1.1 版本发布</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-li><input type=checkbox id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-check checked>
<label for=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-check><a href=/blog/2021/10/29/%E6%B7%B1%E5%85%A5%E8%A7%A3%E8%AF%BB-kubecube-%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086><span class=td-sidebar-nav-active-item>深入解读 KubeCube 多集群管理</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-li><input type=checkbox id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-check>
<label for=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-check><a href=/blog/2021/09/16/kubecube-%E5%A4%9A%E7%BA%A7%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%9E%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b><span>KubeCube 多级租户模型</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-li><input type=checkbox id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-check>
<label for=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-check><a href=/blog/2021/08/31/kubecube%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5%E5%88%9D%E5%AD%A6%E8%80%85%E7%8E%A9%E5%A5%BDkubernetes%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf><span>KubeCube设计实践，初学者玩好Kubernetes的正确姿势</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-li><input type=checkbox id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-check>
<label for=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-check><a href=/blog/2021/08/25/kubecube%E5%BC%80%E6%BA%90%E9%AD%94%E6%96%B9%E5%85%AD%E9%9D%A2%E9%99%8D%E9%98%B6kubernetes%E8%90%BD%E5%9C%B0%E5%BA%94%E7%94%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8><span>KubeCube开源：魔方六面，降阶Kubernetes落地应用</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/kubecube-io/kubecube-io.github.io/edit/main/content/zh/blog/multi-cluster/index.md target=_blank><i class="fa fa-edit fa-fw"></i>编辑此页</a>
<a href="https://github.com/kubecube-io/kubecube-io.github.io/new/main/content/zh/blog/multi-cluster/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i>添加子页面</a>
<a href="https://github.com/kubecube-io/kubecube-io.github.io/issues/new?title=%e6%b7%b1%e5%85%a5%e8%a7%a3%e8%af%bb%20KubeCube%20%e5%a4%9a%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86" target=_blank><i class="fab fa-github fa-fw"></i>提交文档问题</a>
<a href=https://github.com/kubecube-io/kubecube/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>提交项目问题</a>
<a id=print href=https://kubecube-io.github.io/blog/_print/><i class="fa fa-print fa-fw"></i>整节打印</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#kubecube-的多集群模型>KubeCube 的多集群模型</a></li><li><a href=#kubecube-中的多集群模块>KubeCube 中的多集群模块</a><ul><li><a href=#multi-cluster-manager----多集群管理器>Multi-Cluster-Manager &ndash; 多集群管理器</a></li><li><a href=#scout----计算集群侦查员>Scout &ndash; 计算集群侦查员</a></li><li><a href=#cluster-controller----集群-cr-控制器>Cluster-Controller &ndash; 集群 cr 控制器</a></li></ul></li><li><a href=#warden-中的多集群模块>Warden 中的多集群模块</a><ul><li><a href=#reporter----集群信息上报者>Reporter &ndash; 集群信息上报者</a></li><li><a href=#sync-manager----集群资源同步器>Sync-Manager &ndash; 集群资源同步器</a></li></ul></li><li><a href=#多集群容错>多集群容错</a></li><li><a href=#多集群统一的认证和鉴权能力>多集群统一的认证和鉴权能力</a></li><li><a href=#总结>总结</a></li><li><a href=#写在最后>写在最后</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>深入解读 KubeCube 多集群管理</h1><div class="td-byline mb-4">By <b>蔡鑫涛</b> |
<time datetime=2021-10-29 class=text-muted>Friday, October 29, 2021</time></div><header class=article-meta></header><p><strong>为什么需要多集群？</strong></p><ul><li>生产级落地，需要经过多个环境验证，单个集群往往不能满足隔离需求</li><li>当业务规模超过了单集群的承载能力时</li><li>当企业考虑使用多云或者混合云架构时</li><li>当架构设计上考虑云容灾，异地多活等场景时</li></ul><p><strong>k8s 多集群管理现状</strong></p><p>多集群管理并不是 kubernetes 社区的一个主要目标，虽然社区提出了 mcs 的多集群 service 标准，但是这依然无法满足企业想要管理多集群的需求。如果仅仅使用 k8s 原生的能力进行多集群建设，k8s 管理者往往需要管理大量的不同 k8s 集群的配置文件，需要管理不同用户的认证以及权限信息，并且对于应用的多集群发布、运维需要大量的人工的介入，很容易出现<strong>配置管理混乱、因操作不当导致故障</strong>等问题</p><p><strong>KubeCube 多集群能力</strong></p><p>KubeCube 可以接管任意标准 Kubernetes 集群，对接管的所有 Kubernetes 集群提供统一的用户管理和基于 Kubernetes 原生 RBAC 扩展的访问控制。为提升用户管理多个Kubernetes集群的效率，KubeCube提供了在线运维工具，可以通过KubeCube这一统一入口，快速管理多集群资源：CloudShell 可以在线对各集群使用<code>kubectl</code>，WebConsole 可以在线访问各集群中的Pod</p><p>另外，考虑到混合云场景下 KubeCube 管控集群与业务集群间的网络抖动、异常等问题。我们提供了业务集群自治能力，当业务集群与KubeCube管控集群失联时，业务集群的访问控制等可正常生效，不会受到影响</p><h2 id=kubecube-的多集群模型>KubeCube 的多集群模型</h2><p><img src=imgs/kubecube多集群模型.png alt=kubecube多集群模型 style=zoom:40%></p><p>KubeCube 基于多集群模型，实现了<strong>多集群管理能力</strong>，<strong>多集群统一认证和鉴权的能力</strong>，<strong>多集群多租户管理能力</strong>以及<strong>多集群的容错能力</strong>，了解多集群模型能够帮助你更加深入地了解 KubeCube。下文会对 KubeCube 和 Warden 中的各个多集群模块的设计进行探索。</p><h2 id=kubecube-中的多集群模块>KubeCube 中的多集群模块</h2><p>KubeCube 是管控集群上的核心组件，它实现了多集群的生命周期管理，同时也作为 UI/openAPI 的操作入口。了解 KubeCube 中的多集群模块，我们需要关注以下几个 topic</p><ol><li>cluster cr 与 InternalCluster 的关系</li><li>multi-cluster-manager 如何管理 InternalCluster</li><li>cluster reconcile 的流程</li><li>scout 如何侦查计算集群的心跳</li></ol><h3 id=multi-cluster-manager----多集群管理器>Multi-Cluster-Manager &ndash; 多集群管理器</h3><p><img src=imgs/multi-cluster-mgr.png alt=MultiClusterMgr></p><p>多集群管理器本质上就是对<code>InternalCluster</code>的管理，接口中包含了操作<code>InternalCluster</code>的所需方法</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// MultiClustersManager access to internal cluster
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>MultiClustersManager</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#8f5902;font-style:italic>// Add runtime cache in memory
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>Add</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>internalCluster</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>InternalCluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span>
	<span style=color:#000>Get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>InternalCluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000>Del</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span>

	<span style=color:#8f5902;font-style:italic>// FuzzyCopy return fuzzy cluster of raw
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>FuzzyCopy</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>map</span><span style=color:#000;font-weight:700>[</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>]</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>FuzzyCluster</span>

	<span style=color:#8f5902;font-style:italic>// ScoutFor scout heartbeat for warden
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ScoutFor</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#204a87;font-weight:700>error</span>

	<span style=color:#8f5902;font-style:italic>// GetClient get client for cluster
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>GetClient</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>kubernetes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#204a87;font-weight:700>error</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p><code>InternalCluster</code> 是真实<code>Cluster</code>cr 的运行时映射，<code>Cluster</code>cr 代表了被<code>KubeCube</code>纳管的集群。</p><p><code>InternalCluster</code> 包含四个字段：</p><ul><li><strong>Client</strong> 包含了沟通指定集群所需的所有 k8s client，包括<code>sig/client-go</code>中的<code>clientset</code>，<code>sig/controller-manager</code>中的<code>client.Client</code>和<code>cache.Cache</code>，以及<code>k8s.io/metric</code>中的<code>clientset</code>，通过 <code>Client</code>，我们可以以各种姿势沟通不同 k8s 集群的 k8s-apiserver，这也是实现多集群的基础</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>type</span> <span style=color:#000>Client</span> <span style=color:#204a87;font-weight:700>interface</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>Cache</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>cache</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cache</span>
	<span style=color:#000>Direct</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span>
	<span style=color:#000>Metrics</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>versioned</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Interface</span>
	<span style=color:#000>ClientSet</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>kubernetes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Interface</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><ul><li><strong>Scout</strong> 为探测指定集群健康状况的侦察员，在下文会详细阐述</li><li><strong>Config</strong> 为沟通指定集群所需的<code>rest.Config</code>，由 <code>Cluster</code>cr 中的 <code>KubeConfig</code> 转化而来</li><li><strong>StopCh</strong> 是用来关闭 <code>Scout</code>对指定集群的侦查行为，以及停止与该集群相关的所有<code>informer</code>行为</li></ul><h3 id=scout----计算集群侦查员>Scout &ndash; 计算集群侦查员</h3><p><img src=imgs/scout%E5%A4%84%E7%90%86.png alt=scout处理></p><p>scout 的职责是侦查指定集群的健康状况，它对外提供 http 接口来接收来自不同集群的心跳，随后将心跳包发送到对应的 scout 的 Receiver channel 中，对内则是起了一个 goroutine 循环接收来自 Receiver channel 的心跳包，并且根据健康和超时两种情况做不同的 callback 处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#8f5902;font-style:italic>// Collect will scout a specified warden of cluster
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Scout</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>Collect</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#000>info</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Receiver</span><span style=color:#000;font-weight:700>:</span>
			<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>healthWarden</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>info</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tick</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitTimeoutSeconds</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>):</span>
			<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>illWarden</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
			<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Warn</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;scout of %v warden stopped: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>())</span>
			<span style=color:#204a87;font-weight:700>return</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=cluster-controller----集群-cr-控制器>Cluster-Controller &ndash; 集群 cr 控制器</h3><p><img src=imgs/cluster-reconcile.png alt=cluster-reconcile></p><p>Cluster 的 controller 主要负责感知 KubeCube 纳管的集群变更，并且初始化计算集群的相关设置</p><ol><li>watch 到新的 cluster cr 的 create 事件</li><li>尝试使用 cluster cr 中的元信息去沟通对应 k8s 集群的 apiserver</li><li>如果与对应的 k8s 集群建联失败，则会使该事件进入 retry 队列（详见下文的多集群容错）</li><li>与 k8s 集群建联成功后会创建对应的<code>InternalCluster</code>，并将其添加到<code>MultiClustersManager</code>管理的缓存中</li><li>向对应的集群下方 warden 的 deployment 以及一些必要的 crd 资源</li><li>创建该集群对应的 scout，并开启对该集群的侦查</li></ol><h2 id=warden-中的多集群模块>Warden 中的多集群模块</h2><p>Warden 是作为一种 cluster agent 的身份存在于每个计算集群中，它提供了计算集群与管控集群之间的资源同步能力、热插拔能力、统一鉴权的能力、资源配置管理能力、心跳上报能力等等。了解 warden 中的多集群模块，我们需要关注以下几个 topic</p><ol><li>warden 如何向管控集群上报心跳信息</li><li>warden 如何从管控集群同步资源</li></ol><h3 id=reporter----集群信息上报者>Reporter &ndash; 集群信息上报者</h3><p>Warden 的 reporter 上报者是与 KubeCube 的 scout 侦察员一一对应，遥相呼应的</p><p>Warden 需要会在启动时根据已注册的健康检查方法去检查各个模块的健康状态，等到它所依赖的各个模块都达到健康状态后，才会开始向管控集群上报心跳，如果健康检查超时，warden 将会启动失败</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// waitForReady wait all components of warden ready
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Reporter</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>waitForReady</span><span style=color:#000;font-weight:700>()</span> <span style=color:#204a87;font-weight:700>error</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>counts</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>checkFuncs</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>counts</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Errorf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;less 1 components to check ready&#34;</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#8f5902;font-style:italic>// wait all components ready in specified time
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cancel</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitSecond</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>cancel</span><span style=color:#000;font-weight:700>()</span>

	<span style=color:#000>readyzCh</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87>make</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{})</span>

	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>fn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000>checkFuncs</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>go</span> <span style=color:#000>readyzCheck</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>readyzCh</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>fn</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>()</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>readyzCh</span><span style=color:#000;font-weight:700>:</span>
			<span style=color:#000>counts</span><span style=color:#ce5c00;font-weight:700>--</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>counts</span> <span style=color:#000;font-weight:700>&lt;</span> <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>Warden 为它自身所有的模块提供了健康检查入口，所有的会影响 warden 正常运行的模块都需要通过<code>RegisterCheckFunc</code>方法注册健康检查函数以确保 warden 的正常启动</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=color:#204a87;font-weight:700>var</span> <span style=color:#000>checkFuncs</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#000>checkFunc</span>

<span style=color:#8f5902;font-style:italic>// RegisterCheckFunc should be used to register readyz check func
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>RegisterCheckFunc</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>fn</span> <span style=color:#000>checkFunc</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#000>checkFuncs</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87>append</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>checkFuncs</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>fn</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>

<span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>readyzCheck</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ch</span> <span style=color:#204a87;font-weight:700>chan</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#000>checkFn</span> <span style=color:#000>checkFunc</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tick</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>waitPeriod</span><span style=color:#000;font-weight:700>):</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>checkFn</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>ch</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{}{}</span>
				<span style=color:#204a87;font-weight:700>return</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
			<span style=color:#204a87;font-weight:700>return</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>完成各个模块的健康检查后，warden 启动就绪，开始向管控集群上报包含集群信息的心跳，并且根据与管控集群的通信情况来触发对应的函数回掉。KubeCube 中的对应的 scout 会根据收到的上报信息做相应的处理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// report do real report loop
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>Reporter</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>report</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>stop</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#204a87;font-weight:700>chan</span> <span style=color:#204a87;font-weight:700>struct</span><span style=color:#000;font-weight:700>{})</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tick</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Duration</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>PeriodSecond</span><span style=color:#000;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>):</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>do</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>illPivotCluster</span><span style=color:#000;font-weight:700>()</span>
			<span style=color:#000;font-weight:700>}</span> <span style=color:#204a87;font-weight:700>else</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>healPivotCluster</span><span style=color:#000;font-weight:700>()</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>stop</span><span style=color:#000;font-weight:700>:</span>
			<span style=color:#204a87;font-weight:700>return</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=sync-manager----集群资源同步器>Sync-Manager &ndash; 集群资源同步器</h3><p>Sync-Manager 实现了从管控集群同步资源到计算集群的能力，这也是实现多集群统一认证和鉴权能力的基础</p><p><img src=imgs/kubecube%E8%B5%84%E6%BA%90%E5%90%8C%E6%AD%A5.png alt=kubecube资源同步></p><h2 id=多集群容错>多集群容错</h2><p>不可否认的是，多 k8s 集群在现实情况中可能会出现跨集群通信故障，有时候是因为集群与集群之间的网络故障，有时候是某一集群的 k8s 故障，总之会造成跨集群访问不可用。就 KubeCube 而言，目前主要关心两种情况：</p><ol><li><p>KubeCube 运行时，member cluster 失联</p></li><li><p>KubeCube 启动时，member cluster 失联</p></li></ol><p>针对上述的两种情况，KubeCube 分别在 cluster-controller、scout 以及 kubecube-apiserver 的 middleware 中做出了相应的处理</p><p><strong>Cluster-Controller</strong></p><p>上文我们提到了 cluster-controller 的 reconcile 逻辑，已知当我们在初始化纳管一个集群时，我们会将通信失败的 cluster 放进 retry 队列中，并且将 cluster cr 的状态 update 为 initFailed</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>		<span style=color:#8f5902;font-style:italic>// generate internal cluster for current cluster and add
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#8f5902;font-style:italic>// it to the cache of multi cluster manager
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#000>skip</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>multiclustermgr</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddInternalCluster</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>currentCluster</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
		<span style=color:#000;font-weight:700>}</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>skip</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>updateFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>clusterv1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>initFailedState</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clusterv1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterInitFailed</span>
				<span style=color:#000>reason</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %s init failed&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
				<span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>initFailedState</span>
				<span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>reason</span>
			<span style=color:#000;font-weight:700>}</span>

			<span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>utils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateStatus</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>currentCluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>updateFn</span><span style=color:#000;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;update cluster %v status failed&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>currentCluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
				<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ctrl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Result</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#000>err</span>
			<span style=color:#000;font-weight:700>}</span>

			<span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>enqueue</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>currentCluster</span><span style=color:#000;font-weight:700>)</span>

			<span style=color:#204a87;font-weight:700>return</span> <span style=color:#000>ctrl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Result</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#204a87;font-weight:700>nil</span>
		<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p>初始化失败的集群会在一个单独的 goroutine 中进行定时重试重联操作，并将重连成功的 cluster 通过 k8s 的 GenericEvent 重新做 reconcile，同时会在重试队列中删除该重试任务。重试超时默认为 12h，重试间隔为 7s</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// try to reconnect with cluster api server, requeue if every is ok
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#204a87;font-weight:700>go</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v init failed, keep retry background&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#8f5902;font-style:italic>// pop from retry queue when reconnected or context exceed or context canceled
</span><span style=color:#8f5902;font-style:italic></span>		<span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>retryQueue</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Delete</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#204a87;font-weight:700>for</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>select</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Tick</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>retryInterval</span><span style=color:#000;font-weight:700>):</span>
				<span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>config</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Options</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>})</span>
				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
					<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;enqueuing cluster %v for reconciliation&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
					<span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Affected</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span> <span style=color:#000>event</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>GenericEvent</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Object</span><span style=color:#000;font-weight:700>:</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>}</span>
					<span style=color:#204a87;font-weight:700>return</span>
				<span style=color:#000;font-weight:700>}</span>
			<span style=color:#204a87;font-weight:700>case</span> <span style=color:#ce5c00;font-weight:700>&lt;-</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Done</span><span style=color:#000;font-weight:700>():</span>
				<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v retry task stopped: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>())</span>

				<span style=color:#8f5902;font-style:italic>// retrying timeout need update status
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#8f5902;font-style:italic>// todo(weilaaa): to allow user reconnect cluster manually
</span><span style=color:#8f5902;font-style:italic></span>				<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>ctx</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Err</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;context deadline exceeded&#34;</span> <span style=color:#000;font-weight:700>{</span>
					<span style=color:#000>updateFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>clusterv1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
						<span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clusterv1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterReconnectedFailed</span>
						<span style=color:#000>reason</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %s reconnect timeout: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>retryTimeout</span><span style=color:#000;font-weight:700>)</span>
						<span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>state</span>
						<span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>reason</span>
					<span style=color:#000;font-weight:700>}</span>
					<span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>utils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateStatus</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>updateFn</span><span style=color:#000;font-weight:700>)</span>
					<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
						<span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Warn</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;update cluster %v status failed: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
					<span style=color:#000;font-weight:700>}</span>
				<span style=color:#000;font-weight:700>}</span>

				<span style=color:#204a87;font-weight:700>return</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}()</span>
</code></pre></div><p>当然，当用户主动删除该 cluster cr 时，controller 会调用 context 的 cancel 方法停止该 cluster 的重试任务，并将其从重试队列中删除。未来会支持用户手动触发重试重连的能力</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#8f5902;font-style:italic>// stop retry task if cluster in retry queue
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>cancel</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>ok</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>retryQueue</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Load</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>ok</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>cancel</span><span style=color:#000;font-weight:700>.(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CancelFunc</span><span style=color:#000;font-weight:700>)()</span>
		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Debug</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;stop retry task of cluster %v success&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>nil</span>
	<span style=color:#000;font-weight:700>}</span>
</code></pre></div><p><strong>Scout</strong></p><p>Scout 作为计算集群的侦察员，当它感知到 member cluster 失联时，它会更新对应的 cluster cr 的 status 为 clusterAbnormal，并且告知 multiClusterManger 该集群的异常状态</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang>	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000;font-weight:700>!</span><span style=color:#000>isDisconnected</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WaitTimeoutSeconds</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#8f5902;font-style:italic>// going here means cluster heartbeat is normal
</span><span style=color:#8f5902;font-style:italic></span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v connected&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#000;font-weight:700>}</span>

		<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span>
		<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span>
		<span style=color:#204a87;font-weight:700>return</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>reason</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %s disconnected&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#000>updateFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterAbnormal</span>
			<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>state</span>
			<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>reason</span>
			<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span><span style=color:#000;font-weight:700>}</span>
		<span style=color:#000;font-weight:700>}</span>

		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Warn</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;%v, last heartbeat: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>reason</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>utils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateStatus</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>updateFn</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterAbnormal</span>
</code></pre></div><p>当 Scout 感知到 member cluster 重新上报心跳，恢复连接时，它会更新对应 cluster cr 的 status 为 normal，并告知 multiClusterManger 该集群恢复正常</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Info</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v connected&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Name</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Now</span><span style=color:#000;font-weight:700>()</span>

	<span style=color:#000>updateFn</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>obj</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>state</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span>
		<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>State</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>state</span>
		<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Reason</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;receive heartbeat from cluster %s&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Cluster</span><span style=color:#000;font-weight:700>)</span>
		<span style=color:#000>obj</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Status</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>metav1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Time</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LastHeartbeat</span><span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>utils</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpdateStatus</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>updateFn</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
		<span style=color:#204a87;font-weight:700>return</span>
	<span style=color:#000;font-weight:700>}</span>

	<span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterState</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>v1</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ClusterNormal</span>
</code></pre></div><p><strong>KubeCube-Apiserver-Middlewares</strong></p><p>作为一个 http server 的预处理函数，它提供了集群状态预检的能力。当你想要通过 KubeCube 访问某一集群的资源时，它会向 multiClusterManager 询问该集群的状态，如果对应集群不健康，它会做快速失败</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#8f5902;font-style:italic>// PreCheck do cluster health check, early return
</span><span style=color:#8f5902;font-style:italic>// if cluster if unhealthy
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000>PreCheck</span><span style=color:#000;font-weight:700>()</span> <span style=color:#000>gin</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>HandlerFunc</span> <span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>return</span> <span style=color:#204a87;font-weight:700>func</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>gin</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Context</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>cluster</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>fetchCluster</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Debug</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;request path: %v, request cluster: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FullPath</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>)</span>

		<span style=color:#204a87;font-weight:700>if</span> <span style=color:#204a87>len</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>&gt;</span> <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>multicluster</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Interface</span><span style=color:#000;font-weight:700>().</span><span style=color:#000>Get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cluster</span><span style=color:#000;font-weight:700>)</span>
			<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
				<span style=color:#000>clog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Warn</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;cluster %v unhealthy, err: %v&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>())</span>
				<span style=color:#000>response</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FailReturn</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>c</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errcode</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>CustomReturn</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>StatusInternalServerError</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;cluster %v unhealthy&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cluster</span><span style=color:#000;font-weight:700>))</span>
				<span style=color:#204a87;font-weight:700>return</span>
			<span style=color:#000;font-weight:700>}</span>
		<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=多集群统一的认证和鉴权能力>多集群统一的认证和鉴权能力</h2><p>KubeCube 的认证和鉴权能力是基于 k8s 原生的 rbac 之上的，不同的是 KubeCube 在此之上做了多集群统一认证和鉴权能力的拓展。</p><p><img src=imgs/kubecub%E7%BB%9F%E4%B8%80%E9%89%B4%E6%9D%83.png alt="kubecub 统一鉴权"></p><p><strong>权限规则同步</strong></p><p>要做到同一个用户在不同集群中有同样的认证和鉴权结果，即需要保证不同集群间的权限规则相同</p><ol><li>新建用户时，KubeCube 会为其创建对应的 user cr，也就是 roleBinding 中的 subject 主体</li><li>集群管理员为新用户分配角色时，KubeCube 会为该 user 创建对应的 rbac 规则</li><li>Warden 的资源同步管理器会将 user cr 以及 rbac 规则从管控集群同步到计算集群</li></ol><p><strong>用户访问</strong></p><p>KubeCube 支持灵活的用户访问方式，包括通过 KubeCube 的前端访问 k8s，通过 kubectl 访问 k8s 以及直接使用 rest-ful 的方式访问 k8s，本质都是使用 user 对应的 token 去访问 k8s</p><ol><li><p>KubeCube 会为每一个 user 生成复合 jwt 标准的 token，用户可以获取由此生成的 KubeConfig，前端凭借此 token 与 KubeCube 交互</p></li><li><p>携带 token 去请求 k8s-apiserver 时，k8s-apiserver 会根据我们事先在它的启动参数中配置的<code>authentication-token-webhook-config-file: "/etc/cube/warden/webhook.config"</code>参数去访问 warden 的 authR webhook api，并获取认证结果，比如持有 vela 的 token:xxxx，去访问 warden 的认证服务后，得到 vela 这个 user</p></li><li><p>然后 k8s-apiserver 通过 vela user，以及与之匹配的 rbac 规则作为鉴权</p><blockquote><p>从架构上看，即使 KubeCube 遭遇故障，只有 warden 正常运行，用户依然可以通过 kubectl 和 rest-ful 的方式，通过统一的 k8s 认证和鉴权去访问对应的 k8s 资源</p></blockquote></li></ol><h2 id=总结>总结</h2><p>KubeCube 的多集群模型实现依靠的是 KubeCube 和 Warden 的相辅相成，在使用上提供了多集群统一的认证、鉴权以及多租户管理能力，在故障处理上提供了多集群容错以及单集群自治的能力。</p><h2 id=写在最后>写在最后</h2><p>未来我们会持续提供更多功能，帮助企业简化容器化落地。也欢迎大家的宝贵建议，添加以下微信进入KubeCube交流群。</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=height:200px></p><p><strong>作者简介：</strong> 蔡鑫涛，网易数帆轻舟容器平台开发，KubeCube Committer</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2021/09/16/kubecube-%E5%A4%9A%E7%BA%A7%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%9E%8B/ aria-label="上一页 - KubeCube 多级租户模型" class="btn btn-primary"><span class=mr-1>←</span> 上一页</a></li><a href=/blog/2021/12/24/kubecube-v1.1-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/ aria-label="下一页 - KubeCube v1.1 版本发布" class="btn btn-primary">下一页 <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kubecube-io/kubecube aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 KubeCube Project Authors All Rights Reserved</small>
<small class=ml-1><a href=http://www.apache.org/licenses/LICENSE-2.0 target=_blank rel=noopener>隐私政策</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>