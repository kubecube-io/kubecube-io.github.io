<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.81.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>KubeCube v1.1 版本发布 | KubeCube</title><meta name=description content="开源容器平台"><meta property="og:title" content="KubeCube v1.1 版本发布"><meta property="og:description" content="KubeCube v1.1 版本发布"><meta property="og:type" content="article"><meta property="og:url" content="https://kubecube-io.github.io/blog/2021/12/24/kubecube-v1.1-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-12-24T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-15T10:50:37+08:00"><meta property="og:site_name" content="KubeCube"><meta itemprop=name content="KubeCube v1.1 版本发布"><meta itemprop=description content="KubeCube v1.1 版本发布"><meta itemprop=datePublished content="2021-12-24T00:00:00+00:00"><meta itemprop=dateModified content="2022-08-15T10:50:37+08:00"><meta itemprop=wordCount content="322"><meta itemprop=keywords content="KubeCube,"><meta name=twitter:card content="summary"><meta name=twitter:title content="KubeCube v1.1 版本发布"><meta name=twitter:description content="KubeCube v1.1 版本发布"><link rel=preload href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css as=style><link href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="4984" height="1e3" viewBox="0 0 4984 1e3" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3551.54 432.823C3552.84 435.556 3555.59 437.298 3558.62 437.298H3658.46C3663.69 437.298 3667.45 432.277 3665.98 427.259 3634.56 319.831 3535.31 241.352 3417.7 241.352H3402.03c-142.85.0-258.65 115.801-258.65 258.648v31.352c0 142.847 115.8 258.648 258.65 258.648H3417.7c117.61.0 216.86-78.48 248.28-185.907C3667.45 599.075 3663.69 594.054 3658.46 594.054H3558.62C3555.59 594.054 3552.84 595.796 3551.54 598.529 3526.37 651.507 3472.39 688.108 3409.87 688.108 3323.29 688.108 3253.11 617.926 3253.11 531.352V5e2C3253.11 413.426 3323.29 343.243 3409.87 343.243c62.52.0 116.5 36.601 141.67 89.58z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4970.89 651.516C4972.68 646.419 4968.9 641.081 4963.5 641.081H4867.67C4865.09 641.081 4862.68 642.35 4861.21 644.474 4842.85 671.15 4813.84 688.108 4781.45 688.108 4736.6 688.108 4698.03 655.443 4685.65 609.73h288.5C4978.15 609.73 4981.51 606.719 4981.95 602.744 4982.82 594.747 4983.27 586.616 4983.27 578.378c0-116.507-90-211.621-201.820000000001-211.621-111.83.0-201.83 95.114-201.83 211.621S4669.62 790 4781.45 790C4868.6 790 4942.57 732.144 4970.89 651.516zM4781.45 468.649C4819.59 468.649 4853.14 492.229 4869.98 527.433H4692.92C4709.75 492.229 4743.3 468.649 4781.45 468.649z" fill="#333"/><path d="M3727 386C3727 381.582 3730.58 378 3735 378h86C3825.42 378 3829 381.582 3829 386V612.5C3829 654.197 3862.8 688 3904.5 688s75.5-33.803 75.5-75.5V386C3980 381.582 3983.58 378 3988 378h86C4078.42 378 4082 381.582 4082 386V770C4082 774.418 4078.42 778 4074 778h-86C3983.58 778 3980 774.418 3980 770V764.6C3954.53 780.689 3924.35 790 3892 790 3800.87 790 3727 716.127 3727 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M3072.22 651.516C3074.01 646.419 3070.22 641.081 3064.82 641.081H2968.99C2966.42 641.081 2964 642.35 2962.54 644.474 2944.17 671.15 2915.17 688.108 2882.77 688.108 2837.92 688.108 2799.35 655.443 2786.97 609.73h288.51C3079.48 609.73 3082.84 606.719 3083.27 602.744 3084.15 594.747 3084.59 586.616 3084.59 578.378c0-116.507-90-211.621-201.82-211.621s-201.82 95.114-201.82 211.621S2770.95 790 2882.77 790C2969.93 790 3043.9 732.144 3072.22 651.516zM2882.77 468.649C2920.92 468.649 2954.47 492.229 2971.3 527.433H2794.24C2811.07 492.229 2844.62 468.649 2882.77 468.649z" fill="#333"/><path d="M1342 770.243C1342 774.661 1345.58 778.243 1350 778.243H1435.89c4.41999999999985.0 8-3.58200000000011 8-8V592.206L1495.37 540.725l196.9 234.656C1693.79 777.193 1696.04 778.239 1698.4 778.239h112.12C1817.32 778.239 1821.02 770.302 1816.65 765.096L1567.7 468.401l244.74-244.744C1817.48 218.617 1813.91 210 1806.78 210H1685.31C1683.19 210 1681.16 210.843 1679.66 212.343L1443.89 448.109V218C1443.89 213.582 1440.31 210 1435.89 210H1350C1345.58 210 1342 213.582 1342 218V770.243z" fill="#333"/><path d="M1828 386C1828 381.582 1831.58 378 1836 378h86C1926.42 378 1930 381.582 1930 386V612.5c0 41.697 33.8 75.5 75.5 75.5s75.5-33.803 75.5-75.5V386C2081 381.582 2084.58 378 2089 378h86C2179.42 378 2183 381.582 2183 386V770C2183 774.418 2179.42 778 2175 778h-86C2084.58 778 2081 774.418 2081 770V764.6C2055.53 780.689 2025.35 790 1993 790 1901.87 790 1828 716.127 1828 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M2254 210C2249.58 210 2246 213.582 2246 218V770C2246 774.418 2249.58 778 2254 778h86C2344.42 778 2348 774.418 2348 770V757.487C2378.39 778.082 2414.4 790 2453 790c108.8.0 197-94.692 197-211.5S2561.8 367 2453 367C2414.4 367 2378.39 378.918 2348 399.513V218C2348 213.582 2344.42 210 2340 210h-86zm94 368.5c0 60.475 44.77 109.5 1e2 109.5s1e2-49.025 1e2-109.5S2503.23 469 2448 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4153 210C4148.58 210 4145 213.582 4145 218V770C4145 774.418 4148.58 778 4153 778h86C4243.42 778 4247 774.418 4247 770V757.487C4277.39 778.082 4313.4 790 4352 790c108.8.0 197-94.692 197-211.5S4460.8 367 4352 367C4313.4 367 4277.39 378.918 4247 399.513V218C4247 213.582 4243.42 210 4239 210h-86zm94 368.5C4247 638.975 4291.77 688 4347 688s1e2-49.025 1e2-109.5S4402.23 469 4347 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path d="M554.586 39C564.593 21.6667 552.084.0 532.069.0H346.41c-35.726.0-68.739 19.0599-86.602 50L28.8676 450C11.0043 480.94 11.0042 519.06 28.8675 550L259.808 950C277.671 980.94 310.684 1e3 346.41 1e3H447.276C456.208 1e3 464.461 995.235 468.927 987.5L612.399 739C622.406 721.667 609.897 7e2 589.882 7e2H427.239C412.949 7e2 399.743 692.376 392.598 680L300.222 520C293.077 507.624 293.077 492.376 300.222 480l85.964-148.894L386 330.999 554.586 39z" fill="#0056ff"/><path d="M564.401 3e2C544.386 3e2 531.877 278.333 541.884 261L685.356 12.5C689.822 4.76496 698.075.0 707.006.0H808.29C844.017.0 877.03 19.06 894.893 50.0001L1125.83 450C1143.7 480.94 1143.7 519.06 1125.83 550L894.893 950C877.03 980.94 844.017 1e3 808.29 1e3H622.214C602.199 1e3 589.69 978.333 599.697 961L750.385 7e2H750.555L854.478 520C861.624 507.624 861.624 492.376 854.478 480L762.102 320C754.957 307.624 741.752 3e2 727.461 3e2H564.401z" fill="#0056ff"/></svg></span><span class="text-uppercase font-weight-bold">KubeCube</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/kubecube-io/kubecube target=_blank><i class="fab fa-github"></i><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.d5a631f6a2fe4c00c21a0bc429b81434.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.d5a631f6a2fe4c00c21a0bc429b81434.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>博客</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-li><input type=checkbox id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-check>
<label for=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-check><a href=/blog/2023/04/10/kubecube-v1.8-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883><span>KubeCube v1.8 版本发布</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-li><input type=checkbox id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-check>
<label for=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-check><a href=/blog/2022/09/13/kubecube-%E7%89%88%E6%9C%AC%E8%BD%AC%E6%8D%A2%E5%A4%A7%E5%B9%85%E6%8F%90%E5%8D%87k8s%E7%89%88%E6%9C%AC%E9%80%82%E9%85%8D%E8%83%BD%E5%8A%9B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b><span>KubeCube 版本转换：大幅提升K8s版本适配能力</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-li><input type=checkbox id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-check checked>
<label for=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-check><a href=/blog/2021/12/24/kubecube-v1.1-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883><span class=td-sidebar-nav-active-item>KubeCube v1.1 版本发布</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-li><input type=checkbox id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-check>
<label for=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-check><a href=/blog/2021/10/29/%E6%B7%B1%E5%85%A5%E8%A7%A3%E8%AF%BB-kubecube-%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086><span>深入解读 KubeCube 多集群管理</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-li><input type=checkbox id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-check>
<label for=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-check><a href=/blog/2021/09/16/kubecube-%E5%A4%9A%E7%BA%A7%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%9E%8B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b><span>KubeCube 多级租户模型</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-li><input type=checkbox id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-check>
<label for=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-check><a href=/blog/2021/08/31/kubecube%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5%E5%88%9D%E5%AD%A6%E8%80%85%E7%8E%A9%E5%A5%BDkubernetes%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf><span>KubeCube设计实践，初学者玩好Kubernetes的正确姿势</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-li><input type=checkbox id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-check>
<label for=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-check><a href=/blog/2021/08/25/kubecube%E5%BC%80%E6%BA%90%E9%AD%94%E6%96%B9%E5%85%AD%E9%9D%A2%E9%99%8D%E9%98%B6kubernetes%E8%90%BD%E5%9C%B0%E5%BA%94%E7%94%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8><span>KubeCube开源：魔方六面，降阶Kubernetes落地应用</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/kubecube-io/kubecube-io.github.io/edit/main/content/zh/blog/auth-proxy/index.md target=_blank><i class="fa fa-edit fa-fw"></i>编辑此页</a>
<a href="https://github.com/kubecube-io/kubecube-io.github.io/new/main/content/zh/blog/auth-proxy/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i>添加子页面</a>
<a href="https://github.com/kubecube-io/kubecube-io.github.io/issues/new?title=KubeCube%20v1.1%20%e7%89%88%e6%9c%ac%e5%8f%91%e5%b8%83" target=_blank><i class="fab fa-github fa-fw"></i>提交文档问题</a>
<a href=https://github.com/kubecube-io/kubecube/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>提交项目问题</a>
<a id=print href=https://kubecube-io.github.io/blog/_print/><i class="fa fa-print fa-fw"></i>整节打印</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#使用-auth-webhook-的困境>使用 Auth-Webhook 的困境</a></li><li><a href=#warden-auth-proxy>Warden-Auth-Proxy</a><ul><li><a href=#1-kubectl-exec-命令代理协议问题>1. kubectl exec 命令代理协议问题</a></li><li><a href=#2-kubeconfig-配置问题>2. kubeconfig 配置问题</a></li><li><a href=#3-security-通信安全问题>3. security 通信安全问题</a></li></ul></li><li><a href=#写在最后>写在最后</a></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>KubeCube v1.1 版本发布</h1><div class="td-byline mb-4">By <b>蔡鑫涛</b> |
<time datetime=2021-12-24 class=text-muted>Friday, December 24, 2021</time></div><header class=article-meta></header><p>KubeCube 迎来了 v1.1 版本的发布，新增了 OAuth2 的 GitHub 登录支持、租户配额的算法优化、Warden 热插拔安装包的本地和远端拉取支持等新的特性，也修复了若干已知问题，详见 <a href=https://github.com/kubecube-io/KubeCube/blob/release-v1.1/docs/changelog.md>ChangeLog</a>。</p><p>v1.1 版本中最主要的特性是 Auth-Proxy 能力的支持，使得部署更加轻量，无需侵入修改 kube-apiserver 的配置。用户可以使用 RESTful、client-go、kubectl 等方式访问被 KubeCube 纳管的 K8s 集群，享受统一的认证能力。</p><h2 id=使用-auth-webhook-的困境>使用 Auth-Webhook 的困境</h2><p><img src=imgs/auth-webhook.png alt=Auth-Webhook></p><p>在 KubeCube v1.1 版本之前，KubeCube 使用 K8s 提供的 Auth-Webook 方式来拓展认证能力，该方式通过为 kube-apiserver 指定认证后端来达到认证拓展的目的，kube-apiserver 会使用认证 Webhook 返回的 UserInfo 去进行下一步的鉴权流程。</p><p>该方式虽然能够使用 K8s 原生的方式拓展认证能力，但是在实际使用中存在一定的不足。如 <a href=https://github.com/kubecube-io/KubeCube/issues/62>Issues#62</a> 中所指出的，该方式需要修改 kube-apiserver 的启动参数，为其<a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/#webhook-token-authentication>指定额外的认证 Webhook 后端</a>，当我们的 K8s 集群是多 Master 节点的高可用集群时，需要修改每一个 Master 节点的 kube-apiserver 的配置，这在很多场景几乎是无法接受的。另外在一些云厂商的托管 K8s 场景下，往往只对用户提供工作节点，此时想修改 kube-apiserver 的配置是非常困难的。</p><h2 id=warden-auth-proxy>Warden-Auth-Proxy</h2><p><img src=imgs/auth-proxy.png alt=Auth-Proxy></p><p>对于 Auth-Webhook 面临的困境，我们设计了 Warden-Auth-Proxy 模块来解决问题。Warden-Auth-Proxy 即 K8s 集群的认证代理，它对外提供了类似 <code>kubectl proxy</code> 的代理能力。不同的是，它会解析 request 中的 Bearer Token 为 UserInfo，然后使用 K8s 的 <a href=https://kubernetes.io/zh/docs/reference/access-authn-authz/authentication/#user-impersonation>impersonation 能力</a>进行用户伪装。</p><p>值得一提的是，Auth-Proxy 模块之所以集成在作为 Cluster Agent 的 Warden 中，而不是集成在管控集群的 KubeCube 中，是因为在设计上希望做到两点：</p><ol><li>对于各个集群的请求能够就近访问本集群的代理服务，而不是跨集群访问 KubeCube 中的代理服务。</li><li>即使当 KubeCube 发生 Crash 的时候，各个集群的认证鉴权能力依然能够保持正常。</li></ol><p>Auth-Proxy 的原理并不复杂，但是在实现中，需要注意以下几个问题：</p><h3 id=1-kubectl-exec-命令代理协议问题>1. kubectl exec 命令代理协议问题</h3><p>对于代理 <code>kubectl exec</code> 的场景，使用普通的 HTTP 代理并不可行，究其原因是因为通信协议不匹配。</p><p>不同于其他的 HTTP RESTful 请求，<code>kubectl exec</code> 命令实际是使用的 <a href=https://en.wikipedia.org/wiki/SPDY>SPDY 协议</a>，SPDY 协议是 google 开发的 TCP 会话层协议, SPDY 协议中将 HTTP 的 request/response 称为 Stream，并支持 TCP 的链接复用，同时多个 stream之间通过 stream-id 来进行标记，简单来说就是支持在单个链接同时进行多个请求响应的处理，并且互不影响 。</p><p>在代理 <code>kubectl exec</code> 请求时，需要 Upgrade HTTP 协议，即通过 101(switching protocal) 状态码切换至 SPDY 协议来继续与下游服务通信。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=color:#204a87;font-weight:700>func</span> <span style=color:#000;font-weight:700>(</span><span style=color:#000>h</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>UpgradeAwareHandler</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000>ServeHTTP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span> <span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ResponseWriter</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>req</span> <span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>http</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Request</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
  <span style=color:#8f5902;font-style:italic>// 尝试协议 upgrade
</span><span style=color:#8f5902;font-style:italic></span>  <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tryUpgrade</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>req</span><span style=color:#000;font-weight:700>)</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>return</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>UpgradeRequired</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Responder</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>req</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>errors</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewBadRequest</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;Upgrade request required&#34;</span><span style=color:#000;font-weight:700>))</span>
		<span style=color:#204a87;font-weight:700>return</span>
	<span style=color:#000;font-weight:700>}</span>

  <span style=color:#ce5c00;font-weight:700>...</span>

  <span style=color:#8f5902;font-style:italic>// 构建 golang 经典的 ReverseProxy
</span><span style=color:#8f5902;font-style:italic></span>	<span style=color:#000>proxy</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>httputil</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewSingleHostReverseProxy</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>url</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>URL</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Scheme</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>Host</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Location</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Host</span><span style=color:#000;font-weight:700>})</span>
	<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Transport</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Transport</span>
	<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FlushInterval</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>FlushInterval</span>
	<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrorLog</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>noSuppressPanicError</span><span style=color:#000;font-weight:700>{},</span> <span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>LstdFlags</span><span style=color:#000;font-weight:700>)</span>
	<span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Responder</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrorHandler</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>h</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Responder</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span>
	<span style=color:#000;font-weight:700>}</span>
	<span style=color:#000>proxy</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ServeHTTP</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>w</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>newReq</span><span style=color:#000;font-weight:700>)</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h3 id=2-kubeconfig-配置问题>2. kubeconfig 配置问题</h3><p>对于使用 kubeconfig 与集群通信的场景，默认的 kubeconfig 中的 <code>cluster server</code> 的地址往往直接指向 kube-apiserver，这使得用户与集群的通信没有经过 Warden-Auth-Proxy 代理。</p><p>因此，对于上述场景，我们需要在 kubeconfig 上做文章。KubeCube 提供下载 kubeconfig 的能力，使用当前 user 下载的 kubeconfig，包含了 user 的访问凭证，包含了该 user 所能访问的所有 cluster 的 context，user 可以自行切换 context 来对 KubeCube 纳管的集群进行访问。KubeCube 通过改写 kubeconfig 中的 kube-apiserver 地址为 Warden-Auth-Proxy 地址来使得用户通过该 kubeconfig 执行的 kubectl 或 client-go 请求会被 Warden-Auth-Proxy 所代理。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>clusters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>certificate-authority-data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>member_1_cluster_ca_data}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>member_1_warden_auth_proxy_addr}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>certificate-authority-data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>pivot_cluster_ca_data}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>pivot_warden_auth_proxy_addr}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>contexts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>context</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1-admin@member-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>context</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster-admin@pivot-cluster</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>current-context</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1-admin@member-1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Config</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>member-1-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>token</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>user_token}</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster-admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>token</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span>{<span style=color:#000>user_token}</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=3-security-通信安全问题>3. security 通信安全问题</h3><p><img src=imgs/auth-proxy-security.png alt=Auth-Proxy-security></p><p>在对通信安全有较高要求的场景下，我们需要保证从 <code>Client——>Warden-Auth-Proxy——>kube-apiserver</code> 的通信链路是加密的，可靠的。我们使用以下方式加以保证：</p><ul><li>KubeCube 使用 Bearer Token 作为用户访问凭证，Invalid Bearer Token 会被 Warden-Auth-Proxy 拒绝，相当于服务端要求验证客户端身份。</li><li>应使用 TLS 对 Warden-Auth-Proxy 进行服务端身份校验，需要相应的 CA 证书，该 TLS 能力在规划中，还未支持。当前使用 <code>insecure-skip-tls-verify</code> 跳过，在后续版本中，会增加对 TLS 能力的支持。</li><li>Warden-Auth-Proxy 与 kube-apiserver 之间，通过 mTLS 进行双向加密通信，Warden-Auth-Proxy 持有 K8s 集群的 admin 证书，并以 admin 身份伪装成目标 user 与 kube-apiserver 进行通信。</li></ul><h2 id=写在最后>写在最后</h2><p>未来我们会持续提供更多功能，帮助企业简化容器化落地。也欢迎大家参与贡献，提出宝贵的建议。添加以下微信进入 KubeCube 交流群。</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=height:200px></p><p><strong>作者简介：</strong> 蔡鑫涛，网易数帆轻舟容器平台资深开发，KubeCube Committer</p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2021/10/29/%E6%B7%B1%E5%85%A5%E8%A7%A3%E8%AF%BB-kubecube-%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/ aria-label="上一页 - 深入解读 KubeCube 多集群管理" class="btn btn-primary"><span class=mr-1>←</span> 上一页</a></li><a href=/blog/2022/09/13/kubecube-%E7%89%88%E6%9C%AC%E8%BD%AC%E6%8D%A2%E5%A4%A7%E5%B9%85%E6%8F%90%E5%8D%87k8s%E7%89%88%E6%9C%AC%E9%80%82%E9%85%8D%E8%83%BD%E5%8A%9B/ aria-label="下一页 - KubeCube 版本转换：大幅提升K8s版本适配能力" class="btn btn-primary">下一页 <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kubecube-io/kubecube aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2024 KubeCube Project Authors All Rights Reserved</small>
<small class=ml-1><a href=http://www.apache.org/licenses/LICENSE-2.0 target=_blank rel=noopener>隐私政策</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>