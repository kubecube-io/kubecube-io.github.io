<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.81.0"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>KubeCube 多级租户模型 | KubeCube</title><meta name=description content="开源容器平台"><meta property="og:title" content="KubeCube 多级租户模型"><meta property="og:description" content="KubeCube 多级租户模型解读"><meta property="og:type" content="article"><meta property="og:url" content="https://kubecube-io.github.io/blog/2021/09/16/kubecube-%E5%A4%9A%E7%BA%A7%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%9E%8B/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-09-16T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-15T10:50:37+08:00"><meta property="og:site_name" content="KubeCube"><meta itemprop=name content="KubeCube 多级租户模型"><meta itemprop=description content="KubeCube 多级租户模型解读"><meta itemprop=datePublished content="2021-09-16T00:00:00+00:00"><meta itemprop=dateModified content="2022-08-15T10:50:37+08:00"><meta itemprop=wordCount content="140"><meta itemprop=keywords content="KubeCube,"><meta name=twitter:card content="summary"><meta name=twitter:title content="KubeCube 多级租户模型"><meta name=twitter:description content="KubeCube 多级租户模型解读"><link rel=preload href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css as=style><link href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="4984" height="1e3" viewBox="0 0 4984 1e3" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3551.54 432.823C3552.84 435.556 3555.59 437.298 3558.62 437.298H3658.46C3663.69 437.298 3667.45 432.277 3665.98 427.259 3634.56 319.831 3535.31 241.352 3417.7 241.352H3402.03c-142.85.0-258.65 115.801-258.65 258.648v31.352c0 142.847 115.8 258.648 258.65 258.648H3417.7c117.61.0 216.86-78.48 248.28-185.907C3667.45 599.075 3663.69 594.054 3658.46 594.054H3558.62C3555.59 594.054 3552.84 595.796 3551.54 598.529 3526.37 651.507 3472.39 688.108 3409.87 688.108 3323.29 688.108 3253.11 617.926 3253.11 531.352V5e2C3253.11 413.426 3323.29 343.243 3409.87 343.243c62.52.0 116.5 36.601 141.67 89.58z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4970.89 651.516C4972.68 646.419 4968.9 641.081 4963.5 641.081H4867.67C4865.09 641.081 4862.68 642.35 4861.21 644.474 4842.85 671.15 4813.84 688.108 4781.45 688.108 4736.6 688.108 4698.03 655.443 4685.65 609.73h288.5C4978.15 609.73 4981.51 606.719 4981.95 602.744 4982.82 594.747 4983.27 586.616 4983.27 578.378c0-116.507-90-211.621-201.820000000001-211.621-111.83.0-201.83 95.114-201.83 211.621S4669.62 790 4781.45 790C4868.6 790 4942.57 732.144 4970.89 651.516zM4781.45 468.649C4819.59 468.649 4853.14 492.229 4869.98 527.433H4692.92C4709.75 492.229 4743.3 468.649 4781.45 468.649z" fill="#333"/><path d="M3727 386C3727 381.582 3730.58 378 3735 378h86C3825.42 378 3829 381.582 3829 386V612.5C3829 654.197 3862.8 688 3904.5 688s75.5-33.803 75.5-75.5V386C3980 381.582 3983.58 378 3988 378h86C4078.42 378 4082 381.582 4082 386V770C4082 774.418 4078.42 778 4074 778h-86C3983.58 778 3980 774.418 3980 770V764.6C3954.53 780.689 3924.35 790 3892 790 3800.87 790 3727 716.127 3727 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M3072.22 651.516C3074.01 646.419 3070.22 641.081 3064.82 641.081H2968.99C2966.42 641.081 2964 642.35 2962.54 644.474 2944.17 671.15 2915.17 688.108 2882.77 688.108 2837.92 688.108 2799.35 655.443 2786.97 609.73h288.51C3079.48 609.73 3082.84 606.719 3083.27 602.744 3084.15 594.747 3084.59 586.616 3084.59 578.378c0-116.507-90-211.621-201.82-211.621s-201.82 95.114-201.82 211.621S2770.95 790 2882.77 790C2969.93 790 3043.9 732.144 3072.22 651.516zM2882.77 468.649C2920.92 468.649 2954.47 492.229 2971.3 527.433H2794.24C2811.07 492.229 2844.62 468.649 2882.77 468.649z" fill="#333"/><path d="M1342 770.243C1342 774.661 1345.58 778.243 1350 778.243H1435.89c4.41999999999985.0 8-3.58200000000011 8-8V592.206L1495.37 540.725l196.9 234.656C1693.79 777.193 1696.04 778.239 1698.4 778.239h112.12C1817.32 778.239 1821.02 770.302 1816.65 765.096L1567.7 468.401l244.74-244.744C1817.48 218.617 1813.91 210 1806.78 210H1685.31C1683.19 210 1681.16 210.843 1679.66 212.343L1443.89 448.109V218C1443.89 213.582 1440.31 210 1435.89 210H1350C1345.58 210 1342 213.582 1342 218V770.243z" fill="#333"/><path d="M1828 386C1828 381.582 1831.58 378 1836 378h86C1926.42 378 1930 381.582 1930 386V612.5c0 41.697 33.8 75.5 75.5 75.5s75.5-33.803 75.5-75.5V386C2081 381.582 2084.58 378 2089 378h86C2179.42 378 2183 381.582 2183 386V770C2183 774.418 2179.42 778 2175 778h-86C2084.58 778 2081 774.418 2081 770V764.6C2055.53 780.689 2025.35 790 1993 790 1901.87 790 1828 716.127 1828 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M2254 210C2249.58 210 2246 213.582 2246 218V770C2246 774.418 2249.58 778 2254 778h86C2344.42 778 2348 774.418 2348 770V757.487C2378.39 778.082 2414.4 790 2453 790c108.8.0 197-94.692 197-211.5S2561.8 367 2453 367C2414.4 367 2378.39 378.918 2348 399.513V218C2348 213.582 2344.42 210 2340 210h-86zm94 368.5c0 60.475 44.77 109.5 1e2 109.5s1e2-49.025 1e2-109.5S2503.23 469 2448 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4153 210C4148.58 210 4145 213.582 4145 218V770C4145 774.418 4148.58 778 4153 778h86C4243.42 778 4247 774.418 4247 770V757.487C4277.39 778.082 4313.4 790 4352 790c108.8.0 197-94.692 197-211.5S4460.8 367 4352 367C4313.4 367 4277.39 378.918 4247 399.513V218C4247 213.582 4243.42 210 4239 210h-86zm94 368.5C4247 638.975 4291.77 688 4347 688s1e2-49.025 1e2-109.5S4402.23 469 4347 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path d="M554.586 39C564.593 21.6667 552.084.0 532.069.0H346.41c-35.726.0-68.739 19.0599-86.602 50L28.8676 450C11.0043 480.94 11.0042 519.06 28.8675 550L259.808 950C277.671 980.94 310.684 1e3 346.41 1e3H447.276C456.208 1e3 464.461 995.235 468.927 987.5L612.399 739C622.406 721.667 609.897 7e2 589.882 7e2H427.239C412.949 7e2 399.743 692.376 392.598 680L300.222 520C293.077 507.624 293.077 492.376 300.222 480l85.964-148.894L386 330.999 554.586 39z" fill="#0056ff"/><path d="M564.401 3e2C544.386 3e2 531.877 278.333 541.884 261L685.356 12.5C689.822 4.76496 698.075.0 707.006.0H808.29C844.017.0 877.03 19.06 894.893 50.0001L1125.83 450C1143.7 480.94 1143.7 519.06 1125.83 550L894.893 950C877.03 980.94 844.017 1e3 808.29 1e3H622.214C602.199 1e3 589.69 978.333 599.697 961L750.385 7e2H750.555L854.478 520C861.624 507.624 861.624 492.376 854.478 480L762.102 320C754.957 307.624 741.752 3e2 727.461 3e2H564.401z" fill="#0056ff"/></svg></span><span class="text-uppercase font-weight-bold">KubeCube</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/docs/><span>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/blog/><span class=active>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/kubecube-io/kubecube target=_blank><i class="fab fa-github"></i><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.d5a631f6a2fe4c00c21a0bc429b81434.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.d5a631f6a2fe4c00c21a0bc429b81434.json data-offline-search-base-href=/ data-offline-search-max-results=10>
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-blog-li><a href=/blog/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section tree-root" id=m-blog><span>博客</span></a><ul class=ul-1><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-li><input type=checkbox id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-check>
<label for=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883-check><a href=/blog/2023/04/10/kubecube-v1.8-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20230410kubecube-v18-e78988e69cace58f91e5b883><span>KubeCube v1.8 版本发布</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-li><input type=checkbox id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-check>
<label for=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b-check><a href=/blog/2022/09/13/kubecube-%E7%89%88%E6%9C%AC%E8%BD%AC%E6%8D%A2%E5%A4%A7%E5%B9%85%E6%8F%90%E5%8D%87k8s%E7%89%88%E6%9C%AC%E9%80%82%E9%85%8D%E8%83%BD%E5%8A%9B/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20220913kubecube-e78988e69cace8bdace68da2e5a4a7e5b985e68f90e58d87k8se78988e69cace98082e9858de883bde58a9b><span>KubeCube 版本转换：大幅提升K8s版本适配能力</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-li><input type=checkbox id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-check>
<label for=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883-check><a href=/blog/2021/12/24/kubecube-v1.1-%E7%89%88%E6%9C%AC%E5%8F%91%E5%B8%83/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211224kubecube-v11-e78988e69cace58f91e5b883><span>KubeCube v1.1 版本发布</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-li><input type=checkbox id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-check>
<label for=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086-check><a href=/blog/2021/10/29/%E6%B7%B1%E5%85%A5%E8%A7%A3%E8%AF%BB-kubecube-%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20211029e6b7b1e585a5e8a7a3e8afbb-kubecube-e5a49ae99b86e7bea4e7aea1e79086><span>深入解读 KubeCube 多集群管理</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-li><input type=checkbox id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-check checked>
<label for=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b-check><a href=/blog/2021/09/16/kubecube-%E5%A4%9A%E7%BA%A7%E7%A7%9F%E6%88%B7%E6%A8%A1%E5%9E%8B/ class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-blog20210916kubecube-e5a49ae7baa7e7a79fe688b7e6a8a1e59e8b><span class=td-sidebar-nav-active-item>KubeCube 多级租户模型</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-li><input type=checkbox id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-check>
<label for=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf-check><a href=/blog/2021/08/31/kubecube%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5%E5%88%9D%E5%AD%A6%E8%80%85%E7%8E%A9%E5%A5%BDkubernetes%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210831kubecubee8aebee8aea1e5ae9ee8b7b5e5889de5ada6e88085e78ea9e5a5bdkubernetese79a84e6ada3e7a1aee5a7bfe58abf><span>KubeCube设计实践，初学者玩好Kubernetes的正确姿势</span></a></label></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-li><input type=checkbox id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-check>
<label for=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8-check><a href=/blog/2021/08/25/kubecube%E5%BC%80%E6%BA%90%E9%AD%94%E6%96%B9%E5%85%AD%E9%9D%A2%E9%99%8D%E9%98%B6kubernetes%E8%90%BD%E5%9C%B0%E5%BA%94%E7%94%A8/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-blog20210825kubecubee5bc80e6ba90e9ad94e696b9e585ade99da2e9998de998b6kubernetese890bde59cb0e5ba94e794a8><span>KubeCube开源：魔方六面，降阶Kubernetes落地应用</span></a></label></li></ul></li></ul></nav></div></aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"><a href=https://github.com/kubecube-io/kubecube-io.github.io/edit/main/content/zh/blog/multi-tenancy/index.md target=_blank><i class="fa fa-edit fa-fw"></i>编辑此页</a>
<a href="https://github.com/kubecube-io/kubecube-io.github.io/new/main/content/zh/blog/multi-tenancy/index.md?filename=change-me.md&value=---%0Atitle%3A+%22Long+Page+Title%22%0AlinkTitle%3A+%22Short+Nav+Title%22%0Aweight%3A+100%0Adescription%3A+%3E-%0A+++++Page+description+for+heading+and+indexes.%0A---%0A%0A%23%23+Heading%0A%0AEdit+this+template+to+create+your+new+page.%0A%0A%2A+Give+it+a+good+name%2C+ending+in+%60.md%60+-+e.g.+%60getting-started.md%60%0A%2A+Edit+the+%22front+matter%22+section+at+the+top+of+the+page+%28weight+controls+how+its+ordered+amongst+other+pages+in+the+same+directory%3B+lowest+number+first%29.%0A%2A+Add+a+good+commit+message+at+the+bottom+of+the+page+%28%3C80+characters%3B+use+the+extended+description+field+for+more+detail%29.%0A%2A+Create+a+new+branch+so+you+can+preview+your+new+file+and+request+a+review+via+Pull+Request.%0A" target=_blank><i class="fa fa-edit fa-fw"></i>添加子页面</a>
<a href="https://github.com/kubecube-io/kubecube-io.github.io/issues/new?title=KubeCube%20%e5%a4%9a%e7%ba%a7%e7%a7%9f%e6%88%b7%e6%a8%a1%e5%9e%8b" target=_blank><i class="fab fa-github fa-fw"></i>提交文档问题</a>
<a href=https://github.com/kubecube-io/kubecube/issues/new target=_blank><i class="fas fa-tasks fa-fw"></i>提交项目问题</a>
<a id=print href=https://kubecube-io.github.io/blog/_print/><i class="fa fa-print fa-fw"></i>整节打印</a></div><div class=td-toc><nav id=TableOfContents><ul><li><a href=#kubecube-多级租户模型>KubeCube 多级租户模型</a><ul><li><a href=#背景>背景</a></li><li><a href=#租户模型介绍>租户模型介绍</a></li><li><a href=#多级租户模型设计>多级租户模型设计</a></li><li><a href=#租户项目权限设计>租户项目权限设计</a></li><li><a href=#资源配额管理设计>资源配额管理设计</a></li><li><a href=#总结>总结</a></li></ul></li></ul></nav></div></aside><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>KubeCube 多级租户模型</h1><div class="td-byline mb-4">By <b>傅思达</b> |
<time datetime=2021-09-16 class=text-muted>Thursday, September 16, 2021</time></div><header class=article-meta></header><h2 id=kubecube-多级租户模型>KubeCube 多级租户模型</h2><blockquote><p>KubeCube (<a href=https://kubecube.io>https://kubecube.io</a>) 是由网易数帆近期开源的一个轻量化的企业级容器平台，为企业提供 kubernetes 资源可视化管理以及统一的多集群多租户管理功能。KubeCube 社区将通过系列技术文章解读 KubeCube 的设计特点和技术实现，帮助开发者和用户更快地理解和上手 KubeCube。本文是第二篇，深度解读 KubeCube 的多级租户模型设计。</p></blockquote><p><img src=imgs/logo+kubecube.png alt=img></p><h3 id=背景>背景</h3><p>在我们跟企业交流时，发现不同企业虽然规模不一样，但选择进⾏容器化的初衷还是为了降本增效、很多企业会选择多个部⻔共⽤ K8s 集群或者物理资源，在共享资源的同时，希望有⾜够的隔离性。</p><p>多租户是一种软件架构技术，可以实现多个租户之间资源复用和共享基础设施，方便运营管理，有效节省开发应用成本；同时又可以实现个性化定制，每个租户的数据是隔离的。</p><p>当前大部分云供应商都提供了多租户的解决方案来实现 K8s 资源共享和隔离，以满足企业不同组织架构共享一个 K8s 基础设施的需求。我们将容器服务在以往企业落地实施过程中的经验进行了总结，去数据库化采用更轻量更原生的 CRD + Operator 机制，在传统多租户模型基础上加入了项目层级与软件管理过程相对应，形成了新的多级租户模型，适配企业组织架构和软件资源管理的规范，使得企业可以更好的建立统一的多 K8s 集群管理平台。</p><h3 id=租户模型介绍>租户模型介绍</h3><p>KubeCube 的多级租户模型通过租户和项目实现权限隔离和资源分配。一个租户表示一个组织（部门、团队），做资源隔离。一个项目通常可以表示一个完整业务应用系统，与企业的软件项目管理过程相对应，可以根据业务系统功能分解拆分多个命名空间管理应用子系统。</p><p>租户和项目都是跨集群的概念，所有租户共享多套 K8s 集群基础设施，通过权限限定和配额管理保证必要的隔离，防止恶意操作带来的风险。</p><h3 id=多级租户模型设计>多级租户模型设计</h3><p>KubeCube 多级租户模型提供租户、项目、空间 3 层模型以满足不同规模企业的组织架构层级，从架构上看是一种<strong>层级树形结构</strong>，一个租户包含多个项目，一个项目包含多个命名空间，项目包含的命名空间可以位于不同的 K8s 集群。这里的命名空间指的是 K8s 的<code>Namespace</code>，用于实际承接业务应用的部署，是管理的最小单元。</p><p><img src=imgs/tenant-project-structure.png alt=image-20210916173931577></p><p>租户和项目在实现上是一个 CRD ，用户只需要在管控 K8s 集群上创建租户和项目的 CR，KubeCube会将租户和项目的 CR 实时同步到所有的计算 K8s 集群。运维人员可以集中式的管理所有的计算 K8s 集群，新增集群时会自动同步租户项目等基础信息，项目管理员只需要在任一 K8s 集群（包括管控和计算集群）创建命名空间即可。</p><p><img src=imgs/tenant-project-in-multicluster.png alt=image-20210916174102135></p><p><strong>租户、项目和命名空间三者之间的关联关系是通过层级命名空间实现的</strong>，每一个租户都关联一个<code>Namespace</code>，每一个项目也都关联一个<code>Namespace</code>，通过租户和项目的Manifest里<code>.spec.namespace</code>字段指定关联的<code>Namespace</code>名称。租户和项目关联的命名空间与实际承载应用的命名空间不同，它是为了解决管理员仅可以在拥有权限的租户和项目下面创建命名空间而引入的一个特殊命名空间。</p><p>为了避免供应商锁定和更好的兼容原生 K8s 能力，KubeCube 的权限模型是基于 K8s 原生的 RBAC 能力实现的，我们期望项目管理员仅可以在他拥有权限的项目下面创建命名空间。假设授权给一个项目管理员<code>ClusterRole</code>定义赋予创建<code>Namespace</code>的权限，由于<code>Namespace</code>是集群级别资源，那么他将拥有超出项目范围任意创建命名空间的权限，这与我们的期望不符合。</p><p>这里我们引入 HNC （The Hierarchical Namespace Controller）的<code>SubNamespace</code>的概念，它是命名空间级别的资源，负责自动生成和控制<code>Namespace</code>的生命周期。在 KubeCube 的设计中，租户和项目管理员都没有直接创建命名空间的权限，他们通过拥有创建<code>SubNamespace</code>的权限来间接获得创建命名空间权利。<code>SubNamespace</code>是命名空间级别的资源，通过 RBAC 限制<code>SubNamespace</code>操作权限，租户管理员只能在自己租户关联的<code>Namespace</code>下创建<code>SubNamespace</code>，项目管理员只能在自己项目关联的<code>Namespace</code>下创建<code>SubNamespace</code>，再由 HNC 控制器组件根据<code>SubNamespace</code>自动创建<code>Namespace</code>，最终实现管理员仅可以在拥有权限的租户和项目下面创建命名空间的权限。</p><p><img src=imgs/tenant-hnc.png alt=image-20210916185015532></p><p>实际使用中，用户创建租户和项目的 CR 时，KubeCube 程序会自动监听并创建相应的<code>SubeNamespace</code>，再由 HNC 控制器监听并创建<code>Namespace</code>，继而将租户和项目与命名空间关联起来。</p><p>KubeCube 租户模型采用多层级命名空间的设计除了考虑权限限定能够兼容原生 K8s 的 RBAC 外，还额外考虑到一个因素是可以放置租户级的公共配置和项目级的公共配置，如针对整个项目的统一监控配置。在必要的时候，还可以指定 HNC 控制器将父级命名空间的资源复制传递到子命名空间，如用户权限绑定<code>RoleBinding</code>配置。</p><h3 id=租户项目权限设计>租户项目权限设计</h3><p>KubeCube 多级租户模型中预设了四种角色，它们的权限由大到小分别是：</p><ul><li>平台管理员：拥有最高权限，负责管理 K8s 集群，创建租户，设定角色权限和租户配额。</li><li>租户管理员：拥有某个租户的所有权限，主要负责租户下的项目管理。</li><li>项目管理员：负责在 K8s 集群上创建命名空间，部署应用，配置监控。</li><li>项目观察员：仅拥有项目下命名空间和资源的查询权限，可以查看应用日志和监控。</li></ul><p>在实现上，四种角色是四个<code>ClusterRole</code>定义，使用<code>CluaterRoleBinding</code>可以给用户授予平台管理员权限，使用<code>RoleBinding</code>可以给用户授予受限的租户管理员、项目管理员和项目观察员权限。在层级命名空间结构中，授予一个用户租户管理员权限相当于在租户关联的命名空间及它所有下级命名空间下创建<code>RoleBinding</code>，同理授予一个用户项目管理员和项目观察员权限相当于在项目关联的命名空间及它所有下级命名空间下创建<code>RoleBinding</code>。</p><p><img src=imgs/rbac-design.png alt=image-20210906190824488></p><p>HNC 控制器组件在创建<code>Namespace</code>的时候，可以指定把<code>SubNamespace</code>所在的父命名空间的所有 <code>RoleBinding</code>信息往下复制传递。因此给用户授予租户管理员权限时只需要在指定租户关联的命名空间下创建<code>RoleBinding</code>，授权项目管理员和项目观察员权限时只需要在指定项目关联的命名空间下创建<code>RoleBinding</code>，权限绑定关系会随着命名空间的创建逐级复制下发，最终在命名空间下会拥有不同人不同角色的<code>RoleBinding</code>信息。</p><h3 id=资源配额管理设计>资源配额管理设计</h3><p>KubeCube 的配额管理主要是针对多租户共享的 K8s 基础设施集群的资源分配，平台管理员可以为每一个租户划分每一个 K8s 集群的资源使用额度，包括 CPU、内存、磁盘和GPU的配额大小。租户管理员可以继续给项目划分配额，项目管理员可以给每一个承载应用系统的命名空间划分配额。集群信息<code>Cluster</code> （CRD）里记录着整个集群的可用配额信息，租户和项目的配额信息和已分配信息存储在<code>CubeResourceQuta</code>（CRD）里，命名空间的配额信息使用 K8s 原生<code>ResourceQuota</code>。</p><p><img src=imgs/quota-mgr.png alt=image-20210916185102212></p><p>实际使用的时候，项目配额可以省略，如 KubeCube 默认集成的管理平台，平台管理员只需要给每一个租户划分每一个 K8s 集群的可用额度，项目管理员在每一个 K8s 集群上创建命名空间的时候都不能分配超出所属租户的资源额度。</p><h3 id=总结>总结</h3><p>KubeCube 多级租户模型突破传统的容器服务多租户模式，采用租户、项目和空间的三级结构，与企业组织架构和软件管理适配，实现更细粒度的资源配额管理，满足企业统一容器平台的构建需求。以多层级命名空间为基础，租户项目权限隔离兼容原生 RBAC，使得 KubeCube 多级租户模型可以更好的兼容原生 K8s 集群，完全能够在已有 K8s 集群上进行原地升级安装 KubeCube。</p><p>作者：傅思达</p><p>更多内容请访问：https://www.kubecube.io</p><p>KubeCube技术交流群：</p><p><img src=/imgs/kubecube-wechat.png alt=kubecube微信 style=height:200px></p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2021/08/31/kubecube%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5%E5%88%9D%E5%AD%A6%E8%80%85%E7%8E%A9%E5%A5%BDkubernetes%E7%9A%84%E6%AD%A3%E7%A1%AE%E5%A7%BF%E5%8A%BF/ aria-label="上一页 - KubeCube设计实践，初学者玩好Kubernetes的正确姿势" class="btn btn-primary"><span class=mr-1>←</span> 上一页</a></li><a href=/blog/2021/10/29/%E6%B7%B1%E5%85%A5%E8%A7%A3%E8%AF%BB-kubecube-%E5%A4%9A%E9%9B%86%E7%BE%A4%E7%AE%A1%E7%90%86/ aria-label="下一页 - 深入解读 KubeCube 多集群管理" class="btn btn-primary">下一页 <span class=ml-1>→</span></a></li></ul></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kubecube-io/kubecube aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 KubeCube Project Authors All Rights Reserved</small>
<small class=ml-1><a href=http://www.apache.org/licenses/LICENSE-2.0 target=_blank rel=noopener>隐私政策</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>