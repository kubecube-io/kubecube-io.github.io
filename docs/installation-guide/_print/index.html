<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.81.0"><link rel=canonical type=text/html href=https://kubecube-io.github.io/docs/installation-guide/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>部署指南 | KubeCube</title><meta name=description content="开源容器平台"><meta property="og:title" content="部署指南"><meta property="og:description" content="开源容器平台"><meta property="og:type" content="website"><meta property="og:url" content="https://kubecube-io.github.io/docs/installation-guide/"><meta property="og:site_name" content="KubeCube"><meta itemprop=name content="部署指南"><meta itemprop=description content="开源容器平台"><meta name=twitter:card content="summary"><meta name=twitter:title content="部署指南"><meta name=twitter:description content="开源容器平台"><link rel=preload href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css as=style><link href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="4984" height="1e3" viewBox="0 0 4984 1e3" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3551.54 432.823C3552.84 435.556 3555.59 437.298 3558.62 437.298H3658.46C3663.69 437.298 3667.45 432.277 3665.98 427.259 3634.56 319.831 3535.31 241.352 3417.7 241.352H3402.03c-142.85.0-258.65 115.801-258.65 258.648v31.352c0 142.847 115.8 258.648 258.65 258.648H3417.7c117.61.0 216.86-78.48 248.28-185.907C3667.45 599.075 3663.69 594.054 3658.46 594.054H3558.62C3555.59 594.054 3552.84 595.796 3551.54 598.529 3526.37 651.507 3472.39 688.108 3409.87 688.108 3323.29 688.108 3253.11 617.926 3253.11 531.352V5e2C3253.11 413.426 3323.29 343.243 3409.87 343.243c62.52.0 116.5 36.601 141.67 89.58z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4970.89 651.516C4972.68 646.419 4968.9 641.081 4963.5 641.081H4867.67C4865.09 641.081 4862.68 642.35 4861.21 644.474 4842.85 671.15 4813.84 688.108 4781.45 688.108 4736.6 688.108 4698.03 655.443 4685.65 609.73h288.5C4978.15 609.73 4981.51 606.719 4981.95 602.744 4982.82 594.747 4983.27 586.616 4983.27 578.378c0-116.507-90-211.621-201.820000000001-211.621-111.83.0-201.83 95.114-201.83 211.621S4669.62 790 4781.45 790C4868.6 790 4942.57 732.144 4970.89 651.516zM4781.45 468.649C4819.59 468.649 4853.14 492.229 4869.98 527.433H4692.92C4709.75 492.229 4743.3 468.649 4781.45 468.649z" fill="#333"/><path d="M3727 386C3727 381.582 3730.58 378 3735 378h86C3825.42 378 3829 381.582 3829 386V612.5C3829 654.197 3862.8 688 3904.5 688s75.5-33.803 75.5-75.5V386C3980 381.582 3983.58 378 3988 378h86C4078.42 378 4082 381.582 4082 386V770C4082 774.418 4078.42 778 4074 778h-86C3983.58 778 3980 774.418 3980 770V764.6C3954.53 780.689 3924.35 790 3892 790 3800.87 790 3727 716.127 3727 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M3072.22 651.516C3074.01 646.419 3070.22 641.081 3064.82 641.081H2968.99C2966.42 641.081 2964 642.35 2962.54 644.474 2944.17 671.15 2915.17 688.108 2882.77 688.108 2837.92 688.108 2799.35 655.443 2786.97 609.73h288.51C3079.48 609.73 3082.84 606.719 3083.27 602.744 3084.15 594.747 3084.59 586.616 3084.59 578.378c0-116.507-90-211.621-201.82-211.621s-201.82 95.114-201.82 211.621S2770.95 790 2882.77 790C2969.93 790 3043.9 732.144 3072.22 651.516zM2882.77 468.649C2920.92 468.649 2954.47 492.229 2971.3 527.433H2794.24C2811.07 492.229 2844.62 468.649 2882.77 468.649z" fill="#333"/><path d="M1342 770.243C1342 774.661 1345.58 778.243 1350 778.243H1435.89c4.41999999999985.0 8-3.58200000000011 8-8V592.206L1495.37 540.725l196.9 234.656C1693.79 777.193 1696.04 778.239 1698.4 778.239h112.12C1817.32 778.239 1821.02 770.302 1816.65 765.096L1567.7 468.401l244.74-244.744C1817.48 218.617 1813.91 210 1806.78 210H1685.31C1683.19 210 1681.16 210.843 1679.66 212.343L1443.89 448.109V218C1443.89 213.582 1440.31 210 1435.89 210H1350C1345.58 210 1342 213.582 1342 218V770.243z" fill="#333"/><path d="M1828 386C1828 381.582 1831.58 378 1836 378h86C1926.42 378 1930 381.582 1930 386V612.5c0 41.697 33.8 75.5 75.5 75.5s75.5-33.803 75.5-75.5V386C2081 381.582 2084.58 378 2089 378h86C2179.42 378 2183 381.582 2183 386V770C2183 774.418 2179.42 778 2175 778h-86C2084.58 778 2081 774.418 2081 770V764.6C2055.53 780.689 2025.35 790 1993 790 1901.87 790 1828 716.127 1828 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M2254 210C2249.58 210 2246 213.582 2246 218V770C2246 774.418 2249.58 778 2254 778h86C2344.42 778 2348 774.418 2348 770V757.487C2378.39 778.082 2414.4 790 2453 790c108.8.0 197-94.692 197-211.5S2561.8 367 2453 367C2414.4 367 2378.39 378.918 2348 399.513V218C2348 213.582 2344.42 210 2340 210h-86zm94 368.5c0 60.475 44.77 109.5 1e2 109.5s1e2-49.025 1e2-109.5S2503.23 469 2448 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4153 210C4148.58 210 4145 213.582 4145 218V770C4145 774.418 4148.58 778 4153 778h86C4243.42 778 4247 774.418 4247 770V757.487C4277.39 778.082 4313.4 790 4352 790c108.8.0 197-94.692 197-211.5S4460.8 367 4352 367C4313.4 367 4277.39 378.918 4247 399.513V218C4247 213.582 4243.42 210 4239 210h-86zm94 368.5C4247 638.975 4291.77 688 4347 688s1e2-49.025 1e2-109.5S4402.23 469 4347 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path d="M554.586 39C564.593 21.6667 552.084.0 532.069.0H346.41c-35.726.0-68.739 19.0599-86.602 50L28.8676 450C11.0043 480.94 11.0042 519.06 28.8675 550L259.808 950C277.671 980.94 310.684 1e3 346.41 1e3H447.276C456.208 1e3 464.461 995.235 468.927 987.5L612.399 739C622.406 721.667 609.897 7e2 589.882 7e2H427.239C412.949 7e2 399.743 692.376 392.598 680L300.222 520C293.077 507.624 293.077 492.376 300.222 480l85.964-148.894L386 330.999 554.586 39z" fill="#0056ff"/><path d="M564.401 3e2C544.386 3e2 531.877 278.333 541.884 261L685.356 12.5C689.822 4.76496 698.075.0 707.006.0H808.29C844.017.0 877.03 19.06 894.893 50.0001L1125.83 450C1143.7 480.94 1143.7 519.06 1125.83 550L894.893 950C877.03 980.94 844.017 1e3 808.29 1e3H622.214C602.199 1e3 589.69 978.333 599.697 961L750.385 7e2H750.555L854.478 520C861.624 507.624 861.624 492.376 854.478 480L762.102 320C754.957 307.624 741.752 3e2 727.461 3e2H564.401z" fill="#0056ff"/></svg></span><span class="text-uppercase font-weight-bold">KubeCube</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/kubecube-io/kubecube target=_blank><i class="fab fa-github"></i><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.d5a631f6a2fe4c00c21a0bc429b81434.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/installation-guide/>返回本页常规视图</a>.</p></div><h1 class=title>部署指南</h1><ul><li>1: <a href=#pg-1db6edd6ea06d95f092948473e91f961>部署环境要求</a></li><li>2: <a href=#pg-4d204e9e5bd3da0ca89e446e6b92c8eb>All In One 部署与卸载</a></li><ul><li>2.1: <a href=#pg-08933b7460d7630abd403690ae9f10fb>All In One 最小化部署</a></li><li>2.2: <a href=#pg-f5f4eb2582bf7ec36d3370250c4ec4eb>KubeCube 卸载</a></li></ul><li>3: <a href=#pg-0fc44567756687c9fc0e863420976344>在已有K8s上安装KubeCube</a></li><ul><li>3.1: <a href=#pg-e0eaf92f584e438d8277852417c6b73e>通过helm安装KubeCube</a></li><li>3.2: <a href=#pg-7b3804f475defb37c78e27f237d7cc55>通过helm纳管计算集群</a></li></ul><li>4: <a href=#pg-5cd11c4386cdd813ea44f265111ca998>使用 hotplug 进行拓展</a></li><ul><li>4.1: <a href=#pg-977ffb45b18fb46ee7dd11d61361b0c5>热插拔 hotplug 介绍</a></li><li>4.2: <a href=#pg-e5c4b79249b72e99aff5fcc2509bd82b>通过 hotplug 启用 loggie</a></li></ul><li>5: <a href=#pg-7263e2ee7d94ec732c15e1568eb9d37b>使用脚本安装 K8s 和 KubeCube（已废弃）</a></li><ul><li>5.1: <a href=#pg-b4ac3dd0b7273167a4f6705340dde559>在已有k8s集群中部署KubeCube</a></li><li>5.2: <a href=#pg-469146c7da53fc89b2cdee767dc42a17>添加计算集群</a></li><li>5.3: <a href=#pg-9386b1f1894cc0d652343df9e3381b02>添加节点</a></li><li>5.4: <a href=#pg-24ba84ef2eb4b3562bfa9994a3e59a3d>多节点高可用部署</a></li></ul><li>6: <a href=#pg-6818a5107747076ce7e60a61671c142d>已有系统接入</a></li><ul><li>6.1: <a href=#pg-55566b3f6f2b6ad97ca706cd58808143>Prometheus</a></li><li>6.2: <a href=#pg-3fdb9f53fbdf958554148e74555fe462>ElasticSearch</a></li><li>6.3: <a href=#pg-61cda61016ee5895ec364823d66746b2>第三方认证系统</a></li></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-1db6edd6ea06d95f092948473e91f961>1 - 部署环境要求</h1><p>在进行 All In One 或者多节点部署之前，请按照以下内容确认环境要求</p><h1 id=系统版本及硬件要求>系统版本及硬件要求</h1><table><thead><tr><th style=text-align:left>操作系统</th><th style=text-align:left>最低要求</th></tr></thead><tbody><tr><td style=text-align:left><strong>Ubuntu</strong> <em>16.04, 18.04</em></td><td style=text-align:left>CPU：4 核，内存：8 G，磁盘空间：20 G</td></tr><tr><td style=text-align:left><strong>Debian</strong> <em>Buster, Stretch</em></td><td style=text-align:left>CPU：4 核，内存：8 G，磁盘空间：20 G</td></tr><tr><td style=text-align:left><strong>CentOS</strong> <em>7</em>.x</td><td style=text-align:left>CPU：4 核，内存：8 G，磁盘空间：20 G</td></tr><tr><td style=text-align:left><strong>Kylin</strong> <em>v10</em></td><td style=text-align:left>CPU：4 核，内存：8 G，磁盘空间：20 G</td></tr></tbody></table><table><thead><tr><th style=text-align:left>OS ARCH</th><th style=text-align:left>硬件要求</th></tr></thead><tbody><tr><td style=text-align:left><strong>AMD 64</strong></td><td style=text-align:left>Intel 系列，AMD 系列</td></tr><tr><td style=text-align:left><strong>ARM 64</strong></td><td style=text-align:left>Phytium 2000（国产化arm64芯片理论上都支持，但未经过充分测试）</td></tr></tbody></table><blockquote><p>以上系统配置要求适用于 KubeCube 默认最小化 All In One 模式安装，如需启动更多可插拔组件和拓展功能，建议机器配置为 8 核 CPU 和 16 G 内存</p></blockquote><h1 id=依赖说明>依赖说明</h1><table><thead><tr><th>KubeCube</th><th>Kubernetes</th><th>Docker</th><th>Containerd</th></tr></thead><tbody><tr><td>v1.0 ~ v1.4</td><td>v1.18 ~ v1.23</td><td>19.3.12+</td><td>1.5.x</td></tr></tbody></table><h2 id=容器运行时>容器运行时</h2><ul><li><p>KubeCube 支持的 cri 跟随 Kubernetes 标准</p></li><li><p>KubeCube 部署脚本支持的 cri 如下：</p></li></ul><table><thead><tr><th style=text-align:left>支持的容器运行时</th><th style=text-align:left>版本</th></tr></thead><tbody><tr><td style=text-align:left>Docker</td><td style=text-align:left>19.3.12+</td></tr><tr><td style=text-align:left>Containerd</td><td style=text-align:left>1.5.x</td></tr></tbody></table><blockquote><p>节点上若无容器运行时，部署脚本将自动安装 containerd 1.5.5 作为容器运行时</p></blockquote><h2 id=网络插件>网络插件</h2><ul><li><p>KubeCube 支持的 cni 跟随 Kubernetes 标准</p></li><li><p>KubeCube 部署脚本的 cni 目前支持 calico</p></li></ul><h2 id=kubernetes-版本>Kubernetes 版本</h2><p>KubeCube 支持的 k8s 版本为 v1.18 ~ v1.26
KubeCube 部署脚本支持的 k8s 版本为 v1.18.20、v1.19.13、v1.20.9、v1.21.2、v1.22.2、v1.23.5、v1.24.7、v1.25.3、v1.26.0</p><h2 id=关于-k8s-集群安装>关于 K8s 集群安装</h2><p>KubeCube 的 All In One 安装脚本提供单节点的 K8s 集群安装。如果需要自定义安装 K8s 集群，可以使用 kubeadm、<a href=https://github.com/gopixiu-io/kubez-ansible>kubez-ansible</a> 等开源工具，之后 kubez-ansible 中也会集成 KubeCube。</p><h1 id=前置准备>前置准备</h1><p>在使用 All In One 部署脚本开始 KubeCube 的安装时，脚本会检测环境，并提示需要安装缺失的依赖</p><p><img src=/imgs/installation-guide/requirement/env-check.png alt=env-check></p><h1 id=监控组件说明>监控组件说明</h1><p>KubeCube 会默认安装 Prometheus 等监控组件，如果选择在已有k8s集群中部署 KubeCube，并且集群中已安装 Mertics Server，安装 KubeCube 后 Prometheus 会和 Mertics Server 产生冲突，导致监控功能不可用。需要在安装 KubeCube 后执行以下步骤：</p><ol><li><p>点击页面右上角【切换到控制台】，点击任意空间，进入到控制台页面；</p></li><li><p>在左侧菜单栏点击【自定义资源CRD】，进入到集群级别 CRD 列表，可以点击右上方输入 “hotplug” 进行搜索，找到 “hotplugs.hotplug.kubecube.io” CRD，点击【v1】版本进入 CRD 详情页；</p></li><li><p>选择 common 实例，点击【设置YAML】，找到 spec.component. name=kubecube-monitoring，添加环境变量 prometheusAdapter.enabled=false，如：</p></li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      grafana:
</span><span style=color:#8f5902;font-style:italic>        enabled: false
</span><span style=color:#8f5902;font-style:italic>      prometheus:
</span><span style=color:#8f5902;font-style:italic>        prometheusSpec:
</span><span style=color:#8f5902;font-style:italic>          externalLabels:
</span><span style=color:#8f5902;font-style:italic>            cluster: &#34;{{.cluster}}&#34;
</span><span style=color:#8f5902;font-style:italic>          remoteWrite:
</span><span style=color:#8f5902;font-style:italic>          - url: http://10.173.32.129:31291/api/v1/receive
</span><span style=color:#8f5902;font-style:italic>      prometheusAdapter:</span><span style=color:#f8f8f8;text-decoration:underline>      
</span><span style=color:#f8f8f8;text-decoration:underline>  			</span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring-15.4.10.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4d204e9e5bd3da0ca89e446e6b92c8eb>2 - All In One 部署与卸载</h1></div><div class=td-content><h1 id=pg-08933b7460d7630abd403690ae9f10fb>2.1 - All In One 最小化部署</h1><p>对于想要快速开始、快速体验的用户来说，All In One 是最佳的安装方式。All In One 部署脚本将会在执行该脚本的节点上，安装一个单节点的 K8s 集群，并在该 K8s 集群上部署 KubeCube。</p><h2 id=v18x>v1.8.x</h2><h3 id=在-linux-上部署-kubecube>在 Linux 上部署 KubeCube</h3><h4 id=开始安装>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.8
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/release/v1.3/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h3 id=等待部署完成>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/completed-deploy.png alt=completed-deploy></p><h3 id=使用-admin-账户登陆-console>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p><h2 id=v14x>v1.4.x</h2><h3 id=在-linux-上部署-kubecube-1>在 Linux 上部署 KubeCube</h3><h4 id=开始安装-1>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.4
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h3 id=等待部署完成-1>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/completed-deploy.png alt=completed-deploy></p><h3 id=使用-admin-账户登陆-console-1>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p><h2 id=v12x>v1.2.x</h2><h3 id=在-linux-上部署-kubecube-2>在 Linux 上部署 KubeCube</h3><h4 id=开始安装-2>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.2
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h3 id=等待部署完成-2>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/completed-deploy.png alt=completed-deploy></p><h3 id=使用-admin-账户登陆-console-2>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p><h2 id=v11x>v1.1.x</h2><h3 id=在-linux-上部署-kubecube-3>在 Linux 上部署 KubeCube</h3><h4 id=开始安装-3>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.1
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h3 id=等待部署完成-3>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/completed-deploy.png alt=completed-deploy></p><h3 id=使用-admin-账户登陆-console-3>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p><h2 id=v10x>v1.0.x</h2><h3 id=在-linux-上部署-kubecube-4>在 Linux 上部署 KubeCube</h3><h4 id=开始安装-4>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h3 id=等待部署完成-4>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/completed-deploy.png alt=completed-deploy></p><h3 id=使用-admin-账户登陆-console-4>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f5f4eb2582bf7ec36d3370250c4ec4eb>2.2 - KubeCube 卸载</h1><p>KubeCube 提供一键卸载脚本</p><p>⚠️ 注意，卸载脚本仅用于使用 All In One 部署脚本安装的环境，不应该用于任何正式环境</p><h2 id=下载卸载脚本>下载卸载脚本</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -o cleanup.sh https://kubecube.nos-eastchina1.126.net/hack/cleanup.sh
</code></pre></div><h2 id=一键卸载>一键卸载</h2><p>一键卸载按顺序卸载 kubecube, kubernetes 和 docker</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/bin/bash cleanup.sh all
</code></pre></div><h2 id=指定卸载>指定卸载</h2><p>卸载脚本可以指定卸载对象，但需注意卸载依赖</p><h3 id=卸载-kubecube>卸载 KubeCube</h3><p>删除 kubecube chart release，并清理 kubecube 在本机上的相关文件</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/bin/bash cleanup.sh kubecube
</code></pre></div><h3 id=卸载-kubernetes>卸载 Kubernetes</h3><p>卸载 kubernetes 集群，并清理 kubernetes 在本机上的相关文件</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/bin/bash cleanup.sh k8s
</code></pre></div><h3 id=卸载-docker>卸载 Docker</h3><p>卸载 docker，并清理 docker 在本机上的相关文件</p><p>⚠️注意：需在卸载 kubernetes 后才能卸载 docker，不然会造成 kubernetes 集群异常</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/bin/bash cleanup.sh docker
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0fc44567756687c9fc0e863420976344>3 - 在已有K8s上安装KubeCube</h1></div><div class=td-content><h1 id=pg-e0eaf92f584e438d8277852417c6b73e>3.1 - 通过helm安装KubeCube</h1><p>通过 helm 的方式在管控集群中部署 KubeCube</p><h2 id=v18x>v1.8.x</h2><h3 id=要求>要求</h3><ol><li>已有 K8s 集群环境</li><li>helm v3 客户端</li></ol><h3 id=下载-kubecube-helm-chart-包>下载 KubeCube helm chart 包</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.8
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -s https://kubecube.nos-eastchina1.126.net/kubecube-chart/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/kubecube-chart.tar.gz <span style=color:#000;font-weight:700>|</span> tar -xz
</code></pre></div><h3 id=通过-helm-在管控集群上安装-kubecube>通过 helm 在管控集群上安装 KubeCube</h3><p>创建 pivot-value.yaml 文件并填写必要的 value 值</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># pivot-value.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 管控集群的 Node IP，用来暴露 KubeCube 的 NodePort service</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>nodeIP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x.x.x.x</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dependencesEnable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ingressController</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 如果集群中没有部署 ingress controller，请将此设置为 &#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>localPathStorage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 如果集群中没有部署 local path storage，请将此设置为 &#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metricServer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># # 如果集群中没有部署 metric server，请将此设置为 &#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 如果要启动日志功能，请假以下值设置为 &#34;enabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hotPlugEnable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pivot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>logseer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;disabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>logagent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;disabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>elasticsearch</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;disabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>localKubeConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xx</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 管控集群的 kubeconfig 的 base64</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>pivotKubeConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xx</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 管控集群的 kubeconfig 的 base64</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>warden</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>warden</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>args</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;pivot-cluster&#34;</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 管控集群名</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>部署 KubeCube</p><p><code>helm install kubecube -n kubecube-system --create-namespace ./kubecube-chart -f ./pivot-value.yaml</code></p><h3 id=卸载管控集群中的-kubecube>卸载管控集群中的 KubeCube</h3><p>注意：<code>not found</code> 错误可以被忽略</p><ol><li>手动清理 webhook</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete validatingwebhookconfigurations kubecube-validating-webhook-configuration warden-validating-webhook-configuration kubecube-monitoring-admission
</code></pre></div><ol start=2><li>卸载 KubeCube chart</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm uninstall kubecube -n kubecube-system
</code></pre></div><ol start=3><li>清理残留资源</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete sa/kubecube-pre-job -n kubecube-system
kubectl delete clusterRole/kubecube-pre-job 
kubectl delete clusterRoleBinding/kubecube-pre-job
kubectl delete ns kubecube-system hnc-system kubecube-monitoring
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7b3804f475defb37c78e27f237d7cc55>3.2 - 通过helm纳管计算集群</h1><p>使用 helm 的方式在计算集群中安装 Warden（KubeCube 的计算集群 agent），安装完成后，Warden 将主动向管控集群的 KubeCube 注册计算集群信息，完成计算集群的纳管。</p><h2 id=v18x>v1.8.x</h2><h3 id=要求>要求</h3><ol><li>已有 K8s 集群环境</li><li>helm v3 客户端</li></ol><h3 id=下载-kubecube-helm-chart-包>下载 KubeCube helm chart 包</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.8
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -s https://kubecube.nos-eastchina1.126.net/kubecube-chart/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/kubecube-chart.tar.gz <span style=color:#000;font-weight:700>|</span> tar -xz
</code></pre></div><h3 id=通过-helm-在计算集群上安装-warden>通过 helm 在计算集群上安装 Warden</h3><p>创建 member-value.yaml 文件并填写必要的 value 值</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># member-value.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 管控集群的 Node IP，用来暴露 KubeCube 的 NodePort service</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>nodeIP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>x.x.x.x</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>dependencesEnable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>ingressController</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 如果集群中没有部署 ingress controller，请将此设置为 true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>localPathStorage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 如果集群中没有部署 local path storage，请将此设置为 true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metricServer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># # 如果集群中没有部署 metric server，请将此设置为 true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 以下为计算集群指定安装组件，请不要修改</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>componentsEnable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubecube</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>warden</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>audit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>webconsole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cloudshell</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>frontend</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 如果要启动日志功能，请假以下值设置为 &#34;enabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hotPlugEnable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>common</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>logagent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;disabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>localKubeConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xx</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 当前集群的 kubeconfig 的 base64</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>pivotKubeConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>xx</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># 管控集群的 kubeconfig 的 base64</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>warden</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>warden</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>args</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>inMemberCluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;member-cluster&#34;</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># 集群集群名</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>部署 Warden</p><p><code>helm install warden -n kubecube-system --create-namespace ./kubecube-chart -f ./pivot-value.yaml</code></p><h3 id=卸载计算集群中的-warden>卸载计算集群中的 warden</h3><p>注意：<code>not found</code> 错误可以被忽略</p><ol><li>在管控面删除 cluster cr</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete cluster <span style=color:#ce5c00;font-weight:700>{</span>计算集群名<span style=color:#ce5c00;font-weight:700>}</span> 
</code></pre></div><ol start=2><li>在计算集群手动清理 webhook</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete validatingwebhookconfigurations kubecube-validating-webhook-configuration warden-validating-webhook-configuration kubecube-monitoring-admission
</code></pre></div><ol start=3><li>在计算集群卸载 warden chart</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm uninstall warden -n kubecube-system
</code></pre></div><ol start=4><li>再计算集群清理残留资源</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl delete sa/kubecube-pre-job -n kubecube-system
kubectl delete clusterRole/kubecube-pre-job 
kubectl delete clusterRoleBinding/kubecube-pre-job
kubectl delete ns kubecube-system hnc-system kubecube-monitoring
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5cd11c4386cdd813ea44f265111ca998>4 - 使用 hotplug 进行拓展</h1></div><div class=td-content><h1 id=pg-977ffb45b18fb46ee7dd11d61361b0c5>4.1 - 热插拔 hotplug 介绍</h1><p>热插拔是通过修改配置文件实现不停机更新监控、日志、审计等组件的启停和配置。</p><h2 id=热插拔>热插拔</h2><p>热插拔的实现是基于 helm ，因此集群需要预先安装好 helm3 版本。</p><p>登录管控 k8s 集群，执行命令可以查看热插拔配置</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># kubectl get hotplug</span>
NAME            PHASE     AGE
common          running   23h
pivot-cluster   running   16d
</code></pre></div><p>其中：</p><ul><li><p><code>common</code> 表示公共的热插拔配置，<code>pivot-cluster</code> 表示 pivot-cluster 这个 k8s 集群的热插拔配置。</p></li><li><p>允许自定义各个集群的热插拔配置覆盖 common 热插拔配置实现个性化配置 k8s 集群组件热插拔。</p></li><li><p>热插拔配置的 <code>.metadata.name</code> 要求与k8s集群名称一致，所有 k8s 集群信息查看命令为 <code>kubectl get cluster</code>。</p></li></ul><h2 id=common配置说明>Common配置说明</h2><p>目前，默认的 common 配置包括以下几个组件：</p><p><code>logseer</code>：日志管理组件，仅在管控集群安装</p><p><code>logagent</code>：日志采集代理组件</p><p><code>kubecube-monitoring</code>：监控 prometheuse 组件</p><p><code>kubecube-thanos</code>：监控 thanos 组件，仅在管控集群安装</p><p>示例如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hotplug.kubecube.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hotplug</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubecube.io/sync</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>					</span><span style=color:#8f5902;font-style:italic>## 同步信号，kubecube会将这个配置同步到各个集群</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>common                                 </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 公共配置为cmmon，其余集群特殊配置为集群名字</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>component</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>audit                                </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 审计日志</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer                              </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 日志管理组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer-v1.0.0.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled                           </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 启停标识：这里disabled为禁用</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logagent                             </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 日志采集代理组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logagent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logagent-v1.0.0.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled                            </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 启停标识：这里enabled为启用</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>|                                     </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 环境变量</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>clustername</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{.cluster}}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#8f5902;font-style:italic>## {{.cluster}} 程序会自动注入集群名字替换</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring                  </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 监控组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring-15.4.7.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      grafana:
</span><span style=color:#8f5902;font-style:italic>        enabled: false
</span><span style=color:#8f5902;font-style:italic>      prometheus:
</span><span style=color:#8f5902;font-style:italic>        prometheusSpec:
</span><span style=color:#8f5902;font-style:italic>          externalLabels:
</span><span style=color:#8f5902;font-style:italic>            cluster: &#34;{{.cluster}}&#34;
</span><span style=color:#8f5902;font-style:italic>          remoteWrite:
</span><span style=color:#8f5902;font-style:italic>          - url: http://10.173.32.42:31291/api/v1/receive</span><span style=color:#f8f8f8;text-decoration:underline>      
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-thanos                      </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 监控thanos组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thanos-3.18.0.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>                                         </span><span style=color:#8f5902;font-style:italic>## message显示各个组件运行状态，phase显示总体运行状态</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{&#34;kubecube-monitoring&#34;:&#34;release is running&#34;,&#34;kubecube-thanos&#34;:&#34;release    
</span><span style=color:#4e9a06>    is running&#34;,&#34;logagent&#34;:&#34;release is running&#34;,&#34;logseer&#34;:&#34;release is running&#34;}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>phase</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>running</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>每一个组件基本包含5个要素，在 <code>spec.component</code> 下：</p><p>name：组件名称</p><p>namespace：指定组件部署的命名空间，若指定的命名空间不存在，会自动以该字段值去创建一个命名空间。</p><p>pkgName：安装包名称，安装包默认存放路径为 warden 容器里的 /root/helmchartpkg，以 emptydir 形式存在。</p><p>status：组件是否启用</p><p>env：环境变量配置</p><p>每一个要素都可以使用集群独特配置进行覆盖，未覆盖的要素则依然使用 common 里的配置。</p><h2 id=管控集群配置说明>管控集群配置说明</h2><p>Pivot-cluster 配置是管控集群配置，即 KubeCube 所在的集群。集群独特的配置会与 common 的配置结合，用于个性化配置集群组件，结合时遇到相同字段pivot-cluster 优先。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hotplug.kubecube.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hotplug</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubecube.io/sync</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic>## 同步信号，kubecube会将这个配置同步到其他集群</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster                  </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 与集群名字一致，指明这是pivot-cluster这个集群的热插拔配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>component</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer                      </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 日志管理组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled                    </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 结合common设置为disabled，这里设置为enabled，标识其余集群不启用，pivot-cluster集群启用</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      grafana:
</span><span style=color:#8f5902;font-style:italic>        enabled: true
</span><span style=color:#8f5902;font-style:italic>      prometheus:
</span><span style=color:#8f5902;font-style:italic>        prometheusSpec:
</span><span style=color:#8f5902;font-style:italic>          externalLabels:
</span><span style=color:#8f5902;font-style:italic>            cluster: &#34;{{.cluster}}&#34;
</span><span style=color:#8f5902;font-style:italic>          remoteWrite:
</span><span style=color:#8f5902;font-style:italic>          - url: http://thanos-receive:19291/api/v1/receive</span><span style=color:#f8f8f8;text-decoration:underline>      
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-thanos</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      receive:
</span><span style=color:#8f5902;font-style:italic>        replicaCount: 1
</span><span style=color:#8f5902;font-style:italic>        replicationFactor: 1</span><span style=color:#f8f8f8;text-decoration:underline>      
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{&#34;kubecube-monitoring&#34;:&#34;release is running&#34;,&#34;kubecube-thanos&#34;:&#34;release
</span><span style=color:#4e9a06>    is running&#34;,&#34;logagent&#34;:&#34;release is running&#34;,&#34;logseer&#34;:&#34;release is running&#34;}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>phase</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>running</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e5c4b79249b72e99aff5fcc2509bd82b>4.2 - 通过 hotplug 启用 loggie</h1><p>KubeCube 使用 hotplug 热插拔方式集成 Loggie，用户可以通过打开 hotplug 中关于日志部分的开关来开启 Loggie。我们有两个时间点可以用来开启 Loggie。</p><h2 id=在使用-helm-安装-kubecube-时>在使用 Helm 安装 KubeCube 时</h2><p>在使用 Helm 安装 KubeCube 时，我们可以设置以下 values 来开启 Loggie。</p><p>安装管控集群时的参数如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># pivot-value.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># set &#34;enabled&#34; if wanna open log application.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hotPlugEnable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pivot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>logseer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;enabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline> 
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>logagent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;enabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>elasticsearch</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;enabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>安装计算集群时的参数如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic># member-value.yaml</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>global</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>    
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># set &#34;enabled&#34; if wanna open log application.</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>hotPlugEnable</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>common</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>logagent</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;enabled&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>...</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=在使用过程中>在使用过程中</h2><p>在使用过程中，我们也可以通过直接修改 hotplug 的方式来开启 Loggie。</p><p>修改管控集群的 hotplug 如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl edit hotplug pivot-cluster

<span style=color:#8f5902;font-style:italic># pivot-cluster</span>
apiVersion: hotplug.kubecube.io/v1
kind: Hotplug
metadata:
  name: pivot-cluster
spec:
  component:
  - name: elasticsearch
    namespace: elasticsearch
    pkgName: elasticsearch-7.8.1.tgz
    status: enabled <span style=color:#8f5902;font-style:italic># 将该值设为 enabled 来开启日志</span>
...
  - name: logseer
    status: enabled <span style=color:#8f5902;font-style:italic># 将该值设为 enabled 来开启日志</span>
  - name: logagent
    status: enabled <span style=color:#8f5902;font-style:italic># 将该值设为 enabled 来开启日志</span>
</code></pre></div><p>修改计算集群的 hotplug 如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl edit hotplug common

<span style=color:#8f5902;font-style:italic># common</span>
apiVersion: hotplug.kubecube.io/v1
kind: Hotplug
metadata:
  name: common
spec:
  component:
...
  - env: <span style=color:#000;font-weight:700>|</span>
      clustername: <span style=color:#4e9a06>&#34;{{.cluster}}&#34;</span>
      elasticsearch:
        address: x.x.x.x:32200 <span style=color:#8f5902;font-style:italic># 填写管控集群的 es 的 nodeport svc 访问地址，一般为 {nodeIP}:32200</span>
    name: logagent
    namespace: logagent
    pkgName: logagent-1.3.0.tgz
    status: enabled <span style=color:#8f5902;font-style:italic># 将该值设为 enabled 来开启日志</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-7263e2ee7d94ec732c15e1568eb9d37b>5 - 使用脚本安装 K8s 和 KubeCube（已废弃）</h1></div><div class=td-content><h1 id=pg-b4ac3dd0b7273167a4f6705340dde559>5.1 - 在已有k8s集群中部署KubeCube</h1><h2 id=v14x>v1.4.x</h2><h3 id=在-kubernetes-集群中部署-kubecube>在 Kubernetes 集群中部署 KubeCube</h3><h4 id=开始安装>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.4
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h4 id=设置安装脚本参数>设置安装脚本参数</h4><p>该安装模式下，需要修改以下参数：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;docker&#34;</span>
</code></pre></div><h3 id=等待部署完成>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/complete-deploy.png alt=complete-deploy></p><h3 id=使用-admin-账户登陆-console>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p><h2 id=v12x>v1.2.x</h2><h3 id=在-kubernetes-集群中部署-kubecube-1>在 Kubernetes 集群中部署 KubeCube</h3><h4 id=开始安装-1>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.2
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h4 id=设置安装脚本参数-1>设置安装脚本参数</h4><p>该安装模式下，需要修改以下参数：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h3 id=等待部署完成-1>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/complete-deploy.png alt=complete-deploy></p><h3 id=使用-admin-账户登陆-console-1>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p><h2 id=v11x>v1.1.x</h2><h3 id=在-kubernetes-集群中部署-kubecube-2>在 Kubernetes 集群中部署 KubeCube</h3><h4 id=开始安装-2>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.1
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h4 id=设置安装脚本参数-2>设置安装脚本参数</h4><p>该安装模式下，需要修改以下参数：</p><p>INSTALL_KUBECUBE_MEMBER=&ldquo;false&rdquo;</p><p>MASTER_IP="${node ip}"</p><blockquote><p>${node ip} 表示你运行脚本所在 node 机器的 ip，该 node 需要可操作 kubectl</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</code></pre></div><h3 id=等待部署完成-2>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/complete-deploy.png alt=complete-deploy></p><h3 id=使用-admin-账户登陆-console-2>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p><h2 id=v10x>v1.0.x</h2><h3 id=在-kubernetes-集群中部署-kubecube-3>在 Kubernetes 集群中部署 KubeCube</h3><h4 id=修改-kubernetes-api-server-配置>⚠️修改 Kubernetes API-Server 配置</h4><p><strong>必要性</strong></p><ol><li><p>KubeCube 对多集群提供统一的认证和鉴权服务，需要使用 k8s api-server 的 auth-webhook 能力来做拓展。</p></li><li><p>KubeCube 提供对 k8s-apiserver 日志进行审计的能力，这需要为 k8s api-server 指定审计服务后端。</p></li></ol><p><strong>修改操作</strong></p><p>如果您的 k8s api-server 服务是以 deployment 形式运行的，请直接修改 deployment ；如果您的 k8s api-server 服务是以 static pod 形式运行的，您需要修改对应的 manifest 文件，它的文件路径通常为 <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> ，修改内容如下：</p><pre><code>apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
    - command:
        - kube-apiserver
        - --audit-log-format=json
        - --audit-log-maxage=10
        - --audit-log-maxbackup=10
        - --audit-log-maxsize=100
        - --audit-log-path=/var/log/audit
        - --audit-policy-file=/etc/cube/audit/audit-policy.yaml
        - --audit-webhook-config-file=/etc/cube/audit/audit-webhook.config
        - --authentication-token-webhook-config-file=/etc/cube/warden/webhook.config
      name: kube-apiserver
      volumeMounts:
        - mountPath: /var/log/audit
          name: audit-log
        - mountPath: /etc/cube
          name: cube
          readOnly: true
  volumes:
    - hostPath:
        path: /var/log/audit
        type: DirectoryOrCreate
      name: audit-log
    - hostPath:
        path: /etc/cube
        type: DirectoryOrCreate
      name: cube
</code></pre><h4 id=开始安装-3>开始安装</h4><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h4 id=设置安装脚本参数-3>设置安装脚本参数</h4><p>该安装模式下，需要修改以下参数：</p><p>INSTALL_KUBECUBE_MEMBER=&ldquo;false&rdquo;</p><p>MASTER_IP="${node ip}"</p><blockquote><p>${node ip} 表示你运行脚本所在 node 机器的 ip，该 node 需要可操作 kubectl</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;x.x.x.x&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h3 id=等待部署完成-3>等待部署完成</h3><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/complete-deploy.png alt=complete-deploy></p><h3 id=使用-admin-账户登陆-console-3>使用 admin 账户登陆 console</h3><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p></div><div class=td-content style=page-break-before:always><h1 id=pg-469146c7da53fc89b2cdee767dc42a17>5.2 - 添加计算集群</h1><p>KubeCube 可以添加其它集群作为计算集群，前提是，计算集群能够访问管控集群的 k8s api-server 和 KubeCube，默认情况下 KubeCube 使用 NodePort 对外暴露服务，用户可自行使用 ingress 进行暴露</p><h2 id=v14x>v1.4.x</h2><h3 id=方式一部署新集群并添加>方式一：部署新集群并添加</h3><p>在 linux 机器上，需要构建 Kubernetes 集群并安装 KubeCube 依赖项</p><h4 id=开始安装>开始安装</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.4
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h4 id=设置安装脚本参数>设置安装脚本参数</h4><p>该安装模式下，需要修改以下参数：</p><p>INSTALL_KUBECUBE_PIVOT=&ldquo;false&rdquo;</p><p>INSTALL_KUBECUBE_MEMBER=&ldquo;true&rdquo;</p><p>INSTALL_KUBERNETES=&ldquo;true&rdquo;</p><p>MEMBER_CLUSTER_NAME=&ldquo;member-1&rdquo;</p><p>MASTER_IP="${node ip}"</p><p>KUBECUBE_HOST="${pivot node ip}"</p><blockquote><p>MEMBER_CLUSTER_NAME 表示计算集群的名字，注意，不能与已有的计算集群名称同名,
${node ip} 表示你运行脚本所在 node 机器的 ip，该 node 需要可操作 kubectl,
${pivot node ip} 表示管控集群 node 机器的 ip，用于向 KubeCube 注册集群</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;member-1&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;docker&#34;</span>
</code></pre></div><h3 id=方式二纳管已有集群>方式二：纳管已有集群</h3><p>添加已有集群只需从 console 页面导入集群信息即可</p><h4 id=在-console-页面中导入集群信息>在 console 页面中导入集群信息</h4><p><img src=/imgs/installation-guide/add-member-k8s/add-member-cluster.png alt=add-member-cluster></p><h3 id=在-console-中确认新集群>在 console 中确认新集群</h3><p><img src=/imgs/installation-guide/add-member-k8s/check-cluster.png alt=check-cluster></p><h2 id=v12x>v1.2.x</h2><h3 id=方式一部署新集群并添加-1>方式一：部署新集群并添加</h3><p>在 linux 机器上，需要构建 Kubernetes 集群并安装 KubeCube 依赖项</p><h4 id=开始安装-1>开始安装</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.2
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h4 id=设置安装脚本参数-1>设置安装脚本参数</h4><p>该安装模式下，需要修改以下参数：</p><p>INSTALL_KUBECUBE_PIVOT=&ldquo;false&rdquo;</p><p>INSTALL_KUBECUBE_MEMBER=&ldquo;true&rdquo;</p><p>INSTALL_KUBERNETES=&ldquo;true&rdquo;</p><p>MEMBER_CLUSTER_NAME=&ldquo;member-1&rdquo;</p><p>MASTER_IP="${node ip}"</p><p>KUBECUBE_HOST="${pivot node ip}"</p><blockquote><p>MEMBER_CLUSTER_NAME 表示计算集群的名字，注意，不能与已有的计算集群名称同名,
${node ip} 表示你运行脚本所在 node 机器的 ip，该 node 需要可操作 kubectl,
${pivot node ip} 表示管控集群 node 机器的 ip，用于向 KubeCube 注册集群</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;member-1&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h3 id=方式二纳管已有集群-1>方式二：纳管已有集群</h3><p>添加已有集群只需从 console 页面导入集群信息即可</p><h4 id=在-console-页面中导入集群信息-1>在 console 页面中导入集群信息</h4><p><img src=/imgs/installation-guide/add-member-k8s/add-member-cluster.png alt=add-member-cluster></p><h3 id=在-console-中确认新集群-1>在 console 中确认新集群</h3><p><img src=/imgs/installation-guide/add-member-k8s/check-cluster.png alt=check-cluster></p><h2 id=v11x>v1.1.x</h2><h3 id=方式一部署新集群并添加-2>方式一：部署新集群并添加</h3><p>在 linux 机器上，需要构建 Kubernetes 集群并安装 KubeCube 依赖项</p><h4 id=开始安装-2>开始安装</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.1
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h4 id=设置安装脚本参数-2>设置安装脚本参数</h4><p>该安装模式下，需要修改以下参数：</p><p>INSTALL_KUBECUBE_PIVOT=&ldquo;false&rdquo;</p><p>INSTALL_KUBECUBE_MEMBER=&ldquo;true&rdquo;</p><p>INSTALL_KUBERNETES=&ldquo;true&rdquo;</p><p>MEMBER_CLUSTER_NAME=&ldquo;member-1&rdquo;</p><p>MASTER_IP="${node ip}"</p><p>KUBECUBE_HOST="${pivot node ip}"</p><blockquote><p>MEMBER_CLUSTER_NAME 表示计算集群的名字，注意，不能与已有的计算集群名称同名,
${node ip} 表示你运行脚本所在 node 机器的 ip，该 node 需要可操作 kubectl,
${pivot node ip} 表示管控集群 node 机器的 ip，用于向 KubeCube 注册集群</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;member-1&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</code></pre></div><h3 id=方式二纳管已有集群-2>方式二：纳管已有集群</h3><p>添加已有集群只需从 console 页面导入集群信息即可</p><h4 id=在-console-页面中导入集群信息-2>在 console 页面中导入集群信息</h4><p><img src=/imgs/installation-guide/add-member-k8s/add-member-cluster.png alt=add-member-cluster></p><h3 id=在-console-中确认新集群-2>在 console 中确认新集群</h3><p><img src=/imgs/installation-guide/add-member-k8s/check-cluster.png alt=check-cluster></p><h2 id=v10x>v1.0.x</h2><h3 id=方式一部署新集群并添加-3>方式一：部署新集群并添加</h3><p>在 linux 机器上，需要构建 Kubernetes 集群并安装 KubeCube 依赖项</p><h4 id=开始安装-3>开始安装</h4><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h4 id=设置安装脚本参数-3>设置安装脚本参数</h4><p>该安装模式下，需要修改以下参数：</p><p>INSTALL_KUBECUBE_PIVOT=&ldquo;false&rdquo;</p><p>INSTALL_KUBECUBE_MEMBER=&ldquo;true&rdquo;</p><p>INSTALL_KUBERNETES=&ldquo;true&rdquo;</p><p>MEMBER_CLUSTER_NAME=&ldquo;member-1&rdquo;</p><p>MASTER_IP="${node ip}"</p><p>KUBECUBE_HOST="${pivot node ip}"</p><blockquote><p>MEMBER_CLUSTER_NAME 表示计算集群的名字，注意，不能与已有的计算集群名称同名
${node ip} 表示你运行脚本所在 node 机器的 ip，该 node 需要可操作 kubectl
${pivot node ip} 表示管控集群 node 机器的 ip，用于向 KubeCube 注册集群</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;member-1&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;x.x.x.x&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h3 id=方式二纳管已有集群-3>方式二：纳管已有集群</h3><p>添加已有集群需要从 console 页面获取添加集群的定制脚本</p><h4 id=在-console-页面中获取添加集群的脚本>在 console 页面中获取添加集群的脚本</h4><p><img src=/imgs/installation-guide/add-member-k8s/add-member-cluster.png alt=add-member-cluster></p><h4 id=使用脚本添加集群>使用脚本添加集群</h4><p>在集群的 node 机器上，使用从 console 中下载的脚本，该机器需要能够执行 kubectl</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/bin/bash add_cluster.sh
</code></pre></div><h3 id=等待集群添加完成>等待集群添加完成</h3><p><img src=/imgs/installation-guide/add-member-k8s/add-cluster.png alt=add-cluster></p><h3 id=在-console-中确认新集群-3>在 console 中确认新集群</h3><p><img src=/imgs/installation-guide/add-member-k8s/check-cluster.png alt=check-cluster></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9386b1f1894cc0d652343df9e3381b02>5.3 - 添加节点</h1><p>KubeCube 提供为已有集群添加节点的能力，同时也支持使用 kubeadm 的原生方式添加节点</p><p>⚠️ 注意通过 KubeCube 的脚本添加节点时，node 机器需要能够通过 ssh 访问 master 机器，支持公钥和密码两种 ssh 方式，执行脚本前可以在 node 上 ssh 到 master 测试连通性</p><h2 id=v14x>v1.4.x</h2><h3 id=向集群添加工作节点>向集群添加工作节点</h3><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.4
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入集群</p><ul><li>MASTER_IP 为 master 节点 ip</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;docker&#34;</span>
</code></pre></div><h3 id=向集群的-control-plane-添加-master-节点>向集群的 control-plane 添加 master 节点</h3><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.4
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入 control-plane</p><ul><li>MASTER_IP 需要填已有的 master 节点 ip</li><li>NODE_MODE 当该模式为 node-join-control-plane 时，需要指定 master 节点们的 CONTROL_PLANE_ENDPOINT(vip)</li><li>CONTROL_PLANE_ENDPOINT 为高可用 vip</li><li>可以根据需要选择适合自己的 ssh 方式</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h2 id=v12x>v1.2.x</h2><h3 id=向集群添加工作节点-1>向集群添加工作节点</h3><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.2
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入集群</p><ul><li>MASTER_IP 为 master 节点 ip</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h3 id=向集群的-control-plane-添加-master-节点-1>向集群的 control-plane 添加 master 节点</h3><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.2
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入 control-plane</p><ul><li>MASTER_IP 需要填已有的 master 节点 ip</li><li>NODE_MODE 当该模式为 node-join-control-plane 时，需要指定 master 节点们的 CONTROL_PLANE_ENDPOINT(vip)</li><li>CONTROL_PLANE_ENDPOINT 为高可用 vip</li><li>可以根据需要选择适合自己的 ssh 方式</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h2 id=v11x>v1.1.x</h2><h3 id=向集群添加工作节点-2>向集群添加工作节点</h3><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.1
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><blockquote><p>tip: 你可以通过预先下载离线包和镜像来减少部署时间 <code>export PRE_DOWNLOAD="true";curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/${KUBECUBE_VERSION}/entry.sh | bash</code></p></blockquote><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入集群</p><ul><li>MASTER_IP 为 master 节点 ip</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</code></pre></div><h3 id=向集群的-control-plane-添加-master-节点-2>向集群的 control-plane 添加 master 节点</h3><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.1
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入 control-plane</p><ul><li>MASTER_IP 需要填已有的 master 节点 ip</li><li>NODE_MODE 当该模式为 node-join-control-plane 时，需要指定 master 节点们的 CONTROL_PLANE_ENDPOINT(vip)</li><li>CONTROL_PLANE_ENDPOINT 为高可用 vip</li><li>可以根据需要选择适合自己的 ssh 方式</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</code></pre></div><h2 id=v10x>v1.0.x</h2><h3 id=向集群添加工作节点-3>向集群添加工作节点</h3><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><blockquote><p>tip: 你可以通过预先下载离线包和镜像来减少部署时间 <code>export PRE_DOWNLOAD="true";curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/${KUBECUBE_VERSION}/entry.sh | bash</code></p></blockquote><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入集群</p><ul><li>MASTER_IP 为 master 节点 ip</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h3 id=向集群的-control-plane-添加-master-节点-3>向集群的 control-plane 添加 master 节点</h3><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入 control-plane</p><ul><li>MASTER_IP 需要填已有的 master 节点 ip</li><li>CONTROL_PLANE_ENDPOINT 为高可用 vip</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-control-plane&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.10&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-24ba84ef2eb4b3562bfa9994a3e59a3d>5.4 - 多节点高可用部署</h1><p>本文提供 Kubernetes 的高可用部署和 KubeCube 的高可用部署方案，VIP 的实现需要用户自行提供</p><h2 id=v14x>v1.4.x</h2><h3 id=主机规划>主机规划</h3><table><thead><tr><th style=text-align:left>IP 地址</th><th style=text-align:left>主机名</th><th style=text-align:left>角色</th></tr></thead><tbody><tr><td style=text-align:left>10.173.32.2</td><td style=text-align:left>lb1</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.3</td><td style=text-align:left>lb2</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.4</td><td style=text-align:left>master1</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.5</td><td style=text-align:left>master2</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.6</td><td style=text-align:left>master3</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.7</td><td style=text-align:left>worker1</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.8</td><td style=text-align:left>worker2</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.9</td><td style=text-align:left>worker3</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.10</td><td style=text-align:left></td><td style=text-align:left>vip 地址</td></tr></tbody></table><blockquote><p>⚠️master2、master3、worker1、worker2、worker3 需要能够通过密钥或者密码 ssh 访问 master1</p></blockquote><h3 id=部署高可用-kubernetes>部署高可用 Kubernetes</h3><p>KubeCube 部署脚本提供部署高可用 k8s 的能力，当然，你也可以使用其他工具搭建高可用的 k8s 集群</p><h4 id=开始安装>开始安装</h4><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.4
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 Kubernetes 安装完成，master2 和 master3 加入 control-plane 的方式与之相同</p><ul><li>CONTROL_PLANE_ENDPOINT 为高可用 k8s-apiserver 的 vip，在此我们用任意 master 节点的 ip 代替</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-plane-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h4 id=worker1-作为工作节点加入集群>worker1 作为工作节点加入集群</h4><p>在 worker1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.4
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 worker1 加入集群，worker2 和 worker3 加入集群的方式与之相同</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;docker&#34;</span>
</code></pre></div><h3 id=部署高可用-kubecube>部署高可用 KubeCube</h3><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.4
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 KubeCube 部署完成</p><ul><li>install.conf</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;docker&#34;</span>
</code></pre></div><h2 id=v12x>v1.2.x</h2><h3 id=主机规划-1>主机规划</h3><table><thead><tr><th style=text-align:left>IP 地址</th><th style=text-align:left>主机名</th><th style=text-align:left>角色</th></tr></thead><tbody><tr><td style=text-align:left>10.173.32.2</td><td style=text-align:left>lb1</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.3</td><td style=text-align:left>lb2</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.4</td><td style=text-align:left>master1</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.5</td><td style=text-align:left>master2</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.6</td><td style=text-align:left>master3</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.7</td><td style=text-align:left>worker1</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.8</td><td style=text-align:left>worker2</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.9</td><td style=text-align:left>worker3</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.10</td><td style=text-align:left></td><td style=text-align:left>vip 地址</td></tr></tbody></table><blockquote><p>⚠️master2、master3、worker1、worker2、worker3 需要能够通过密钥或者密码 ssh 访问 master1</p></blockquote><h3 id=部署高可用-kubernetes-1>部署高可用 Kubernetes</h3><p>KubeCube 部署脚本提供部署高可用 k8s 的能力，当然，你也可以使用其他工具搭建高可用的 k8s 集群</p><h4 id=开始安装-1>开始安装</h4><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.2
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 Kubernetes 安装完成，master2 和 master3 加入 control-plane 的方式与之相同</p><ul><li>CONTROL_PLANE_ENDPOINT 为高可用 k8s-apiserver 的 vip，在此我们用任意 master 节点的 ip 代替</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-plane-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h4 id=worker1-作为工作节点加入集群-1>worker1 作为工作节点加入集群</h4><p>在 worker1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.2
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 worker1 加入集群，worker2 和 worker3 加入集群的方式与之相同</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h3 id=部署高可用-kubecube-1>部署高可用 KubeCube</h3><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.2
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 KubeCube 部署完成</p><ul><li>install.conf</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s cni, support now is calico only</span>
<span style=color:#000>CNI</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;calico&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.19.13, 1.20.9, 1.21.2, 1.22.2, 1.23.5</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.23.5&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBERNETES_BIND_ADDRESS generally is node_ip</span>
<span style=color:#8f5902;font-style:italic># can be set when NODE_MODE=&#34;master&#34; ot &#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># default value is $(hostname -I |awk &#39;{print $1}&#39;)</span>
<span style=color:#000>KUBERNETES_BIND_ADDRESS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{node_ip}</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># container runtime config</span>
<span style=color:#8f5902;font-style:italic># if value is docker, then use docker as container runtime</span>
<span style=color:#8f5902;font-style:italic># else if value is containerd, then use containerd as container runtime</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#000>CONTAINER_RUNTIME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;containerd&#34;</span>
</code></pre></div><h2 id=v11x>v1.1.x</h2><h3 id=主机规划-2>主机规划</h3><table><thead><tr><th style=text-align:left>IP 地址</th><th style=text-align:left>主机名</th><th style=text-align:left>角色</th></tr></thead><tbody><tr><td style=text-align:left>10.173.32.2</td><td style=text-align:left>lb1</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.3</td><td style=text-align:left>lb2</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.4</td><td style=text-align:left>master1</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.5</td><td style=text-align:left>master2</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.6</td><td style=text-align:left>master3</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.7</td><td style=text-align:left>worker1</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.8</td><td style=text-align:left>worker2</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.9</td><td style=text-align:left>worker3</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.10</td><td style=text-align:left></td><td style=text-align:left>vip 地址</td></tr></tbody></table><blockquote><p>⚠️master2、master3、worker1、worker2、worker3 需要能够通过密钥或者密码 ssh 访问 master1</p></blockquote><h3 id=部署高可用-kubernetes-2>部署高可用 Kubernetes</h3><p>KubeCube 部署脚本提供部署高可用 k8s 的能力，当然，你也可以使用其他工具搭建高可用的 k8s 集群</p><h4 id=开始安装-2>开始安装</h4><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.1
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 Kubernetes 安装完成，master2 和 master3 加入 control-plane 的方式与之相同</p><ul><li>CONTROL_PLANE_ENDPOINT 为高可用 k8s-apiserver 的 vip，在此我们用任意 master 节点的 ip 代替</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-plane-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</code></pre></div><h4 id=worker1-作为工作节点加入集群-2>worker1 作为工作节点加入集群</h4><p>在 worker1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.1
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 worker1 加入集群，worker2 和 worker3 加入集群的方式与之相同</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</code></pre></div><h3 id=部署高可用-kubecube-2>部署高可用 KubeCube</h3><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.1
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 KubeCube 部署完成</p><ul><li>install.conf</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-plane-master&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#8f5902;font-style:italic># support now is: 1.20.9, 1.19.13, 1.18.20, 1.21.2</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># member cluster config</span>
<span style=color:#8f5902;font-style:italic># used when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># ssh config</span>
<span style=color:#8f5902;font-style:italic># used when NODE_MODE=&#34;node-join-master&#34; or node-join-control-plane</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>

<span style=color:#8f5902;font-style:italic>#######################################################################</span>
<span style=color:#8f5902;font-style:italic># offline config</span>
<span style=color:#8f5902;font-style:italic># used when offline install choose, must lift offline pkg first</span>
<span style=color:#8f5902;font-style:italic>#######################################################################</span>

<span style=color:#000>OFFLINE_INSTALL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#000>OFFLINE_PKG_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</code></pre></div><ul><li>cube.conf</li></ul><p>将<code>kubecube_replicas</code>设置为3，使得 KubeCube 使用 3 副本部署，并且由于<code>podAntiAffinity</code></p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># custom values for kubecube</span>

<span style=color:#000>kubecube_replicas</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
<span style=color:#000>kubecube_args_logLevel</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;info&#34;</span>
</code></pre></div><h2 id=v10x>v1.0.x</h2><h3 id=主机规划-3>主机规划</h3><table><thead><tr><th style=text-align:left>IP 地址</th><th style=text-align:left>主机名</th><th style=text-align:left>角色</th></tr></thead><tbody><tr><td style=text-align:left>10.173.32.2</td><td style=text-align:left>lb1</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.3</td><td style=text-align:left>lb2</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.4</td><td style=text-align:left>master1</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.5</td><td style=text-align:left>master2</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.6</td><td style=text-align:left>master3</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.7</td><td style=text-align:left>worker1</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.8</td><td style=text-align:left>worker2</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.9</td><td style=text-align:left>worker3</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.10</td><td style=text-align:left></td><td style=text-align:left>vip 地址</td></tr></tbody></table><blockquote><p>⚠️master2、master3、worker1、worker2、worker3 需要能够通过密钥或者密码 ssh 访问 master1</p></blockquote><h3 id=部署高可用-kubernetes-3>部署高可用 Kubernetes</h3><h4 id=开始安装-3>开始安装</h4><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 Kubernetes 安装完成</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-plane-master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.10&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h4 id=master2-节点加入-control-plane>master2 节点加入 control-plane</h4><p>在 master2 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 master2 加入 control-plane</p><blockquote><p>master3 加入 control-plane 与此类似，仅需修改 <code>LOCAL_IP</code>为<code>10.173.32.6</code></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-control-plane&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.10&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h4 id=worker1-作为工作节点加入集群-3>worker1 作为工作节点加入集群</h4><p>在 worker1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 worker1 加入集群</p><blockquote><p>worker2 和 worker3 加入集群的方式与之类似，仅需修改<code>LOCAL_IP</code>为本机 IP 即可</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h3 id=部署高可用-kubecube-3>部署高可用 KubeCube</h3><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 KubeCube 部署完成</p><ul><li>install.conf</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-plane-master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the port specified to access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>22</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><ul><li>cube.conf</li></ul><p>将<code>kubecube_replicas</code>设置为3，使得 KubeCube 使用 3 副本部署，并且由于<code>podAntiAffinity</code>，它们会运行在非<code>controlPlane</code>的节点上，并且每个节点仅运行单个副本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># custom values for kubecube</span>

<span style=color:#000>kubecube_replicas</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
<span style=color:#000>kubecube_args_logLevel</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;info&#34;</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6818a5107747076ce7e60a61671c142d>6 - 已有系统接入</h1></div><div class=td-content><h1 id=pg-55566b3f6f2b6ad97ca706cd58808143>6.1 - Prometheus</h1><p>KubeCube 在部署时会自动安装 Prometheus 等监控组件，以实现监控功能。本文档介绍了如何在 KubeCube 中接入用户已有的 Prometheus。</p><h2 id=准备工作>准备工作</h2><ol><li><p>在集群部署好 Prometheus，Prometheus 可以正常监控到集群资源的数据；</p></li><li><p>在集群中部署好 KubeCube；</p><p>说明：部署好 KubeCube 后，由于集群内已有 Prometheus operator，多个 operator 会导致集群内 Prometheus 相关功能不可用，需要卸载 KubeCube 监控组件或删除本地 operator。</p></li><li><p>以平台管理员角色登录 KubeCube 管控集群。</p></li></ol><h2 id=步骤>步骤</h2><h3 id=1添加-label>1、添加 Label</h3><p>由于 KubeCube 需要实现多集群监控，因此在 KubeCube 查询监控数据时，都会在 query 表达式中添加 <code>cluster={clusterName}</code> 来进行集群过滤。用户需要在 Prometheus 的 exporter 中添加这一 label，前端查询监控数据时才能查询到结果。</p><h3 id=2卸载-kubecube-监控组件>2、卸载 KubeCube 监控组件</h3><p>方式一 页面操作：</p><ol><li><p>点击页面右上角【切换到控制台】，点击任意空间，进入到控制台页面；</p></li><li><p>在左侧菜单栏点击【自定义资源CRD】，进入到集群级别 CRD 列表，可以点击右上方输入 “hotplug” 进行搜索，找到 “hotplugs.hotplug.kubecube.io” CRD，点击【v1】版本进入 CRD 详情页；</p></li><li><p>选择 common 实例，点击【设置YAML】，找到 spec.component. name=kubecube-monitoring，将 “status” 改成 “disabled”，即卸载 KubeCube 自带监控组件。</p></li></ol><p>方式二 命令行操作：</p><ol><li><code>kubectl edit hotplug common</code></li><li>找到 spec.component. name=kubecube-monitoring，将 “status” 改成 “disabled”。</li></ol><p>详细配置说明见 <a href=https://www.kubecube.io/docs/installation-guide/enable-plugins/>热插拔</a> 。</p><h3 id=3部署-servicemonitor>3、部署 ServiceMonitor</h3><h4 id=查看集群资源>查看集群资源</h4><p>查看控制台内监控数据，需要部署两个 ServiceMonitor：kubelet 和 kube-state-metrics 的 ServiceMonitor，样例如下：</p><ul><li><p>部署 kubecube-monitoring-kubelet</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>monitoring.coreos.com/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceMonitor</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring-kubelet</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>bearerTokenFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>honorLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>relabelings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>sourceLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>__metrics_path__</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metrics_path</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tlsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>caFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>insecureSkipVerify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>bearerTokenFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>honorLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/metrics/cadvisor</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>relabelings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>sourceLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>__metrics_path__</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metrics_path</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tlsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>caFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>insecureSkipVerify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>bearerTokenFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>honorLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/metrics/probes</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>relabelings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>sourceLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>__metrics_path__</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metrics_path</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tlsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>caFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>insecureSkipVerify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jobLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>k8s-app</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespaceSelector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchNames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>kube-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>k8s-app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubelet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li><li><p>部署 kubecube-monitoring-kube-state-metrics</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>monitoring.coreos.com/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceMonitor</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring-kube-state-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>honorLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app.kubernetes.io/instance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app.kubernetes.io/name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kube-state-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li></ul><h4 id=查看组件监控>查看组件监控</h4><p>当前 KubeCube 平台支持对组件的监控视图可视化查询，详细说明见 <a href=https://www.kubecube.io/docs/user-guide/monitoring/component-monitoring/>平台组件监控</a> 。接入外部监控后，用户可按需在集群内部署对应组件的 ServiceMonitor。</p><p>各个 ServiceMonitor 的 yaml 可参考 <a href=https://github.com/kubecube-io/charts/tree/main/kubecube-monitoring/templates/exporters>https://github.com/kubecube-io/charts/tree/main/kubecube-monitoring/templates/exporters</a>。</p><h3 id=4部署-dashboard>4、部署 Dashboard</h3><p>查看集群资源（控制台内监控数据），需要部署：</p><ul><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-cluster.yaml>cube-resource-cluster.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-namespace.yaml>cube-resource-namespace.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-node.yaml>cube-resource-node.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-persistentvolume.yaml>cube-resource-persistentvolume.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-pod.yaml>cube-resource-pod.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-workload.yaml>cube-resource-workload.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/default-rolebinding.yaml>default-rolebinding.yaml</a></li></ul><p>查看组件监控，可以部署对应的 Dashboard：</p><ul><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-control-plane-pods.yaml>component-control-plane-pods.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-coredns.yaml>component-coredns.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-etcd.yaml>component-etcd.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kube-apiserver.yaml>component-kube-apiserver.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kube-controller-manager.yaml>component-kube-controller-manager.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kube-proxy.yaml>component-kube-proxy.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kube-scheduler.yaml>component-kube-scheduler.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kubelet.yaml>component-kubelet.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-prometheus.yaml>component-prometheus.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-thanos.yaml>component-thanos.yaml</a></li></ul><h3 id=5修改-nginx-配置>5、修改 Nginx 配置</h3><ol><li><p>使用命令行：<code>kubectl edit configmap nginx-config -n kubecube-system</code></p></li><li><p>找到原有的地址配置，修改为自有 Prometheus 地址</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#000>upstream monitoring {</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server kubecube-thanos-query.kubecube-monitoring:9090;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>即 将<code>kubecube-thanos-query.kubecube-monitoring:9090</code> 替换为外部地址。</p></li><li><p>重启 pod：<code>kubectl delete pod frontend-xxxxxx-xxxxx -n kubecube-system</code></p></li></ol><h3 id=heading></h3></div><div class=td-content style=page-break-before:always><h1 id=pg-3fdb9f53fbdf958554148e74555fe462>6.2 - ElasticSearch</h1><p>KubeCube 提供了日志服务和操作审计服务，默认关闭。用户在开启后，日志服务和操作审计服务均会将日志发送到 ElasticSearch 进行存储，由 ElasticSearch 对日志进行管理。用户可以在 <a href=https://www.kubecube.io/docs/installation-guide/enable-plugins/>热插拔</a> 中修改配置，安装内部 ElasticSearch，也可以配置外部的 ElasticSearch 地址，对接已有的 ElasticSearch。下面分别介绍如何在这两个功能中接入外部 ElasticSearch。</p><h2 id=日志>日志</h2><p>方式一 页面操作：</p><ol><li><p>点击页面右上角【切换到控制台】，点击任意空间，进入到控制台页面；</p></li><li><p>在左侧菜单栏点击【自定义资源CRD】，进入到集群级别 CRD 列表，可以点击右上方输入 “hotplug” 进行搜索，找到 “hotplugs.hotplug.kubecube.io” CRD，点击【v1】版本进入 CRD 详情页；</p></li><li><p>选择 common 实例，点击【设置YAML】，找到 spec.component. name=logseer，添加环境变量，如：</p></li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer-v1.0.0.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>  </span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>elasticsearch-master.elasticsearch.svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>方式二 命令行操作：</p><ol><li><code>kubectl edit hotplug pivot-cluster</code></li><li>找到 spec.component. name=logseer，添加环境变量，同上。</li></ol><p>详细配置说明见 <a href=https://www.kubecube.io/docs/installation-guide/enable-plugins/>热插拔</a> 。</p><h2 id=操作审计>操作审计</h2><ol><li><p><code>kubectl edit deploy audit -n kubecube-system</code></p></li><li><p>添加环境变量：AUDIT_WEBHOOK_HOST、AUDIT_WEBHOOK_INDEX、AUDIT_WEBHOOK_TYPE，如</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_HOST</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http://elasticsearch-master.elasticsearch:9200</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_INDEX</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>audit</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_TYPE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li></ol><p>注：如果同时配置了内部和外部 ElasticSearch，审计日志将优先发到外部 ElasticSearch。</p><p>其他详细说明见：<a href=https://www.kubecube.io/docs/user-guide/administration/audit/>操作审计</a> 。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-61cda61016ee5895ec364823d66746b2>6.3 - 第三方认证系统</h1><h1 id=外部认证系统接入>外部认证系统接入</h1><p>KubeCube 中包含一套自有的认证系统，同时也支持多种类型的外部认证系统的接入。本文档介绍了如何在 KubeCube 中接入 GitHub、Ldap 以及通用认证接口三种认证系统的操作步骤。</p><h2 id=github-认证>GitHub 认证</h2><h3 id=1-登记应用信息>1. 登记应用信息</h3><p>在 <a href=https://github.com/settings/applications/new>GitHub</a> 注册一个 Oauth 应用，Homepage URL 和 Authorization callback URL 均填写 <code>http://{kubecube_host}/#/login</code>，创建成功后 Github 生成一个 ClientId，再手动创建一个 Client secret。</p><h3 id=2-修改配置文件>2. 修改配置文件</h3><p>在管控集群修改 configmap：<code>kubectl edit cm kubecube-auth-config -n kubecube-system</code>，修改内容如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>github</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>    enabled: true
</span><span style=color:#8f5902;font-style:italic>    clientId: 80b802dc59eeb847ed00
</span><span style=color:#8f5902;font-style:italic>    clientSecret: 83dc8eb788f706de3449d45e61f45ebdca433de2
</span><span style=color:#8f5902;font-style:italic>    host: http://10.219.196.107:30080</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></code></pre></div><p>参数说明如下：</p><table><thead><tr><th>参数</th><th>说明</th><th>类型</th><th>默认值</th></tr></thead><tbody><tr><td>enabled</td><td>是否开启 Github 登录</td><td>boolean</td><td>false</td></tr><tr><td>clientId</td><td>GitHub 授权的 ClientId</td><td>string</td><td></td></tr><tr><td>clientSecret</td><td>GitHub 授权的 Client secret</td><td>string</td><td></td></tr><tr><td>host</td><td>KubeCube 服务器地址</td><td>string</td><td></td></tr></tbody></table><h3 id=3-访问前端登录页面>3. 访问前端登录页面</h3><p>访问 KubeCube 前端登录页面，选择使用GitHub账号登录；</p><p><img src=/imgs/installation-guide/external-auth.png alt=external-auth></p><p>授权应用，点击 Authorize xxxapp，即可登录到 KubeCube。</p><p>KubeCube 会使用 Github 返回的信息自动在集群中创建该用户，并标记该用户的 “LOGINTYPE” 为 “github”。</p><h2 id=ldap-认证>Ldap 认证</h2><p>KubeCube 支持接入用户已部署的 LDAP 来进行认证。具体步骤如下。</p><h3 id=1-添加启动参数>1. 添加启动参数</h3><p>为 KubeCube Deployment 添加启动参数，参数说明如下：</p><table><thead><tr><th>参数</th><th>说明</th><th>类型</th><th>是否必填</th><th>默认值</th><th>示例</th></tr></thead><tbody><tr><td>ldap-is-enable</td><td>是否开启 Ldap 登录</td><td>boolean</td><td>是</td><td>false</td><td>true</td></tr><tr><td>ldap-server</td><td>Ldap 服务器地址</td><td>string</td><td>是</td><td></td><td>10.219.196.107</td></tr><tr><td>ldap-port</td><td>Ldap 服务器端口号</td><td>string</td><td>否</td><td>389</td><td>389</td></tr><tr><td>ldap-base</td><td>Ldap 查询分区</td><td>string</td><td>是</td><td></td><td>dc=example,dc=com</td></tr><tr><td>ldap-admin-user-account</td><td>Ldap 管理员账号</td><td>string</td><td>是</td><td></td><td>cn=admin,dc=example,dc=com</td></tr><tr><td>ldap-admin-password</td><td>Ldap 管理员密码</td><td>string</td><td>是</td><td></td><td>admin123456</td></tr><tr><td>ldap-object-class</td><td>Ldap 对象类</td><td>string</td><td>否</td><td>person</td><td>person</td></tr><tr><td>ldap-login-name-config</td><td>用户名所在配置</td><td>string</td><td>否</td><td>uid</td><td>cn</td></tr><tr><td>ldap-object-category</td><td>Ldap objectcategory</td><td>string</td><td>否</td><td></td><td>dc=example,dc=com</td></tr></tbody></table><p>示例如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>args</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>ldap-is-enable=true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>ldap-object-class=person</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>ldap-server=10.219.196.107</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>ldap-base=dc=example,dc=com</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>ldap-admin-user-account=cn=admin,dc=example,dc=com</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>ldap-admin-password=admin123456</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>ldap-login-name-config=cn</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=2-请求登录>2. 请求登录</h3><h5 id=接口路径>接口路径</h5><pre><code>/api/v1/cube/login
</code></pre><h5 id=接口方法>接口方法</h5><p>POST</p><h5 id=请求参数>请求参数</h5><table><thead><tr><th>参数名称</th><th>参数说明</th><th>参数来源</th><th style=text-align:center>参数类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>name</td><td>用户名</td><td><code>body</code></td><td style=text-align:center>string</td><td>是</td><td></td></tr><tr><td>password</td><td>密码</td><td><code>body</code></td><td style=text-align:center>string</td><td>是</td><td></td></tr><tr><td>loginType</td><td>登录方式</td><td><code>body</code></td><td style=text-align:center>string</td><td>是</td><td>ldap</td></tr></tbody></table><h5 id=响应>响应</h5><p>如果 Ldap 返回认证成功，KubeCube 在集群中创建该用户，并标记该用户的 “LOGINTYPE” 为 “ldap”。</p><table><thead><tr><th>响应码</th><th>状态</th><th>描述</th><th>响应体</th></tr></thead><tbody><tr><td>200</td><td>OK</td><td>请求成功，返回在集群中创建的User信息</td><td><a href=#User>User</a></td></tr></tbody></table><h5 id=数据模型>数据模型</h5><h6 id=user>User</h6><table><thead><tr><th>参数名称</th><th>参数说明</th><th style=text-align:center>参数类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>kind</td><td>User</td><td style=text-align:center>string</td><td>是</td><td></td></tr><tr><td>apiVersion</td><td>user.kubecube.io/v1</td><td style=text-align:center>string</td><td>是</td><td></td></tr><tr><td>metadata</td><td>元数据</td><td style=text-align:center><a href=#Metadata>Metadata</a></td><td>是</td><td></td></tr><tr><td>spec</td><td></td><td style=text-align:center><a href=#UserSpec>UserSpec</a></td><td>是</td><td></td></tr><tr><td>status</td><td></td><td style=text-align:center><a href=#UserStatus>UserStatus</a></td><td>是</td><td></td></tr></tbody></table><h6 id=metadata>Metadata</h6><table><thead><tr><th>参数名称</th><th>参数说明</th><th style=text-align:center>参数类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>name</td><td>该用户在集群中的名称</td><td style=text-align:center>string</td><td>是</td><td></td></tr><tr><td>labels</td><td>标签</td><td style=text-align:center>map[string]string</td><td>否</td><td>Ldap返回的真实用户名保存在标签中</td></tr><tr><td>creationTimestamp</td><td>创建此对象时的时间戳</td><td style=text-align:center>Time</td><td>否</td><td></td></tr><tr><td>generation</td><td>所需状态的特定生成的序列号</td><td style=text-align:center>integer</td><td>否</td><td></td></tr><tr><td>uid</td><td>资源对象在集群中的唯一标识</td><td style=text-align:center>string</td><td>否</td><td></td></tr><tr><td>selfLink</td><td>资源关联的url</td><td style=text-align:center>string</td><td>否</td><td></td></tr></tbody></table><h6 id=userspec>UserSpec</h6><table><thead><tr><th>参数名称</th><th>参数说明</th><th style=text-align:center>参数类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>loginType</td><td>登录方式</td><td style=text-align:center>string</td><td>是</td><td>ldap</td></tr></tbody></table><h6 id=userstatus>UserStatus</h6><table><thead><tr><th>参数名称</th><th>参数说明</th><th style=text-align:center>参数类型</th><th>是否必须</th><th>备注</th></tr></thead><tbody><tr><td>lastLoginTime</td><td>上次登录时间</td><td style=text-align:center>Time</td><td>否</td><td></td></tr><tr><td>lastLoginIP</td><td>上次登录IP</td><td style=text-align:center>string</td><td>否</td><td></td></tr></tbody></table><h5 id=请求示例>请求示例</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>curl https://0.0.0.0:7443/api/v1/cube/login -X POST -d <span style=color:#4e9a06>&#39;{&#34;name&#34;: &#34;test123&#34;,&#34;password&#34;:&#34;123456&#34;,&#34;loginType&#34;:&#34;ldap&#34;}&#39;</span> --header <span style=color:#4e9a06>&#34;Content-Type: application/json&#34;</span> 
</code></pre></div><h5 id=返回示例>返回示例</h5><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=color:#000;font-weight:700>{</span>
	<span style=color:#204a87;font-weight:700>&#34;kind&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;User&#34;</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#204a87;font-weight:700>&#34;apiVersion&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;user.kubecube.io/v1&#34;</span><span style=color:#000;font-weight:700>,</span>
  <span style=color:#204a87;font-weight:700>&#34;metadata&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>&#34;labels&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
			<span style=color:#204a87;font-weight:700>&#34;name&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;test123&#34;</span>
		<span style=color:#000;font-weight:700>},</span>
	<span style=color:#204a87;font-weight:700>&#34;spec&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>&#34;loginType&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;ldap&#34;</span><span style=color:#000;font-weight:700>,</span>
	<span style=color:#000;font-weight:700>},</span>
	<span style=color:#204a87;font-weight:700>&#34;status&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>{</span>
		<span style=color:#204a87;font-weight:700>&#34;lastLoginTime&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;2022-07-06T06:25:37Z&#34;</span><span style=color:#000;font-weight:700>,</span>
		<span style=color:#204a87;font-weight:700>&#34;lastLoginIP&#34;</span><span style=color:#000;font-weight:700>:</span> <span style=color:#4e9a06>&#34;10.219.196.107&#34;</span>
	<span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></div><h2 id=通用认证>通用认证</h2><p>通用认证指的是通过请求第三方接口的方式进行认证。KubeCube 提供了一种通用的接入方式，但对接口的返回有一定要求。具体步骤如下。</p><h3 id=1-接口准备>1. 接口准备</h3><p>第三方认证接口要求：</p><ol><li>请求 url 为配置的固定值，KubeCube 会将请求携带的 header 进行转发，因此第三方接口对 header 进行认证；</li><li>接口返回格式为 <code>map[string]interface{}</code>，其中包含一组值为 key=“name”，value=“{用户名}”。</li></ol><h3 id=2-添加启动参数>2. 添加启动参数</h3><p>为 KubeCube Deployment 添加启动参数，参数说明如下：</p><table><thead><tr><th>参数</th><th>说明</th><th>类型</th><th>是否必填</th><th>默认值</th><th>示例</th></tr></thead><tbody><tr><td>generic-auth-is-enable</td><td>是否开启通用认证方式</td><td>boolean</td><td>是</td><td>false</td><td>true</td></tr><tr><td>generic-auth-url</td><td>第三方认证url</td><td>string</td><td>是</td><td></td><td><a href=https://kubecube123.com/api/v1/demo/auth>https://kubecube123.com/api/v1/demo/auth</a></td></tr><tr><td>generic-auth-method</td><td>第三方认证请求方式</td><td>string</td><td>是</td><td></td><td>GET</td></tr><tr><td>generic-auth-scheme</td><td>请求协议</td><td>string</td><td>否</td><td>http</td><td>https</td></tr><tr><td>generic-auth-insecure-skip-verify</td><td>是否跳过安全校验</td><td>string</td><td>否</td><td></td><td>true</td></tr><tr><td>generic-auth-tls-cert</td><td>tls证书</td><td>string</td><td>否</td><td></td><td>LS0NGc9PQotLS0tLUVOFURS0tLS0t</td></tr><tr><td>generic-auth-tls-key</td><td>tls密钥</td><td>string</td><td>否</td><td></td><td>LS0NsfGcQotfdLS0tLUVOFURtLS0ta1</td></tr></tbody></table><p>示例如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>args</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>generic-auth-is-enable=true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>generic-auth-url=https://kubecube123.com/api/v1/demo/auth</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>generic-auth-method=GET</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>generic-auth-scheme=https</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- -<span style=color:#000>generic-auth-insecure-skip-verify=true</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>开启通用认证方式后，用户可跳过登录直接访问 KubeCube。KubeCube 会将请求携带的 header 转发给配置的第三方认证平台，由第三方认证平台返回的结果决定请求是否通过认证。</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kubecube-io/kubecube aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2023 KubeCube Project Authors All Rights Reserved</small>
<small class=ml-1><a href=http://www.apache.org/licenses/LICENSE-2.0 target=_blank rel=noopener>隐私政策</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>