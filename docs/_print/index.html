<!doctype html><html lang=zh class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.81.0"><link rel=canonical type=text/html href=https://kubecube-io.github.io/docs/><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>文档 | KubeCube</title><meta name=description content="开源容器平台"><meta property="og:title" content="文档"><meta property="og:description" content="开源容器平台"><meta property="og:type" content="website"><meta property="og:url" content="https://kubecube-io.github.io/docs/"><meta property="og:site_name" content="KubeCube"><meta itemprop=name content="文档"><meta itemprop=description content="开源容器平台"><meta name=twitter:card content="summary"><meta name=twitter:title content="文档"><meta name=twitter:description content="开源容器平台"><link rel=preload href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css as=style><link href=/scss/main.min.810b672b8acd789a78e1ee9e004e599d749572bd1fbb0d001f26f2e5c568c907.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://unpkg.com/lunr@2.3.8/lunr.min.js integrity=sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY crossorigin=anonymous></script></head><body class=td-section><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><span class=navbar-logo><svg width="4984" height="1e3" viewBox="0 0 4984 1e3" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3551.54 432.823C3552.84 435.556 3555.59 437.298 3558.62 437.298H3658.46C3663.69 437.298 3667.45 432.277 3665.98 427.259 3634.56 319.831 3535.31 241.352 3417.7 241.352H3402.03c-142.85.0-258.65 115.801-258.65 258.648v31.352c0 142.847 115.8 258.648 258.65 258.648H3417.7c117.61.0 216.86-78.48 248.28-185.907C3667.45 599.075 3663.69 594.054 3658.46 594.054H3558.62C3555.59 594.054 3552.84 595.796 3551.54 598.529 3526.37 651.507 3472.39 688.108 3409.87 688.108 3323.29 688.108 3253.11 617.926 3253.11 531.352V5e2C3253.11 413.426 3323.29 343.243 3409.87 343.243c62.52.0 116.5 36.601 141.67 89.58z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4970.89 651.516C4972.68 646.419 4968.9 641.081 4963.5 641.081H4867.67C4865.09 641.081 4862.68 642.35 4861.21 644.474 4842.85 671.15 4813.84 688.108 4781.45 688.108 4736.6 688.108 4698.03 655.443 4685.65 609.73h288.5C4978.15 609.73 4981.51 606.719 4981.95 602.744 4982.82 594.747 4983.27 586.616 4983.27 578.378c0-116.507-90-211.621-201.820000000001-211.621-111.83.0-201.83 95.114-201.83 211.621S4669.62 790 4781.45 790C4868.6 790 4942.57 732.144 4970.89 651.516zM4781.45 468.649C4819.59 468.649 4853.14 492.229 4869.98 527.433H4692.92C4709.75 492.229 4743.3 468.649 4781.45 468.649z" fill="#333"/><path d="M3727 386C3727 381.582 3730.58 378 3735 378h86C3825.42 378 3829 381.582 3829 386V612.5C3829 654.197 3862.8 688 3904.5 688s75.5-33.803 75.5-75.5V386C3980 381.582 3983.58 378 3988 378h86C4078.42 378 4082 381.582 4082 386V770C4082 774.418 4078.42 778 4074 778h-86C3983.58 778 3980 774.418 3980 770V764.6C3954.53 780.689 3924.35 790 3892 790 3800.87 790 3727 716.127 3727 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M3072.22 651.516C3074.01 646.419 3070.22 641.081 3064.82 641.081H2968.99C2966.42 641.081 2964 642.35 2962.54 644.474 2944.17 671.15 2915.17 688.108 2882.77 688.108 2837.92 688.108 2799.35 655.443 2786.97 609.73h288.51C3079.48 609.73 3082.84 606.719 3083.27 602.744 3084.15 594.747 3084.59 586.616 3084.59 578.378c0-116.507-90-211.621-201.82-211.621s-201.82 95.114-201.82 211.621S2770.95 790 2882.77 790C2969.93 790 3043.9 732.144 3072.22 651.516zM2882.77 468.649C2920.92 468.649 2954.47 492.229 2971.3 527.433H2794.24C2811.07 492.229 2844.62 468.649 2882.77 468.649z" fill="#333"/><path d="M1342 770.243C1342 774.661 1345.58 778.243 1350 778.243H1435.89c4.41999999999985.0 8-3.58200000000011 8-8V592.206L1495.37 540.725l196.9 234.656C1693.79 777.193 1696.04 778.239 1698.4 778.239h112.12C1817.32 778.239 1821.02 770.302 1816.65 765.096L1567.7 468.401l244.74-244.744C1817.48 218.617 1813.91 210 1806.78 210H1685.31C1683.19 210 1681.16 210.843 1679.66 212.343L1443.89 448.109V218C1443.89 213.582 1440.31 210 1435.89 210H1350C1345.58 210 1342 213.582 1342 218V770.243z" fill="#333"/><path d="M1828 386C1828 381.582 1831.58 378 1836 378h86C1926.42 378 1930 381.582 1930 386V612.5c0 41.697 33.8 75.5 75.5 75.5s75.5-33.803 75.5-75.5V386C2081 381.582 2084.58 378 2089 378h86C2179.42 378 2183 381.582 2183 386V770C2183 774.418 2179.42 778 2175 778h-86C2084.58 778 2081 774.418 2081 770V764.6C2055.53 780.689 2025.35 790 1993 790 1901.87 790 1828 716.127 1828 625V386z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M2254 210C2249.58 210 2246 213.582 2246 218V770C2246 774.418 2249.58 778 2254 778h86C2344.42 778 2348 774.418 2348 770V757.487C2378.39 778.082 2414.4 790 2453 790c108.8.0 197-94.692 197-211.5S2561.8 367 2453 367C2414.4 367 2378.39 378.918 2348 399.513V218C2348 213.582 2344.42 210 2340 210h-86zm94 368.5c0 60.475 44.77 109.5 1e2 109.5s1e2-49.025 1e2-109.5S2503.23 469 2448 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path fill-rule="evenodd" clip-rule="evenodd" d="M4153 210C4148.58 210 4145 213.582 4145 218V770C4145 774.418 4148.58 778 4153 778h86C4243.42 778 4247 774.418 4247 770V757.487C4277.39 778.082 4313.4 790 4352 790c108.8.0 197-94.692 197-211.5S4460.8 367 4352 367C4313.4 367 4277.39 378.918 4247 399.513V218C4247 213.582 4243.42 210 4239 210h-86zm94 368.5C4247 638.975 4291.77 688 4347 688s1e2-49.025 1e2-109.5S4402.23 469 4347 469s-1e2 49.025-1e2 109.5z" fill="#333"/><path d="M554.586 39C564.593 21.6667 552.084.0 532.069.0H346.41c-35.726.0-68.739 19.0599-86.602 50L28.8676 450C11.0043 480.94 11.0042 519.06 28.8675 550L259.808 950C277.671 980.94 310.684 1e3 346.41 1e3H447.276C456.208 1e3 464.461 995.235 468.927 987.5L612.399 739C622.406 721.667 609.897 7e2 589.882 7e2H427.239C412.949 7e2 399.743 692.376 392.598 680L300.222 520C293.077 507.624 293.077 492.376 300.222 480l85.964-148.894L386 330.999 554.586 39z" fill="#0056ff"/><path d="M564.401 3e2C544.386 3e2 531.877 278.333 541.884 261L685.356 12.5C689.822 4.76496 698.075.0 707.006.0H808.29C844.017.0 877.03 19.06 894.893 50.0001L1125.83 450C1143.7 480.94 1143.7 519.06 1125.83 550L894.893 950C877.03 980.94 844.017 1e3 808.29 1e3H622.214C602.199 1e3 589.69 978.333 599.697 961L750.385 7e2H750.555L854.478 520C861.624 507.624 861.624 492.376 854.478 480L762.102 320C754.957 307.624 741.752 3e2 727.461 3e2H564.401z" fill="#0056ff"/></svg></span><span class="text-uppercase font-weight-bold">KubeCube</span></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-4 mb-2 mb-lg-0"><a class="nav-link active" href=/docs/><span class=active>文档</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=/blog/><span>博客</span></a></li><li class="nav-item mr-4 mb-2 mb-lg-0"><a class=nav-link href=https://github.com/kubecube-io/kubecube target=_blank><i class="fab fa-github"></i><span>GitHub</span></a></li></ul></div><div class="navbar-nav d-none d-lg-block"><input type=search class="form-control td-search-input" placeholder="&#xf002; 站内搜索…" aria-label=站内搜索… autocomplete=off data-offline-search-index-json-src=/offline-search-index.f10456de1f56c7235a589cf2c02c05a1.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"></div><main class="col-12 col-md-9 col-xl-8 pl-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/>返回本页常规视图</a>.</p></div><h1 class=title>文档</h1><ul><li>1: <a href=#pg-6557438925ac398717df86f494c6abb8>介绍</a></li><ul><li>1.1: <a href=#pg-47c71685cf96620a504a2dc36cf0c0a4>产品介绍</a></li><li>1.2: <a href=#pg-73c5038a23a6ea146556decf0f87fcfe>产品架构</a></li></ul><li>2: <a href=#pg-6546478d87b4368b79e83eb0e32c466c>快速入门</a></li><ul><li>2.1: <a href=#pg-1022b21aedbe693fa1eb6d9276ba1ff5>快速部署</a></li><li>2.2: <a href=#pg-322fe91cfeb0a2834839485610f79c0a>快速体验</a></li></ul><li>3: <a href=#pg-1e29a42acbd6dbfaaa05d7c92ca5ccc5>部署指南</a></li><ul><li>3.1: <a href=#pg-1db6edd6ea06d95f092948473e91f961>部署环境要求</a></li><li>3.2: <a href=#pg-de08bc857408c1d7d04984f8cd8ec887>All In One 最小化部署</a></li><li>3.3: <a href=#pg-67c040d48750e52542d0a8f9af73ccd1>在已有k8s集群中部署KubeCube</a></li><li>3.4: <a href=#pg-d6af954d38ce3c01b9442434e9947c66>添加计算集群</a></li><li>3.5: <a href=#pg-f32f2b77d800b03d009916d3824443f7>添加节点</a></li><li>3.6: <a href=#pg-0b6cd8b8dc55139a7a4f574fb60eebec>多节点高可用部署</a></li><li>3.7: <a href=#pg-f5169ff9c0f450b889113b10c519efce>热插拔</a></li><li>3.8: <a href=#pg-6818a5107747076ce7e60a61671c142d>已有系统接入</a></li><ul><li>3.8.1: <a href=#pg-55566b3f6f2b6ad97ca706cd58808143>Prometheus</a></li><li>3.8.2: <a href=#pg-3fdb9f53fbdf958554148e74555fe462>ElasticSearch</a></li></ul></ul><li>4: <a href=#pg-ecf7e357d2a131135219db95eddda49c>产品使用指南</a></li><ul><li>4.1: <a href=#pg-991d31c65b93e655f58fd73d2744aa70>运维管理</a></li><ul><li>4.1.1: <a href=#pg-882b3bb80d835340e02c570d9efc20ee>用户管理</a></li><li>4.1.2: <a href=#pg-cc16e9ac86342c7d9c5ab1f4a64571b9>租户管理</a></li><li>4.1.3: <a href=#pg-e2d94e3b74b28c3cb9df52bbf9ca00b2>角色管理</a></li><li>4.1.4: <a href=#pg-0a268df46e46cb89462ce4c8762d20b6>配额管理</a></li><li>4.1.5: <a href=#pg-2306a8e0d2dc86a646a28d1621010f14>K8s集群管理</a></li><ul><li>4.1.5.1: <a href=#pg-62bae3e56f26c43c795878e3d6435987>多集群管理</a></li><li>4.1.5.2: <a href=#pg-5b8c71fac214fcac2dcfe6ebb573c677>集群级资源管理</a></li><ul><li>4.1.5.2.1: <a href=#pg-b58c5b5952e588cce8ddd5fcb7b7c0cc>存储类别(StorageClass)</a></li><li>4.1.5.2.2: <a href=#pg-84021fcd47af24336b3f2fa251e11490>存储声明(PV)</a></li><li>4.1.5.2.3: <a href=#pg-2faeb51dc0a9f8f4133fba56d59316c3>集群节点(Node)</a></li><li>4.1.5.2.4: <a href=#pg-cb1dd5ef4d6788bbe75c885d770b9a12>网络策略(NetworkPolicy)</a></li></ul></ul><li>4.1.6: <a href=#pg-4de4ac3e2c973d54322dc28a04e64999>操作审计</a></li></ul><li>4.2: <a href=#pg-4617c6f6a56d7cdbb27b726158991aaa>K8s资源管理</a></li><ul><li>4.2.1: <a href=#pg-f92399d03aa0a6430363c202d149c70d>工作负载管理</a></li><ul><li>4.2.1.1: <a href=#pg-7b012c2dd566d2198a61d60244ce1169>Deployment</a></li><li>4.2.1.2: <a href=#pg-500ff95d0a9229063602362156100f9c>StatefulSet</a></li><li>4.2.1.3: <a href=#pg-1c1715029a9653f311b6e7f2eae48dd4>Job</a></li><li>4.2.1.4: <a href=#pg-359ccce9eb5b678be164211be1ac6674>CronJob</a></li><li>4.2.1.5: <a href=#pg-d4b33d551e5eb6dd7a8d90fbeeaa23ae>Pod</a></li><li>4.2.1.6: <a href=#pg-567f7238e4941a79e1ce1cf4cac8a2d5>CRD</a></li><li>4.2.1.7: <a href=#pg-b0384913470a4be6d30a31aa6569ba7b>DaemonSet</a></li></ul><li>4.2.2: <a href=#pg-ee61de2534aadcceda73d6d0ab9b344e>服务与发现</a></li><ul><li>4.2.2.1: <a href=#pg-22aff6c7da936928435b042b223fe5c1>Service</a></li><li>4.2.2.2: <a href=#pg-866cdaed77cae1df8312e1634fe342d5>Ingress</a></li></ul><li>4.2.3: <a href=#pg-dfe90e26dd8c5f2bbd351b3c8a3f04f1>配置管理</a></li><ul><li>4.2.3.1: <a href=#pg-498270f9948d4c7c2fbbc06e6f83f203>Secret</a></li><li>4.2.3.2: <a href=#pg-c0919adee8d182e2019d6d5ebbb44d54>ConfigMap</a></li></ul><li>4.2.4: <a href=#pg-79b55e097198558e403125cdfbc32689>存储管理</a></li><ul><li>4.2.4.1: <a href=#pg-dc0724a49c70a4409332e139d6e548cc>PVC</a></li></ul><li>4.2.5: <a href=#pg-82e8b1c2057cbb52f8b8bf3f153fab19>其他</a></li><ul><li>4.2.5.1: <a href=#pg-cf4b1f8c4b2aa8cb554e7e20df5d61ff>密钥管理</a></li><li>4.2.5.2: <a href=#pg-ce8d51f35837b81d146741b8306c0c6f>Yaml 编排</a></li></ul></ul><li>4.3: <a href=#pg-8ae19508dbb7625349737720db3348ba>日志</a></li><ul><li>4.3.1: <a href=#pg-277d44191dc43d26b54c20111a0ca942>采集任务管理</a></li><li>4.3.2: <a href=#pg-13fcf9333e1399705c794b276af9548e>日志查询</a></li></ul><li>4.4: <a href=#pg-0ec2263ff6b9810ff122b6aed8649ca7>告警管理</a></li><ul><li>4.4.1: <a href=#pg-212812563f497c38bead288d83423588>平台组件告警</a></li><li>4.4.2: <a href=#pg-e9c3176c4ab8c82368326836dfd4fb38>通知策略管理</a></li><li>4.4.3: <a href=#pg-6e552205cbb956779382205554fca35d>告警规则管理</a></li></ul><li>4.5: <a href=#pg-3fea0b4ff85acbc015b806853de5f518>集群监控</a></li><ul><li>4.5.1: <a href=#pg-fa70bbc673b86ac69f0aeb6ebe99189b>平台组件监控</a></li></ul><li>4.6: <a href=#pg-5c5a86a8b94a28ac0698c10b6cb35bd5>镜像仓库</a></li><ul></ul><li>4.7: <a href=#pg-00a377bd4e65e6c156ab92b1f26089be>网络存储</a></li><ul><li>4.7.1: <a href=#pg-001c322fad8d5b93ed1cf9679ad7ea4a>NFS服务</a></li><li>4.7.2: <a href=#pg-dd73f2d4468a1047db562f521be9af8a>Ceph集群</a></li></ul><li>4.8: <a href=#pg-dece28c3c2f52b05590fc745428b6c67>排障系统</a></li><ul></ul></ul><li>5: <a href=#pg-a7c9e10a31abdecaec5a338462a220a8>开发指南</a></li><ul><li>5.1: <a href=#pg-b07c2acd70ea534eec1eeb8eed0b4f85>OpenAPI使用指南</a></li><li>5.2: <a href=#pg-9ad7e56bcc725275dc9706e2f85e840a>自研接口文档</a></li><li>5.3: <a href=#pg-644345609da22c61e3a674258f71713e>参与贡献</a></li><li>5.4: <a href=#pg-1841a4f03855471e6ec8d83e4fe1ce99>如何调试</a></li></ul><li>6: <a href=#pg-1c91a59640f4d19bcf14ebed849a10e0>FAQ</a></li><ul></ul></ul><div class=content></div></div><div class=td-content><h1 id=pg-6557438925ac398717df86f494c6abb8>1 - 介绍</h1></div><div class=td-content><h1 id=pg-47c71685cf96620a504a2dc36cf0c0a4>1.1 - 产品介绍</h1><p>KubeCube 是一个开源的企业级容器平台，为企业提供 Kubernetes 资源可视化管理以及统一的多集群多租户管理功能。KubeCube 可以简化应用部署、管理应用的生命周期和提供丰富的监控界面和日志审计功能，帮助企业快速构建一个强大和功能丰富的容器云管理平台。</p><h2 id=项目特点>项目特点</h2><ul><li>开箱即用<ul><li>学习曲线平缓，集成统一认证鉴权、多集群管理、监控、日志、告警等功能，释放生产力</li><li>运维友好，提供 Kubernetes 资源可视化管理和统一运维，具备全面的自监控能力</li><li>快速部署，提供一键式 All in One 部署模式，提供生产级高可用部署</li></ul></li><li>多租户管理<ul><li>提供租户、项目、空间多级模型，以满足企业内资源隔离和软件项目管理需求</li><li>基于多租户模型，提供权限控制、资源共享/隔离等能力</li></ul></li><li>统一的多K8s集群管理<ul><li>提供多K8s集群的中央管理面板，支持集群导入</li><li>在多K8s集群中提供统一的身份认证和拓展 Kubernetes 原生 RBAC 能力实现访问控制</li><li>通过 WebConsole、CloudShell 快速管理集群资源</li></ul></li><li>集群自治<ul><li>当 KubeCube 管理集群停机维护时，各业务集群可保持自治，保持正常的访问控制，业务 Pod 无感知</li></ul></li><li>功能热插拔<ul><li>提供最小化安装，用户可以根据需求随时开关功能</li><li>可热插拔，无需重启服务</li></ul></li><li>多种接入方式<ul><li>支持 Open API：方便对接用户现有系统</li><li>兼容 Kubernetes 原生 API：无缝兼容现有 Kubernetes 工具链，如 kubectl</li></ul></li><li>无供应商锁定<ul><li>可导入任意标准 Kubernetes 集群，更好的支持多云/混合云</li></ul></li><li>其他功能<ul><li>操作审计</li><li>丰富的可观测性功能</li></ul></li></ul><h2 id=解决的问题>解决的问题</h2><ul><li>企业上云：简化学习曲线，帮助企业以较小的成本完成容器云平台搭建，实现应用快速上云需求，辅助企业推动应用上云。</li><li>资源隔离：多租户管理提供租户、项目和空间三个层级的资源隔离、配额管理和权限控制，完全适配企业级私有云建设的资源和权限管控需求。</li><li>集群规模限制：统一的容器云管理平台，可以管理多个业务 Kubernetes 集群，数量不设上限。既能通过横向扩容新增 Kubernetes 集群的方式解决单个 Kubernetes 集群规模的限制，又可以满足不同业务条线要求独占集群的需求。</li><li>丰富的可观测性：支持监控告警和日志采集能力，提供丰富的工作负载监控指标界面，提供集群维度的监控界面，提供灵活的日志查询能力。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-73c5038a23a6ea146556decf0f87fcfe>1.2 - 产品架构</h1><p>KubeCube 产品由 KubeCube Service、Warden、CloudShell 和 AuditLog Server 等组件组成，除了 Warden 部署在各个 Kubernetes 集群充当认证代理，其余组件均部署在管理集群。</p><p>下图描述的 KubeCube 整体产品架构，包括与用户的交互，与 Kubernetes API Server 交互，Prometheus 监控和自研日志采集组件。</p><p><img src=/imgs/overview/architecture.png alt=architecture></p><ul><li>用户可以通过 KubeCube UI、CLI 指令、Open API 访问 Kubecube 服务和 Kubernetes 资源，其中 CLI 功能主要由 CloudShell 组件提供。</li><li>KubeCube Service 实现统一认证服务，透传代理 Kubernetes 资源请求，和提供更丰富的资源请求扩展接口。KubeCube Servie 包含四个组件：Restful API Server 提供API支持，AuditLog 负责审计日志收集和发送审计日志到处理组件 KubeCube AuditLog Server，Controller Manager 实现资源的 Reconcile 和 Validate Webhook ，Scout 实现各个集群之间资源的同步。</li><li>K8s APIServer 使用 Admission Webhook 的形式向 Warden（哨兵守卫）请求身份认证，并将操作审计日志上传给 KubeCube Service。</li><li>KubeCube Warden（守望者）负责身份认证和集群健康上报，部署在每一个业务集群，即使业务集群与管理集群脱离，依然可以实现认证和集群自治。</li><li>集成 Prometheus + AlertManager + Thanos 监控告警解决方案和自研的容器日志采集解决方案 Logseer + Logagent。</li><li>考虑到性能表现和可维护性因素，我们建议使用管理 Kubernetes 集群和业务 Kubernetes 集群，分开部署 Kubecube 服务和 Kubernetes 工作负载，支持对接多个业务 Kubernetes 集群。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6546478d87b4368b79e83eb0e32c466c>2 - 快速入门</h1></div><div class=td-content><h1 id=pg-1022b21aedbe693fa1eb6d9276ba1ff5>2.1 - 快速部署</h1><p>快速部署使用 All-In-One 的方式进行部署</p><h2 id=部署环境确认>部署环境确认</h2><p>请根据 <a href=https://www.kubecube.io/docs/installation-guide/requirement/>部署环境要求</a> 确认快速部署的前置要求</p><h2 id=all-in-one-部署>All In One 部署</h2><p>All In One 提供两种部署方式：</p><ol><li><p><a href=https://www.kubecube.io/docs/installation-guide/all-in-one/#%E5%9C%A8-linux-%E4%B8%8A%E9%83%A8%E7%BD%B2-kubecube>在 Linux 上部署 KubeCube</a></p></li><li><p><a href=https://www.kubecube.io/docs/installation-guide/all-in-one/#%E5%9C%A8-kubernetes-%E9%9B%86%E7%BE%A4%E4%B8%AD%E9%83%A8%E7%BD%B2-kubecube>在 Kubernetes 集群中部署 KubeCube</a></p></li></ol><h2 id=等待部署完成>等待部署完成</h2><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/complete-deploy.png alt=complete-deploy></p><h2 id=使用-admin-账户登陆-console>使用 admin 账户登陆 console</h2><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p></div><div class=td-content style=page-break-before:always><h1 id=pg-322fe91cfeb0a2834839485610f79c0a>2.2 - 快速体验</h1><h2 id=创建租户项目空间>创建租户、项目、空间</h2><p>使用管理员账号登录后，展开左侧【组织管理】菜单，点击快速向导。</p><p>1、创建租户</p><ul><li>租户名称：平台内展示的租户名。</li><li>租户标识：<ul><li>长度不得少于2位且不大于32位；</li><li>只能包含小写字母、数字，以及中划线 ‘-’ ；</li><li>全局唯一标识，不允许重复，不允许修改。</li></ul></li><li>租户管理员：添加用户 admin 到租户中并作为租户管理员。</li></ul><p><img src=/imgs/quick-start/quick-experience/create-tenant.png alt=create-tenant></p><p>详细配置说明见 <a href=https://www.kubecube.io/docs/user-guide/administration/tenant/>租户管理</a> 。</p><p>点击【创建】，如图，即创建了租户：&ldquo;tenant-1&rdquo;。</p><p>2、租户配额</p><p>选择租户，以及集群，填写资源配额：</p><ul><li>集群可分配：表示该集群剩余可分配资源。</li><li>租户已分配：表示该租户下所有 namespace 已分配的资源总和。</li></ul><p><img src=/imgs/quick-start/quick-experience/tenant-quota.png alt=tenant-quota></p><p>详细配置说明见 <a href=https://www.kubecube.io/docs/user-guide/administration/quota/>配额管理</a> 。</p><p>点击【创建】，即完成该租户的配额设置。</p><p>3、创建项目</p><ul><li>租户：该项目的所属租户；</li><li>项目名称：项目的展示名称；</li><li>项目标识：<ul><li>长度不得少于2位且不大于32位；</li><li>只能包含小写字母、数字，以及中划线 ‘-’ ；</li><li>全局唯一标识，不允许重复，不允许修改。</li></ul></li><li>项目描述：对该项目的描述性语言。</li><li>项目管理员：选择平台内的用户，作为该项目的管理员。</li></ul><p><img src=/imgs/quick-start/quick-experience/create-project.png alt=create-project></p><p>详细配置说明见 <a href=https://www.kubecube.io/docs/user-guide/administration/tenant/>租户管理</a> -【项目管理】。</p><p>点击【创建】，如图，即在租户 &ldquo;tenant-1&rdquo; 下创建了项目：&ldquo;project-1&rdquo;。</p><p>4、添加项目成员</p><p>选择租户和项目，将用户添加到租户或项目中，并给其分配角色。</p><p>详细配置说明见 <a href=https://www.kubecube.io/docs/user-guide/administration/tenant/>租户管理</a> -【成员管理】。</p><p><img src=/imgs/quick-start/quick-experience/add-project-member.png alt=add-project-member></p><p>点击【创建】，如图，即为将用户 admin 添加到项目 &ldquo;project-1&rdquo; 中，并作为该项目的项目管理员。</p><p>5、创建空间</p><p>选择集群、租户和项目，填写空间名称以及资源配额，点击【创建】。</p><p>详细配置说明见 <a href=https://www.kubecube.io/docs/user-guide/administration/quota/>配额管理</a> 中的【空间管理】。</p><p><img src=/imgs/quick-start/quick-experience/create-namespace.png alt=create-namespace></p><p>点击创建，如图，即为在管控集群的 &ldquo;project-1&rdquo; 项目下创建了一个空间 &ldquo;namespace-1&rdquo;。</p><h2 id=创建工作负载>创建工作负载</h2><h3 id=创建-deployment>创建 Deployment</h3><p>点击右上角【切换到控制台】，进入空间展示的界面。在左上角选择租户和项目，并选择项目下的空间，进入控制台。</p><p>展开左侧【工作负载】菜单，点击【Deployments】，进入 Deployment 管理页面。</p><p>点击【部署】，进入 deployment 的具体设置，如下图所示。</p><p><img src=/imgs/quick-start/quick-experience/create-deploy-1.png alt=create-namespace></p><p><img src=/imgs/quick-start/quick-experience/create-deploy-2.png alt=create-namespace></p><p><img src=/imgs/quick-start/quick-experience/create-deploy-3.png alt=create-namespace></p><p>上图展示的示例为，创建一个副本数为1的 Deployment：“deploy-1”， 容器中的镜像为：hub.c.163.com/kubecube/demo:v0。</p><p>创建成功后结果如下：</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/Deployment/deploy-manage.png alt=deploy-manage></p><p>详细配置说明见 <a href=https://www.kubecube.io/docs/user-guide/ns-scoped-res/workload/deployment/>Deployment管理</a> 。</p><h3 id=创建-service>创建 Service</h3><p>展开左侧【服务与发现】菜单，点击【Services】，进入 Service 管理页面。</p><p>点击【创建服务】，选择已创建的 Deployment，如下图创建 Service。点击【立即创建】。</p><p><img src=/imgs/quick-start/quick-experience/create-service.png alt=create-service></p><p>详细配置说明见 <a href=https://www.kubecube.io/docs/user-guide/ns-scoped-res/service-discovery/service/>Service管理</a> 。</p><h3 id=创建ingress>创建Ingress</h3><p>展开左侧【服务与发现】菜单，点击【Ingresses】，进入 Ingress 管理页面。</p><p>点击【创建负载均衡】，选择已创建的 Service，如下图创建 Ingress。点击【立即创建】。</p><p><img src=/imgs/quick-start/quick-experience/create-ingress.png alt=create-ingress></p><p>详细配置说明见 <a href=https://www.kubecube.io/docs/user-guide/ns-scoped-res/service-discovery/ingress/>Ingress管理</a> 。</p><p>在本地访问镜像中接口：</p><p><code>curl -H 'Host:foo.bar.com' {部署ingress节点IP}/healthz</code>, 则会返回以下结果，说明以上内容部署成功：</p><p><img src=/imgs/quick-start/quick-experience/create-ingress-2.png alt=create-ingress></p></div><div class=td-content style=page-break-before:always><h1 id=pg-1e29a42acbd6dbfaaa05d7c92ca5ccc5>3 - 部署指南</h1></div><div class=td-content><h1 id=pg-1db6edd6ea06d95f092948473e91f961>3.1 - 部署环境要求</h1><p>在进行 All In One 或者多节点部署之前，请按照以下内容确认环境要求</p><h1 id=系统版本及硬件要求>系统版本及硬件要求</h1><table><thead><tr><th style=text-align:left>操作系统</th><th style=text-align:left>最低要求</th></tr></thead><tbody><tr><td style=text-align:left><strong>Ubuntu</strong> <em>16.04, 18.04</em></td><td style=text-align:left>CPU：4 核，内存：8 G，磁盘空间：20 G</td></tr><tr><td style=text-align:left><strong>Debian</strong> <em>Buster, Stretch</em></td><td style=text-align:left>CPU：4 核，内存：8 G，磁盘空间：20 G</td></tr><tr><td style=text-align:left><strong>CentOS</strong> <em>7</em>.x</td><td style=text-align:left>CPU：4 核，内存：8 G，磁盘空间：20 G</td></tr><tr><td style=text-align:left><strong>Kylin</strong> <em>v10</em></td><td style=text-align:left>CPU：4 核，内存：8 G，磁盘空间：20 G</td></tr></tbody></table><table><thead><tr><th style=text-align:left>OS ARCH</th><th style=text-align:left>硬件要求</th></tr></thead><tbody><tr><td style=text-align:left><strong>AMD 64</strong></td><td style=text-align:left>Intel 系列，AMD 系列</td></tr><tr><td style=text-align:left><strong>ARM 64</strong></td><td style=text-align:left>Phytium 2000（国产化arm64芯片理论上都支持，但未经过充分测试）</td></tr></tbody></table><blockquote><p>以上系统配置要求适用于 KubeCube 默认最小化 All In One 模式安装，如需启动更多可插拔组件和拓展功能，建议机器配置为 8 核 CPU 和 16 G 内存</p></blockquote><h1 id=容器运行时>容器运行时</h1><table><thead><tr><th style=text-align:left>支持的容器运行时</th><th style=text-align:left>版本</th></tr></thead><tbody><tr><td style=text-align:left>Docker</td><td style=text-align:left>19.3.12+</td></tr></tbody></table><blockquote><p>节点上若无容器运行时，部署脚本将自动安装 docker 19.03.12 作为容器运行时</p></blockquote><h1 id=kubernetes-版本>Kubernetes 版本</h1><p>KubeCube 支持的 k8s 版本为 v1.18 ~ v1.21
KubeCube 部署脚本支持的 k8s 版本为 v1.18.20、v1.19.13、v1.20.9、v1.21.2</p><h1 id=前置准备>前置准备</h1><p>在使用部署脚本开始 KubeCube 的安装时，脚本会检测环境，并提示需要安装缺失的依赖</p><p><img src=/imgs/installation-guide/requirement/env-check.png alt=env-check></p><h1 id=监控组件说明>监控组件说明</h1><p>KubeCube 会默认安装 Prometheus 等监控组件，如果选择在已有k8s集群中部署 KubeCube，并且集群中已安装 Mertics Server，安装 KubeCube 后 Prometheus 会和 Mertics Server 产生冲突，导致监控功能不可用。需要在安装 KubeCube 后执行以下步骤：</p><ol><li><p>点击页面右上角【切换到控制台】，点击任意空间，进入到控制台页面；</p></li><li><p>在左侧菜单栏点击【自定义资源CRD】，进入到集群级别 CRD 列表，可以点击右上方输入 “hotplug” 进行搜索，找到 “hotplugs.hotplug.kubecube.io” CRD，点击【v1】版本进入 CRD 详情页；</p></li><li><p>选择 common 实例，点击【设置YAML】，找到 spec.component. name=kubecube-monitoring，添加环境变量 prometheusAdapter.enabled=false，如：</p></li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      grafana:
</span><span style=color:#8f5902;font-style:italic>        enabled: false
</span><span style=color:#8f5902;font-style:italic>      prometheus:
</span><span style=color:#8f5902;font-style:italic>        prometheusSpec:
</span><span style=color:#8f5902;font-style:italic>          externalLabels:
</span><span style=color:#8f5902;font-style:italic>            cluster: &#34;{{.cluster}}&#34;
</span><span style=color:#8f5902;font-style:italic>          remoteWrite:
</span><span style=color:#8f5902;font-style:italic>          - url: http://10.173.32.129:31291/api/v1/receive
</span><span style=color:#8f5902;font-style:italic>      prometheusAdapter:</span><span style=color:#f8f8f8;text-decoration:underline>      
</span><span style=color:#f8f8f8;text-decoration:underline>  			</span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring-15.4.10.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-de08bc857408c1d7d04984f8cd8ec887>3.2 - All In One 最小化部署</h1><p>对于想要快速开始、快速体验的用户来说，All In One 是最佳的安装方式</p><h2 id=在-linux-上部署-kubecube>在 Linux 上部署 KubeCube</h2><h3 id=开始安装>开始安装</h3><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h2 id=等待部署完成>等待部署完成</h2><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/complete-deploy.png alt=complete-deploy></p><h2 id=使用-admin-账户登陆-console>使用 admin 账户登陆 console</h2><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p></div><div class=td-content style=page-break-before:always><h1 id=pg-67c040d48750e52542d0a8f9af73ccd1>3.3 - 在已有k8s集群中部署KubeCube</h1><h2 id=在-kubernetes-集群中部署-kubecube>在 Kubernetes 集群中部署 KubeCube</h2><h3 id=修改-kubernetes-api-server-配置>⚠️修改 Kubernetes API-Server 配置</h3><p><strong>必要性</strong></p><ol><li><p>KubeCube 对多集群提供统一的认证和鉴权服务，需要使用 k8s api-server 的 auth-webhook 能力来做拓展。</p></li><li><p>KubeCube 提供对 k8s-apiserver 日志进行审计的能力，这需要为 k8s api-server 指定审计服务后端。</p></li></ol><p><strong>修改操作</strong></p><p>如果您的 k8s api-server 服务是以 deployment 形式运行的，请直接修改 deployment ；如果您的 k8s api-server 服务是以 static pod 形式运行的，您需要修改对应的 manifest 文件，它的文件路径通常为 <code>/etc/kubernetes/manifests/kube-apiserver.yaml</code> ，修改内容如下：</p><pre><code>apiVersion: v1
kind: Pod
metadata:
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
    - command:
        - kube-apiserver
        - --audit-log-format=json
        - --audit-log-maxage=10
        - --audit-log-maxbackup=10
        - --audit-log-maxsize=100
        - --audit-log-path=/var/log/audit
        - --audit-policy-file=/etc/cube/audit/audit-policy.yaml
        - --audit-webhook-config-file=/etc/cube/audit/audit-webhook.config
        - --authentication-token-webhook-config-file=/etc/cube/warden/webhook.config
      name: kube-apiserver
      volumeMounts:
        - mountPath: /var/log/audit
          name: audit-log
        - mountPath: /etc/cube
          name: cube
          readOnly: true
  volumes:
    - hostPath:
        path: /var/log/audit
        type: DirectoryOrCreate
      name: audit-log
    - hostPath:
        path: /etc/cube
        type: DirectoryOrCreate
      name: cube
</code></pre><h3 id=开始安装>开始安装</h3><p>在 Linux 机器上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h3 id=设置安装脚本参数>设置安装脚本参数</h3><p>该安装模式下，需要修改以下参数：</p><p>INSTALL_KUBECUBE_MEMBER=&ldquo;false&rdquo;</p><p>MASTER_IP="${node ip}"</p><blockquote><p>${node ip} 表示你运行脚本所在 node 机器的 ip，该 node 需要可操作 kubectl</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;x.x.x.x&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>MASTER_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h2 id=等待部署完成>等待部署完成</h2><p>KubeCube 部署完成后，请根据提示信息登陆 console 管理页面</p><p><img src=/imgs/installation-guide/All-In-One/complete-deploy.png alt=complete-deploy></p><h2 id=使用-admin-账户登陆-console>使用 admin 账户登陆 console</h2><p>⚠️请在登陆后修改 admin 用户的密码</p><p><img src=/imgs/installation-guide/All-In-One/login-console.png alt=login-console></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d6af954d38ce3c01b9442434e9947c66>3.4 - 添加计算集群</h1><p>KubeCube 可以添加其它集群作为计算集群，前提是，计算集群能够访问管控集群的 k8s api-server 和 KubeCube，默认情况下 KubeCube 使用 NodePort 对外暴露服务，用户可自行使用 ingress 进行暴露</p><h2 id=方式一部署新集群并添加>方式一：部署新集群并添加</h2><p>在 linux 机器上，需要构建 Kubernetes 集群并安装 KubeCube 依赖项</p><h3 id=开始安装>开始安装</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><h3 id=设置安装脚本参数>设置安装脚本参数</h3><p>该安装模式下，需要修改以下参数：</p><p>INSTALL_KUBECUBE_PIVOT=&ldquo;false&rdquo;</p><p>INSTALL_KUBECUBE_MEMBER=&ldquo;true&rdquo;</p><p>INSTALL_KUBERNETES=&ldquo;true&rdquo;</p><p>MEMBER_CLUSTER_NAME=&ldquo;member-1&rdquo;</p><p>MASTER_IP="${node ip}"</p><p>KUBECUBE_HOST="${pivot node ip}"</p><blockquote><p>MEMBER_CLUSTER_NAME 表示计算集群的名字，注意，不能与已有的计算集群名称同名
${node ip} 表示你运行脚本所在 node 机器的 ip，该 node 需要可操作 kubectl
${pivot node ip} 表示管控集群 node 机器的 ip，用于向 KubeCube 注册集群</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;member-1&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;x.x.x.x&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;y.y.y.y&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>MASTER_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h2 id=方式二纳管已有集群>方式二：纳管已有集群</h2><p>添加已有集群需要从 console 页面获取添加集群的定制脚本</p><h3 id=在-console-页面中获取添加集群的脚本>在 console 页面中获取添加集群的脚本</h3><p><img src=/imgs/installation-guide/add-member-k8s/add-member-cluster.png alt=add-member-cluster></p><h3 id=使用脚本添加集群>使用脚本添加集群</h3><p>在集群的 node 机器上，使用从 console 中下载的脚本，该机器需要能够执行 kubectl</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>/bin/bash add_cluster.sh
</code></pre></div><h2 id=等待集群添加完成>等待集群添加完成</h2><p><img src=/imgs/installation-guide/add-member-k8s/add-cluster.png alt=add-cluster></p><h2 id=在-console-中确认新集群>在 console 中确认新集群</h2><p><img src=/imgs/installation-guide/add-member-k8s/check-cluster.png alt=check-cluster></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f32f2b77d800b03d009916d3824443f7>3.5 - 添加节点</h1><p>KubeCube 提供为已有集群添加节点的能力</p><p>⚠️ 注意 node 机器需要能够通过 ssh 访问 master 机器，支持公钥和密码两种 ssh 方式，执行脚本前可以在 node 上 ssh 到 master 测试连通性</p><h2 id=向集群添加工作节点>向集群添加工作节点</h2><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>tip: 你可以通过预先下载离线包和镜像来减少部署时间</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>PRE_DOWNLOAD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入集群</p><ul><li>MASTER_IP 为 master 节点 ip</li><li>LOCAL_IP 为新节点 ip</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>MASTER_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h2 id=向集群的-control-plane-添加-master-节点>向集群的 control-plane 添加 master 节点</h2><p>在新节点上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待新节点加入 control-plane</p><ul><li>MASTER_IP 需要填已有的 master 节点 ip</li><li>LOCAL_IP 需要填新节点的节点 ip</li><li>CONTROL_PLANE_ENDPOINT 为高可用 vip</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-control-plane&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.10&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>MASTER_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-0b6cd8b8dc55139a7a4f574fb60eebec>3.6 - 多节点高可用部署</h1><p>本文提供 Kubernetes 的高可用部署和 KubeCube 的高可用部署方案，VIP 的实现需要用户自行提供</p><h2 id=主机规划>主机规划</h2><table><thead><tr><th style=text-align:left>IP 地址</th><th style=text-align:left>主机名</th><th style=text-align:left>角色</th></tr></thead><tbody><tr><td style=text-align:left>10.173.32.2</td><td style=text-align:left>lb1</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.3</td><td style=text-align:left>lb2</td><td style=text-align:left>Keepalived & HAproxy</td></tr><tr><td style=text-align:left>10.173.32.4</td><td style=text-align:left>master1</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.5</td><td style=text-align:left>master2</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.6</td><td style=text-align:left>master3</td><td style=text-align:left>master, etcd</td></tr><tr><td style=text-align:left>10.173.32.7</td><td style=text-align:left>worker1</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.8</td><td style=text-align:left>worker2</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.9</td><td style=text-align:left>worker3</td><td style=text-align:left>worker</td></tr><tr><td style=text-align:left>10.173.32.10</td><td style=text-align:left></td><td style=text-align:left>vip 地址</td></tr></tbody></table><blockquote><p>⚠️master2、master3、worker1、worker2、worker3 需要能够通过密钥或者密码 ssh 访问 master1</p></blockquote><h2 id=部署高可用-kubernetes>部署高可用 Kubernetes</h2><h3 id=开始安装>开始安装</h3><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 Kubernetes 安装完成</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-plane-master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.10&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>MASTER_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h3 id=master2-节点加入-control-plane>master2 节点加入 control-plane</h3><p>在 master2 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 master2 加入 control-plane</p><blockquote><p>master3 加入 control-plane 与此类似，仅需修改 <code>LOCAL_IP</code>为<code>10.173.32.6</code></p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-control-plane&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.10&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>MASTER_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h3 id=worker1-作为工作节点加入集群>worker1 作为工作节点加入集群</h3><p>在 worker1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 worker1 加入集群</p><blockquote><p>worker2 和 worker3 加入集群的方式与之类似，仅需修改<code>LOCAL_IP</code>为本机 IP 即可</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;node-join-master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>MASTER_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><h2 id=部署高可用-kubecube>部署高可用 KubeCube</h2><p>在 master1 上执行部署脚本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v1.0.0
</code></pre></div><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>export</span> <span style=color:#000>CUSTOMIZE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#000;font-weight:700>;</span>curl -fsSL https://kubecube.nos-eastchina1.126.net/kubecube-installer/<span style=color:#4e9a06>${</span><span style=color:#000>KUBECUBE_VERSION</span><span style=color:#4e9a06>}</span>/entry.sh <span style=color:#000;font-weight:700>|</span> bash
</code></pre></div><p>设置脚本参数，并按照提示继续运行安装脚本并等待 KubeCube 部署完成</p><ul><li>install.conf</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># if install kubecube on pivot cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_PIVOT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span>

<span style=color:#8f5902;font-style:italic># if install kubecube on member cluster</span>
<span style=color:#000>INSTALL_KUBECUBE_MEMBER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># if install k8s</span>
<span style=color:#000>INSTALL_KUBERNETES</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;false&#34;</span>

<span style=color:#8f5902;font-style:italic># there are four node mode below:</span>
<span style=color:#8f5902;font-style:italic># &#34;master&#34; : node will be installed as a master of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-master&#34; : node will be install as a worker of cluster to join master</span>
<span style=color:#8f5902;font-style:italic># &#34;control-plane-master&#34; : node will be installed as a master to control plane of cluster</span>
<span style=color:#8f5902;font-style:italic># &#34;node-join-control-plane&#34; : node will be installed as a master to join control plane</span>
<span style=color:#000>NODE_MODE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;control-plane-master&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when INSTALL_KUBECUBE_MEMBER=&#34;true&#34;</span>
<span style=color:#8f5902;font-style:italic># this value is the name of member cluster you</span>
<span style=color:#8f5902;font-style:italic># want to take over</span>
<span style=color:#000>MEMBER_CLUSTER_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be set when NODE_MODE=&#34;control-plane-master&#34;</span>
<span style=color:#8f5902;font-style:italic># or &#34;node-join-control-plane&#34;</span>
<span style=color:#000>CONTROL_PLANE_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span> <span style=color:#8f5902;font-style:italic>#{ip}:{port} , dns</span>

<span style=color:#8f5902;font-style:italic># master ip means master node ip of cluster</span>
<span style=color:#000>MASTER_IP</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;10.173.32.4&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># KUBECUBE_HOST must be set when as a member cluster to</span>
<span style=color:#8f5902;font-style:italic># join pivot cluster, the value is pivot node ip</span>
<span style=color:#000>KUBECUBE_HOST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># zone has two choice</span>
<span style=color:#8f5902;font-style:italic># 1. &#34;cn&#34; : in mainland</span>
<span style=color:#8f5902;font-style:italic># 2. &#34;others&#34; : out of mainland</span>
<span style=color:#000>ZONE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;cn&#34;</span>

<span style=color:#8f5902;font-style:italic># k8s version you want to install</span>
<span style=color:#000>KUBERNETES_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1.20.9&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># the user who can access master node, it can be empty</span>
<span style=color:#8f5902;font-style:italic># when NODE_MODE=&#34;master&#34; or &#34;control-plane-master&#34;</span>
<span style=color:#000>MASTER_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PRIVATE_KEY_PATH set</span>
<span style=color:#8f5902;font-style:italic># password for master user to access master node</span>
<span style=color:#000>ACCESS_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>

<span style=color:#8f5902;font-style:italic># +optional</span>
<span style=color:#8f5902;font-style:italic># must be empty when ACCESS_PASSWORD set</span>
<span style=color:#8f5902;font-style:italic># ACCESS_PRIVATE_KEY for master user to access master node</span>
<span style=color:#000>ACCESS_PRIVATE_KEY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/root/.ssh/id_rsa&#34;</span>
</code></pre></div><ul><li>cube.conf</li></ul><p>将<code>kubecube_replicas</code>设置为3，使得 KubeCube 使用 3 副本部署，并且由于<code>podAntiAffinity</code>，它们会运行在非<code>controlPlane</code>的节点上，并且每个节点仅运行单个副本</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># custom values for kubecube</span>

<span style=color:#000>kubecube_replicas</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
<span style=color:#000>kubecube_args_logLevel</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;info&#34;</span>
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f5169ff9c0f450b889113b10c519efce>3.7 - 热插拔</h1><p>热插拔是通过修改配置文件实现不停机更新监控、日志、审计等组件的启停和配置。</p><h2 id=热插拔>热插拔</h2><p>热插拔的实现是基于 helm ，因此集群需要预先安装好 helm3 版本。</p><p>登录管控 k8s 集群，执行命令可以查看热插拔配置</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># kubectl get hotplug</span>
NAME            PHASE     AGE
common          running   23h
pivot-cluster   running   16d
</code></pre></div><p>其中：</p><ul><li><p><code>common</code> 表示公共的热插拔配置，<code>pivot-cluster</code> 表示 pivot-cluster 这个 k8s 集群的热插拔配置。</p></li><li><p>允许自定义各个集群的热插拔配置覆盖 common 热插拔配置实现个性化配置 k8s 集群组件热插拔。</p></li><li><p>热插拔配置的 <code>.metadata.name</code> 要求与k8s集群名称一致，所有 k8s 集群信息查看命令为 <code>kubectl get cluster</code>。</p></li></ul><h2 id=common配置说明>Common配置说明</h2><p>目前，默认的 common 配置包括以下几个组件：</p><p><code>audit</code>：操作审计</p><p><code>logseer</code>：日志管理组件，仅在管控集群安装</p><p><code>logagent</code>：日志采集代理组件</p><p><code>kubecube-monitoring</code>：监控 prometheuse 组件</p><p><code>kubecube-thanos</code>：监控 thanos 组件，仅在管控集群安装</p><p>示例如下：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hotplug.kubecube.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hotplug</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubecube.io/sync</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>					</span><span style=color:#8f5902;font-style:italic>## 同步信号，kubecube会将这个配置同步到各个集群</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>common                                 </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 公共配置为cmmon，其余集群特殊配置为集群名字</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>component</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>audit                                </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 审计日志</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer                              </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 日志管理组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer-v1.0.0.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled                           </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 启停标识：这里disabled为禁用</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logagent                             </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 日志采集代理组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logagent</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logagent-v1.0.0.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled                            </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 启停标识：这里enabled为启用</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>|                                     </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 环境变量</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>clustername</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;{{.cluster}}&#34;</span><span style=color:#f8f8f8;text-decoration:underline>               </span><span style=color:#8f5902;font-style:italic>## {{.cluster}} 程序会自动注入集群名字替换</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring                  </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 监控组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring-15.4.7.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      grafana:
</span><span style=color:#8f5902;font-style:italic>        enabled: false
</span><span style=color:#8f5902;font-style:italic>      prometheus:
</span><span style=color:#8f5902;font-style:italic>        prometheusSpec:
</span><span style=color:#8f5902;font-style:italic>          externalLabels:
</span><span style=color:#8f5902;font-style:italic>            cluster: &#34;{{.cluster}}&#34;
</span><span style=color:#8f5902;font-style:italic>          remoteWrite:
</span><span style=color:#8f5902;font-style:italic>          - url: http://10.173.32.42:31291/api/v1/receive</span><span style=color:#f8f8f8;text-decoration:underline>      
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-thanos                      </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 监控thanos组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>thanos-3.18.0.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>                                         </span><span style=color:#8f5902;font-style:italic>## message显示各个组件运行状态，phase显示总体运行状态</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{&#34;kubecube-monitoring&#34;:&#34;release is running&#34;,&#34;kubecube-thanos&#34;:&#34;release    
</span><span style=color:#4e9a06>    is running&#34;,&#34;logagent&#34;:&#34;release is running&#34;,&#34;logseer&#34;:&#34;release is running&#34;}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>phase</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>running</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>每一个组件基本包含5个要素，在 <code>spec.component</code> 下：</p><p>name：组件名称</p><p>namespace：指定组件部署的命名空间，若指定的命名空间不存在，会自动以该字段值去创建一个命名空间。</p><p>pkgName：安装包名称，安装包默认存放路径为 warden 容器里的 /root/helmchartpkg，以 emptydir 形式存在。</p><p>status：组件是否启用</p><p>env：环境变量配置</p><p>每一个要素都可以使用集群独特配置进行覆盖，未覆盖的要素则依然使用 common 里的配置。</p><h2 id=管控集群配置说明>管控集群配置说明</h2><p>Pivot-cluster 配置是管控集群配置，即 KubeCube 所在的集群。集群独特的配置会与 common 的配置结合，用于个性化配置集群组件，结合时遇到相同字段pivot-cluster 优先。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>hotplug.kubecube.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Hotplug</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>kubecube.io/sync</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#8f5902;font-style:italic>## 同步信号，kubecube会将这个配置同步到其他集群</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>pivot-cluster                  </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 与集群名字一致，指明这是pivot-cluster这个集群的热插拔配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>component</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer                      </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 日志管理组件</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled                    </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>## 结合common设置为disabled，这里设置为enabled，标识其余集群不启用，pivot-cluster集群启用</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      grafana:
</span><span style=color:#8f5902;font-style:italic>        enabled: true
</span><span style=color:#8f5902;font-style:italic>      prometheus:
</span><span style=color:#8f5902;font-style:italic>        prometheusSpec:
</span><span style=color:#8f5902;font-style:italic>          externalLabels:
</span><span style=color:#8f5902;font-style:italic>            cluster: &#34;{{.cluster}}&#34;
</span><span style=color:#8f5902;font-style:italic>          remoteWrite:
</span><span style=color:#8f5902;font-style:italic>          - url: http://thanos-receive:19291/api/v1/receive</span><span style=color:#f8f8f8;text-decoration:underline>      
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-thanos</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>      receive:
</span><span style=color:#8f5902;font-style:italic>        replicaCount: 1
</span><span style=color:#8f5902;font-style:italic>        replicationFactor: 1</span><span style=color:#f8f8f8;text-decoration:underline>      
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>message</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#39;{&#34;kubecube-monitoring&#34;:&#34;release is running&#34;,&#34;kubecube-thanos&#34;:&#34;release
</span><span style=color:#4e9a06>    is running&#34;,&#34;logagent&#34;:&#34;release is running&#34;,&#34;logseer&#34;:&#34;release is running&#34;}&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>phase</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>running</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6818a5107747076ce7e60a61671c142d>3.8 - 已有系统接入</h1></div><div class=td-content><h1 id=pg-55566b3f6f2b6ad97ca706cd58808143>3.8.1 - Prometheus</h1><p>KubeCube 在部署时会自动安装 Prometheus 等监控组件，以实现监控功能。本文档介绍了如何在 KubeCube 中接入用户已有的 Prometheus。</p><h2 id=准备工作>准备工作</h2><ol><li><p>在集群部署好 Prometheus，Prometheus 可以正常监控到集群资源的数据；</p></li><li><p>在集群中部署好 KubeCube；</p><p>说明：部署好 KubeCube 后，由于集群内已有 Prometheus operator，多个 operator 会导致集群内 Prometheus 相关功能不可用，需要卸载 KubeCube 监控组件或删除本地 operator。</p></li><li><p>以平台管理员角色登录 KubeCube 管控集群。</p></li></ol><h2 id=步骤>步骤</h2><h3 id=1添加-label>1、添加 Label</h3><p>由于 KubeCube 需要实现多集群监控，因此在 KubeCube 查询监控数据时，都会在 query 表达式中添加 <code>cluster={clusterName}</code> 来进行集群过滤。用户需要在 Prometheus 的 exporter 中添加这一 label，前端查询监控数据时才能查询到结果。</p><h3 id=2卸载-kubecube-监控组件>2、卸载 KubeCube 监控组件</h3><p>方式一 页面操作：</p><ol><li><p>点击页面右上角【切换到控制台】，点击任意空间，进入到控制台页面；</p></li><li><p>在左侧菜单栏点击【自定义资源CRD】，进入到集群级别 CRD 列表，可以点击右上方输入 “hotplug” 进行搜索，找到 “hotplugs.hotplug.kubecube.io” CRD，点击【v1】版本进入 CRD 详情页；</p></li><li><p>选择 common 实例，点击【设置YAML】，找到 spec.component. name=kubecube-monitoring，将 “status” 改成 “disabled”，即卸载 KubeCube 自带监控组件。</p></li></ol><p>方式二 命令行操作：</p><ol><li><code>kubectl edit hotplug common</code></li><li>找到 spec.component. name=kubecube-monitoring，将 “status” 改成 “disabled”。</li></ol><p>详细配置说明见 <a href=https://www.kubecube.io/docs/installation-guide/enable-plugins/>热插拔</a> 。</p><h3 id=3部署-servicemonitor>3、部署 ServiceMonitor</h3><h4 id=查看集群资源>查看集群资源</h4><p>查看控制台内监控数据，需要部署两个 ServiceMonitor：kubelet 和 kube-state-metrics 的 ServiceMonitor，样例如下：</p><ul><li><p>部署 kubecube-monitoring-kubelet</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>monitoring.coreos.com/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceMonitor</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring-kubelet</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>bearerTokenFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>honorLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>relabelings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>sourceLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>__metrics_path__</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metrics_path</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tlsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>caFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>insecureSkipVerify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>bearerTokenFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>honorLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/metrics/cadvisor</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>relabelings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>sourceLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>__metrics_path__</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metrics_path</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tlsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>caFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>insecureSkipVerify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>bearerTokenFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/token</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>honorLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/metrics/probes</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>relabelings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>sourceLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#000>__metrics_path__</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>targetLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>metrics_path</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>scheme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>tlsConfig</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>caFile</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>insecureSkipVerify</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>jobLabel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>k8s-app</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespaceSelector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchNames</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>kube-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>k8s-app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubelet</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li><li><p>部署 kubecube-monitoring-kube-state-metrics</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>monitoring.coreos.com/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceMonitor</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring-kube-state-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>endpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>honorLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app.kubernetes.io/instance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubecube-monitoring</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app.kubernetes.io/name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kube-state-metrics</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li></ul><h4 id=查看组件监控>查看组件监控</h4><p>当前 KubeCube 平台支持对组件的监控视图可视化查询，详细说明见 <a href=https://www.kubecube.io/docs/user-guide/monitoring/component-monitoring/>平台组件监控</a> 。接入外部监控后，用户可按需在集群内部署对应组件的 ServiceMonitor。</p><p>各个 ServiceMonitor 的 yaml 可参考 <a href=https://github.com/kubecube-io/charts/tree/main/kubecube-monitoring/templates/exporters>https://github.com/kubecube-io/charts/tree/main/kubecube-monitoring/templates/exporters</a>。</p><h3 id=4部署-dashboard>4、部署 Dashboard</h3><p>查看集群资源（控制台内监控数据），需要部署：</p><ul><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-cluster.yaml>cube-resource-cluster.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-namespace.yaml>cube-resource-namespace.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-node.yaml>cube-resource-node.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-persistentvolume.yaml>cube-resource-persistentvolume.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-pod.yaml>cube-resource-pod.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/cube-resource-workload.yaml>cube-resource-workload.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/default-rolebinding.yaml>default-rolebinding.yaml</a></li></ul><p>查看组件监控，可以部署对应的 Dashboard：</p><ul><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-control-plane-pods.yaml>component-control-plane-pods.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-coredns.yaml>component-coredns.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-etcd.yaml>component-etcd.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kube-apiserver.yaml>component-kube-apiserver.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kube-controller-manager.yaml>component-kube-controller-manager.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kube-proxy.yaml>component-kube-proxy.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kube-scheduler.yaml>component-kube-scheduler.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-kubelet.yaml>component-kubelet.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-prometheus.yaml>component-prometheus.yaml</a></li><li><a href=https://github.com/kubecube-io/charts/blob/main/kubecube-monitoring/templates/kubecube-addon/dashboards/component-thanos.yaml>component-thanos.yaml</a></li></ul><h3 id=5修改-nginx-配置>5、修改 Nginx 配置</h3><ol><li><p>使用命令行：<code>kubectl edit configmap nginx-config -n kubecube-system</code></p></li><li><p>找到原有的地址配置，修改为自有 Prometheus 地址</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#000>upstream monitoring {</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#000>server kubecube-thanos-query.kubecube-monitoring:9090;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>}<span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>即 将<code>kubecube-thanos-query.kubecube-monitoring:9090</code> 替换为外部地址。</p></li><li><p>重启 pod：<code>kubectl delete pod frontend-xxxxxx-xxxxx -n kubecube-system</code></p></li></ol><h3 id=heading></h3></div><div class=td-content style=page-break-before:always><h1 id=pg-3fdb9f53fbdf958554148e74555fe462>3.8.2 - ElasticSearch</h1><p>KubeCube 提供了日志服务和操作审计服务，默认关闭。用户在开启后，日志服务和操作审计服务均会将日志发送到 ElasticSearch 进行存储，由 ElasticSearch 对日志进行管理。用户可以在 <a href=https://www.kubecube.io/docs/installation-guide/enable-plugins/>热插拔</a> 中修改配置，安装内部 ElasticSearch，也可以配置外部的 ElasticSearch 地址，对接已有的 ElasticSearch。下面分别介绍如何在这两个功能中接入外部 ElasticSearch。</p><h2 id=日志>日志</h2><p>方式一 页面操作：</p><ol><li><p>点击页面右上角【切换到控制台】，点击任意空间，进入到控制台页面；</p></li><li><p>在左侧菜单栏点击【自定义资源CRD】，进入到集群级别 CRD 列表，可以点击右上方输入 “hotplug” 进行搜索，找到 “hotplugs.hotplug.kubecube.io” CRD，点击【v1】版本进入 CRD 详情页；</p></li><li><p>选择 common 实例，点击【设置YAML】，找到 spec.component. name=logseer，添加环境变量，如：</p></li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logseer-v1.0.0.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span><span style=color:#8f5902;font-style:italic>  </span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>elasticsearch-master.elasticsearch.svc</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>方式二 命令行操作：</p><ol><li><code>kubectl edit hotplug pivot-cluster</code></li><li>找到 spec.component. name=logseer，添加环境变量，同上。</li></ol><p>详细配置说明见 <a href=https://www.kubecube.io/docs/installation-guide/enable-plugins/>热插拔</a> 。</p><h2 id=操作审计>操作审计</h2><ol><li><p><code>kubectl edit deploy audit -n kubecube-system</code></p></li><li><p>添加环境变量：AUDIT_WEBHOOK_HOST、AUDIT_WEBHOOK_INDEX、AUDIT_WEBHOOK_TYPE，如</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_HOST</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http://elasticsearch-master.elasticsearch:9200</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_INDEX</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>audit</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_TYPE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li></ol><p>注：如果同时配置了内部和外部 ElasticSearch，审计日志将优先发到外部 ElasticSearch。</p><p>其他详细说明见：<a href=https://www.kubecube.io/docs/user-guide/administration/audit/>操作审计</a> 。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ecf7e357d2a131135219db95eddda49c>4 - 产品使用指南</h1></div><div class=td-content><h1 id=pg-991d31c65b93e655f58fd73d2744aa70>4.1 - 运维管理</h1></div><div class=td-content><h1 id=pg-882b3bb80d835340e02c570d9efc20ee>4.1.1 - 用户管理</h1><p>本文档介绍了如何在 KubeCube 上创建、管理用户。</p><h2 id=准备工作>准备工作</h2><p>使用平台管理员账号登录 KubeCube。</p><h2 id=新增用户>新增用户</h2><p>1、使用平台管理员账号登录 KubeCube 后，展开【组织管理】菜单，点击【用户管理】，进入用户管理页面。</p><p><img src=/imgs/user-guide/administration/user/user-manage.png alt=user-manage></p><p>2、点击【新增用户】，填写用户信息。</p><p><img src=/imgs/user-guide/administration/user/user-add.png alt=user-add></p><ul><li>登录账号：<ul><li>不能超过253个字符；</li><li>只能包含小写字母、数字，以及'-' 和 &lsquo;.'；</li><li>须以字母数字开头；</li><li>须以字母数字结尾；</li><li>全局唯一标识，不允许重复，不允许修改。</li></ul></li><li>用户名：<ul><li>平台内展示的用户名，默认为登录账号。</li></ul></li><li>密码：<ul><li>长度不得少于8位且不大于20位；</li><li>至少应包括字母、数字以及特殊符号中两类。</li></ul></li><li>电话：<ul><li>符合中国手机号规范，如188****1234；</li><li>选填。</li></ul></li><li>Email：<ul><li>符合日常邮件地址规范；</li><li>选填。</li></ul></li></ul><p>点击【确定】，即创建该用户。</p><p>3、如果需要批量创建用户，可以点击【批量导入】-【下载模版】，填写表格内容后上传文件，即可批量创建表格内填写的用户。表格填写规范同上。</p><p><img src=/imgs/user-guide/administration/user/user-import.png alt=user-import></p><h2 id=用户管理>用户管理</h2><p>使用平台管理员账号登录 KubeCube 后，展开【组织管理】菜单，点击【用户管理】，进入用户管理页面。</p><p><img src=/imgs/user-guide/administration/user/user-manage.png alt=user-manage></p><p>在用户管理页面，可以看到平台内的所有用户，包括每个用户的登录账号、用户名、类型、状态、上次登录IP以及上次登录时间。</p><ul><li>类型：用户的登录方式，如果是使用账号密码登录，则类型为 &ldquo;normal&rdquo;；如果为其他登录方式，如LDAP、Github等通过第三方平台认证登录，则类型为对应的第三方平台名称。目前 KubeCube 只支持密码登录方式。</li><li>状态：分为启用和禁用，启用状态用户可正常登录，禁用状态用户不可登录。</li></ul><p>同时，平台管理员可以在该界面修改用户信息，包括用户密码、用户名、电话以及 Email，规范同上。用户登录账号不支持修改。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-cc16e9ac86342c7d9c5ab1f4a64571b9>4.1.2 - 租户管理</h1><p>本文档介绍了如何在 KubeCube 上进行租户管理，并管理租户下的项目和成员。</p><h2 id=准备工作>准备工作</h2><p>使用平台管理员或租户管理员账号登录 KubeCube。</p><h2 id=租户管理>租户管理</h2><h3 id=新增租户>新增租户</h3><p>1、使用平台管理员账号登录 KubeCube，展开【组织管理】菜单，点击【租户管理】，进入租户管理页面。</p><p>2、点击【新增租户】，填写租户信息。</p><p><img src=/imgs/user-guide/administration/tenant/add-tenant.png alt=tenant-manage></p><ul><li>租户名称：平台内展示的租户名。</li><li>租户标识：<ul><li>长度不得少于2位且不大于32位；</li><li>只能包含小写字母、数字，以及中划线 &lsquo;-&rsquo; ；</li><li>全局唯一标识，不允许重复，不允许修改。</li></ul></li></ul><h3 id=租户管理-1>租户管理</h3><p>使用平台管理员账号登录 KubeCube，展开【组织管理】菜单，点击【租户管理】，进入租户管理页面，可以查看到平台下所有的租户；使用租户管理员账号登录，进入租户管理页面，可以查看到该租户管理员所管理的所有租户。</p><p>同时可以在该界面快捷添加成员、添加项目、修改租户名称。</p><p><img src=/imgs/user-guide/administration/tenant/tenant-manage.png alt=tenant-manage></p><h2 id=项目管理>项目管理</h2><p>在租户管理页面点击上方的【项目】，切换到项目管理页面。</p><p><img src=/imgs/user-guide/administration/tenant/project-manage.png alt=project-manage></p><p>点击【新增项目】，即可添加项目：</p><ul><li>所属租户：选择权限内的已有租户；</li><li>项目名称：项目的展示名称；</li><li>项目标识：<ul><li>长度不得少于2位且不大于32位；</li><li>只能包含小写字母、数字，以及中划线 &lsquo;-&rsquo; ；</li><li>全局唯一标识，不允许重复，不允许修改。</li></ul></li><li>项目描述：对该项目的描述性语言。</li></ul><p>添加项目成功后，也可以在该页面直接为该项目或其他项目添加项目成员。</p><h2 id=成员管理>成员管理</h2><p>在租户管理页面点击上方的到【成员】，切换到成员管理页面。</p><p><img src=/imgs/user-guide/administration/tenant/member-manage.png alt=member-manage></p><p>点击【添加成员】，即可为指定的租户或项目添加成员。</p><ul><li>所属租户：选择权限内的租户；</li><li>所属项目：选择所选租户下的项目，如果选择【不指定】，则为添加租户成员，否则为项目成员；</li><li>账号：选择平台内的用户；</li><li>角色：指定所选用户的角色，如果【所属项目】选择【不指定】，则角色可设置为租户管理员或普通成员；如果【所属项目】选择具体项目，则角色可设置为项目管理员或普通成员。</li></ul><p>添加成员成功后，可以在该页面进行租户成员和项目成员的管理。同时可以在右上方，根据租户、项目、角色对成员进行过滤和搜索。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e2d94e3b74b28c3cb9df52bbf9ca00b2>4.1.3 - 角色管理</h1><p>KubeCube 的角色管理基于 Kubernetes 的 RBAC 实现，对多集群提供了统一的认证鉴权功能</p><h2 id=内置角色>内置角色</h2><p>KubeCube 针对不同的层级，内置了相应的管理员角色和只有读权限的 reviewer 角色</p><table><thead><tr><th>权限\角色</th><th>platform-admin</th><th>tenant-admin</th><th>project-admin</th><th>reviewer</th></tr></thead><tbody><tr><td>集群管理</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>角色管理</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>角色查看</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>用户管理</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>节点管理</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>所有租户管理</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>所有租户成员管理</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>本租户管理</td><td>✓</td><td>✓</td><td></td><td></td></tr><tr><td>本租户成员管理</td><td>✓</td><td>✓</td><td></td><td></td></tr><tr><td>所有项目管理</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>所有项目成员管理</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>租户下项目管理</td><td>✓</td><td>✓</td><td></td><td></td></tr><tr><td>租户下项目成员管理</td><td>✓</td><td>✓</td><td></td><td></td></tr><tr><td>本项目管理</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>本项目成员管理</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>管理 namespace</td><td>✓</td><td></td><td></td><td></td></tr><tr><td>管理工作负载</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>管理卷</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>管理 service</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>管理 ingress</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>管理 secrets</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>管理 serviceaccout</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>管理 subnamespaceanchor</td><td>✓</td><td>✓</td><td>✓</td><td></td></tr><tr><td>查看工作负载</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td></tr><tr><td>查看卷</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td></tr><tr><td>查看 service</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td></tr><tr><td>查看 ingress</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td></tr><tr><td>查看 secrets</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td></tr><tr><td>查看 serviceaccout</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td></tr><tr><td>查看 subnamespaceanchor</td><td>✓</td><td>✓</td><td>✓</td><td>✓</td></tr></tbody></table><blockquote><p>KubeCube 使用 <a href=https://github.com/kubernetes-sigs/hierarchical-namespaces>HNC</a> 来实现 tenant、project 和 namespace 的层级，以及彼此之间的隔离；为了实现 namespace 层级的隔离，除 platform-admin 外所有角色，通过 subnamespaceanchor 资源来管理 namespace</p></blockquote><h2 id=管理角色>管理角色</h2><p>通过角色标签栏来选择角色层级，点击【添加角色】来新建自定义角色，【继承已有】会以本层级的 admin 角色为模版新建出角色，【自定义】可以自定义编辑新角色</p><p><img src=/imgs/user-guide/administration/role/add-role.png alt=add-role.png></p><p>通过勾选具体的权限项来自定义角色的权限，点击【修改】提交修改</p><p><img src=/imgs/user-guide/administration/role/mgr-role.png alt=mgr-role.png></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0a268df46e46cb89462ce4c8762d20b6>4.1.4 - 配额管理</h1><p>KubeCube 在 Kubernetes 原生的资源配额能力上进行了拓展，在租户层级即可对资源配额进行限制，在使用体验上与 Kubernetes 原生的 ResouceQuota 保持一致</p><blockquote><p>KubeCube 目前支持对 nvidia gpu 进行资源配额</p></blockquote><h2 id=资源配额结构>资源配额结构</h2><p><img src=/imgs/user-guide/administration/quota/resourcequota.png alt=resourcequota.png></p><p>资源配额的计算结构遵循以下约束：</p><ol><li>租户下 namespace 的资源配额总和 &lt; 租户配额</li><li>集群下租户的资源配额总和 &lt; 集群的物理资源</li></ol><blockquote><p>CubeResourceQuota 是 KubeCube 对于 namespace 级别的 ResourceQuota 的上层抽象，基于 CRD 实现</p></blockquote><h2 id=tenant-资源配额>Tenant 资源配额</h2><h3 id=前置要求>前置要求</h3><p>创建一个租户</p><h3 id=设置租户的资源配额>设置租户的资源配额</h3><p>选择租户，点击【调整配额】对指定集群下的租户进行资源配额的设置</p><p><img src=/imgs/user-guide/administration/quota/tenant-quota.png alt=tenant-quota.png></p><p>在可填框中填入期望设置的资源配额，点击【确定】保存配额设置</p><ul><li>【集群可分配】表示该集群剩余可分配资源</li><li>【租户已分配】表示该租户下所有 namespace 已分配的资源总和</li></ul><p><img src=/imgs/user-guide/administration/quota/modify-tenant-quota.png alt=modify-tenant-quota.png></p><h2 id=创建-namespace-并设置资源配额>创建 Namespace 并设置资源配额</h2><h3 id=前置要求-1>前置要求</h3><p>创建一个租户，在租户下创建项目</p><h3 id=设置-namespace-的资源配额>设置 namespace 的资源配额</h3><p>点击右上方【租户】选择框，选择租户，点击【创建空间】创建新的 namespace 并设置资源配额，也可以点击【修改】对已创建的 namespace 的资源配额进行修改</p><p><img src=/imgs/user-guide/administration/quota/ns-quota.png alt=ns-quota.png></p><p>创建 namespace 时，需要选择空间所属的集群、租户、项目，namespace 一旦创建，其所属关系不能更改。在可填框中填入期望的资源配额，点击【确定】使资源配额生效</p><p>【租户可分配】表示该 namespace 所属的租户所剩的可分配资源配额</p><p><img src=/imgs/user-guide/administration/quota/modify-ns-quota.png alt=modify-ns-quota.png></p></div><div class=td-content style=page-break-before:always><h1 id=pg-2306a8e0d2dc86a646a28d1621010f14>4.1.5 - K8s集群管理</h1></div><div class=td-content><h1 id=pg-62bae3e56f26c43c795878e3d6435987>4.1.5.1 - 多集群管理</h1><p>KubeCube 提供多集群管理的能力，可以基于管控集群添加或者删除集群，并对所有接管的集群提供统一的认证和鉴权入口</p><blockquote><p>⚠️ 计算集群信息不允许修改，若有修改需求，请先删除计算集群再重新添加，该操作存在的一定风险，删除计算集群期间，计算集群所有资源不受管控集群管控，认证和鉴权功能暂时关闭，直到该集群被重新添加</p></blockquote><h2 id=查看集群信息>查看集群信息</h2><p>选择集群查看对应的基本信息，Node、StorageClass、NetworkPolicy 以及 PV</p><p><img src=/imgs/user-guide/administration/k8s-cluster/multi-k8s-cluster-mgr/cluster-inspect.png alt=cluster-inspect></p><h2 id=添加计算集群>添加计算集群</h2><p><a href=https://www.kubecube.io/docs/installation-guide/add-member-k8s/#%E6%96%B9%E5%BC%8F%E4%B8%80%E9%83%A8%E7%BD%B2%E6%96%B0%E9%9B%86%E7%BE%A4%E5%B9%B6%E6%B7%BB%E5%8A%A0>部署新集群并添加</a></p><p><a href=https://www.kubecube.io/docs/installation-guide/add-member-k8s/#%E6%96%B9%E5%BC%8F%E4%BA%8C%E7%BA%B3%E7%AE%A1%E5%B7%B2%E6%9C%89%E9%9B%86%E7%BE%A4>纳管已有集群</a></p><h2 id=删除计算集群>删除计算集群</h2><p>点击【删除配置】来删除计算集群，管控集群无法通过 Console 删除。删除计算集群意味着 KubeCube 控制面不再接管该集群，该集群恢复被接管前的样子，集群上运行的工作负载、服务等不会受到影响，可以通过添加该集群来重新接管</p><p><img src=/imgs/user-guide/administration/k8s-cluster/multi-k8s-cluster-mgr/cluster-manager.png alt=cluster-manager></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5b8c71fac214fcac2dcfe6ebb573c677>4.1.5.2 - 集群级资源管理</h1></div><div class=td-content><h1 id=pg-b58c5b5952e588cce8ddd5fcb7b7c0cc>4.1.5.2.1 - 存储类别(StorageClass)</h1><p>KubeCube 提供对 k8s <a href=https://kubernetes.io/zh/docs/concepts/storage/storage-classes/>StorageClass</a> 资源的原生管理能力</p><h2 id=查看-storageclass>查看 StorageClass</h2><p>点击【集群管理】，选择需要查看的集群，点击【存储类别】，查看该集群中所有的 StorageClass，可以在右上角搜索栏中输入资源名称进行模糊匹配，点击【删除】可删除此 StorageClass</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/StorageClass/view-storageclass.png alt=view-storageclass></p><h2 id=创建-storageclass>创建 StorageClass</h2><p>点击【创建存储类别】来创建新的 StorageClass</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/StorageClass/create-storageclass.png alt=create-storageclass></p></div><div class=td-content style=page-break-before:always><h1 id=pg-84021fcd47af24336b3f2fa251e11490>4.1.5.2.2 - 存储声明(PV)</h1><p><a href=https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/>PersistentVolume</a> 应该由集群管理员事先提供，KubeCube 对其拥有查看和删除的能力</p><h2 id=查看-persistentvolume>查看 PersistentVolume</h2><p>点击【集群管理】，选择需要查看的集群，点击【持久存储】来查看 PersistentVolume 详情，点击【删除】可以删除该资源</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/PV/pv.png alt=pv></p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/PV/pv-view.png alt=pv-view></p></div><div class=td-content style=page-break-before:always><h1 id=pg-2faeb51dc0a9f8f4133fba56d59316c3>4.1.5.2.3 - 集群节点(Node)</h1><p>KubeCube 支持集群管理员通过 Console 页面管理各集群的 Node，也支持集群管理员直接使用黑屏操作对 各集群 Node 进行管理</p><h2 id=查看节点信息>查看节点信息</h2><p>点击 Node 名称来查看节点的具体信息，点击【更多】查看 Node 的所有标签，</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/Node/node-info.png alt=node-info></p><h2 id=添加节点>添加节点</h2><p>KubeCube 支持集群管理员通过黑屏操作来自行添加节点，也可以点击【添加节点】来使用 KubeCube 的脚本来进行节点添加</p><p>// todo：确认 master 和 node 节点的添加细节</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/Node/add-node.png alt=add-node></p><h2 id=节点操作>节点操作</h2><p>点击【编辑标签】来对节点的标签进行编辑</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/Node/edit-node.png alt=edit-labels></p><p>点击【禁止调度】来限制 pod 调度到该节点</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/Node/no-schedual.png alt=no-schedual></p><p>点击【更多】来对节点进行更多高级操作，包括：设置节点类型、设置污点、平滑迁移等</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/Node/edit-node.png alt=edit-node></p></div><div class=td-content style=page-break-before:always><h1 id=pg-cb1dd5ef4d6788bbe75c885d770b9a12>4.1.5.2.4 - 网络策略(NetworkPolicy)</h1><p><a href=https://kubernetes.io/zh/docs/concepts/services-networking/network-policies/>NetworkPolicy</a> 依赖 CNI 实现，创建一个 NetworkPolicy 资源对象而没有控制器来使它生效的话，是没有任何作用的，KubeCube 默认使用 calico</p><h2 id=查看-networkpolicy>查看 NetworkPolicy</h2><p>点击【集群管理】，选择要操作的集群，点击【网络策略】，点击【查看详情】可以查看 NetworkPolicy 的详细描述，点击【设置】可以对 NetworkPolicy 进行修改，点击【删除】可以删除该资源</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/NetworkPolicy/view-networkpolicy.png alt=view-networkpolicy></p><h2 id=创建-networkpolicy>创建 NetworkPolicy</h2><p>点击【创建网络策略】可以创建新的 NetworkPolicy</p><p><img src=/imgs/user-guide/administration/k8s-cluster/cluster-scoped-res/NetworkPolicy/create-networkpolicy.png alt=create-networkpolicy></p></div><div class=td-content style=page-break-before:always><h1 id=pg-4de4ac3e2c973d54322dc28a04e64999>4.1.6 - 操作审计</h1><p>本文档介绍了如何在 KubeCube 上查询和导出操作审计日志。</p><h2 id=准备工作>准备工作</h2><p>使用平台管理员账号登录 KubeCube。</p><h2 id=开启操作审计>开启操作审计</h2><p>部署好 KubeCube 后，操作审计功能默认开启。如果需要关闭或开启操作审计功能：</p><p>1、使用平台管理员账号登录 KubeCube；</p><p>2、点击页面右上角【切换到控制台】，点击任意空间，进入到控制台页面；</p><p>3、在左侧菜单栏点击【自定义资源CRD】，进入到集群级别 CRD 列表，可以点击右上方输入 &ldquo;hotplug&rdquo; 进行搜索，找到 “hotplugs.hotplug.kubecube.io” CRD，点击【v1】版本进入 CRD 详情页；</p><p>4、选择 common 实例，点击【设置YAML】，找到 spec.component.name=audit，将 “status” 改成 “disabled”，即关闭审计功能；改为 “enabled”，为开启审计功能。详细配置说明见 <a href=https://www.kubecube.io/docs/installation-guide/enable-plugins/>热插拔</a> 。</p><p>5、配置 ElasticSearch：</p><ul><li><p>如果需要安装内置 ElasticSearch，修改上述 common 实例，找到 spec.component.name=elasticsearch，将 “status” 改成 “enabled”，在集群内安装 ElasticSearch。</p></li><li><p>如果需要连接外部 ElasticSearch，需要修改审计服务的deployment的环境变量：</p><ol><li><p><code>kubectl edit deploy audit -n kubecube-system</code></p></li><li><p>添加环境变量：AUDIT_WEBHOOK_HOST、AUDIT_WEBHOOK_INDEX、AUDIT_WEBHOOK_TYPE，如</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_HOST</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>http://elasticsearch-master.elasticsearch:9200</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_INDEX</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>audit</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>AUDIT_WEBHOOK_TYPE</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>logs</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div></li></ol></li><li><p>如果同时配置了内部和外部 ElasticSearch，优先将审计日志发到外部 ElasticSearch。</p></li></ul><h2 id=查询审计日志>查询审计日志</h2><p>使用平台管理员账号登录 KubeCube 后，展开【管控运维】菜单，点击【操作审计】，进入操作审计页面。</p><p><img src=/imgs/user-guide/administration/audit/audit-manage.png alt=audit-manage></p><p>如图所示，在该页面展示出了所有的审计日志，包括审计操作者的账号、操作的时间、IP地址、事件名称、资源、状态。同时平台管理员也可以根据账号、IP地址等进行过滤查询。</p><h2 id=导出审计日志>导出审计日志</h2><p>在操作审计页面，对审计日志查询后，点击【导出】，即可对查询结果进行导出。导出文件格式为csv，导出的日志条数默认不超过10000条。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-4617c6f6a56d7cdbb27b726158991aaa>4.2 - K8s资源管理</h1></div><div class=td-content><h1 id=pg-f92399d03aa0a6430363c202d149c70d>4.2.1 - 工作负载管理</h1></div><div class=td-content><h1 id=pg-7b012c2dd566d2198a61d60244ce1169>4.2.1.1 - Deployment</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 Deployment。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-deployment>创建 Deployment</h2><p>1、选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击 【Deployments】，进入 Deployment 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/Deployment/deploy-apply.png alt=deploy-apply></p><p>2、点击【部署】，进入创建 Deployment 页面，填写信息后，点击【立即创建】，即可创建一个 Deployment。</p><ul><li>基本信息<ul><li>名称：由小写字母、数字或中划线组成，长度1～63位，以字母开头，字母或数字结尾；</li><li>副本数：默认为1个；</li><li>更新策略<ul><li>最短就绪时间：新创建的副本准备就绪后，被视为可用前需要保持正常的时间下限，单位（秒）；</li><li>最大超预期副本数：可创建的最大超过所需副本的副本数量或百分比；</li><li>最大不可用副本数：更新过程中不可使用的副本数上限个数或百分比；</li></ul></li></ul></li><li>容器配置<ul><li>容器名称：副本运行的容器名称；</li><li>镜像：容器运行的<a href=https://www.kubecube.io/docs/user-guide/registry/registry>镜像</a> ；</li><li>配置：配额设置，包括请求配额（基础配置）、最大配额（配置上限），以及 GPU 配置；</li><li>挂载数据卷：选择已创建的数据卷,并设置挂载目录和子路径等；</li><li>环境变量：配置副本的环境变量；</li><li>容器类型：分为业务容器和 init 容器，init 容器不支持就绪探针，必须可以执行结束。一个 pod 可以有多个 init 容器，它们将依次在业务容器运行前执行。</li><li>启动命令：容器启动时即执行该命令；</li><li>启动命令参数：执行启动命令时所需的参数；</li><li>存活探针：可以开启存活探测器，并配置，具体配置方法可参考 <a href=https://v1-19.docs.kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/>https://v1-19.docs.kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/</a>。</li><li>就绪探针：可以开启就绪探测器，并配置，具体配置方法可参考 <a href=https://v1-19.docs.kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/>https://v1-19.docs.kubernetes.io/zh/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/</a>。</li><li>生命周期-停止前：在容器因 API 请求或者管理事件（诸如存活态探针、启动探针失败、资源抢占、资源竞争等） 而被终止之前，此命令会被调用。</li><li>生命周期-启动后：这个回调在容器被创建之后立即被执行。 但是，不能保证回调会在容器入口点（ENTRYPOINT）之前执行。 没有参数传递给处理程序。</li><li>容器端口：需要在副本的 IP 地址上公开的端口；</li><li>镜像拉取策略：可以选择 Always、Never、IfNotPresent；</li></ul></li><li>高级配置<ul><li>仓库密钥：如果配置的镜像需要密钥拉取，选择已创建的 Secret；</li><li>标签：给该 Deployment 添加标签；</li><li>注释：给该 Deployment 添加注释；</li><li>部署策略：给该 Deployment 添加节点亲和性、副本亲和性、副本反亲和性、容忍等部署规则。</li></ul></li></ul><h2 id=管理-deployment>管理 Deployment</h2><p>选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【Deployments】，进入 Deployment 管理页面，可以看到该命名空间下的所有 deployment 名称以及状态。</p><p>这里的状态指的是该 deployment 下所有副本的状态。</p><ul><li>desired：预期的副本数；</li><li>updated：已经是最新版本的副本数；</li><li>available：可用副本数；</li><li>unavailable：不可用副本数；</li><li>total：总副本数。</li></ul><p>同时也可以根据名称对列表进行搜索，或对单个 deployment 进行副本数调整、滚动更新、删除，以及修改 Yaml。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/Deployment/deploy-manage.png alt=deploy-manage></p><h2 id=查看-deployment-详情>查看 Deployment 详情</h2><p>在 Deployment 管理页面，点击任一 deployment 名称，可以进入到该 deployment 详情页。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/Deployment/deploy-detail.png alt=deploy-detail></p><p>在 Deployment 详情页，可以查看到 deployment 的具体信息，以及该 deployment 所关联的所有副本的详情、副本的监控数据以及该 deployment 和副本的事件信息和 condition 信息。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-500ff95d0a9229063602362156100f9c>4.2.1.2 - StatefulSet</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 StatefulSet。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-statefulset>创建 StatefulSet</h2><p>1、选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【Statefulsets】，进入StatefulSet 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/StatefulSet/statefulset-apply.png alt=statefulset-apply></p><p>2、点击【部署】，编写 statefulset 的 yaml 文件。点击【确定】，即可部署该 statefulset。</p><p>statefulset 的规范可参考：https://v1-20.docs.kubernetes.io/docs/concepts/workloads/controllers/statefulset/。</p><h2 id=管理-statefulset>管理 StatefulSet</h2><p>选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【Statefulset】，进入 StatefulSet 管理页面。在管理页面，可以看到该命名空间下的所有 statefulSet。</p><p>同时也可以根据名称对列表进行搜索，或对单个 statefulset 进行副本数调整、删除，以及修改 Yaml。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/StatefulSet/statefulset-manage.png alt=statefulset-manage></p><h2 id=查看-statefulset-详情>查看 StatefulSet 详情</h2><p>在 StatefulSet 管理页面，点击任一 statefulSet 名称，即可进入到该 statefulSet 详情页。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/StatefulSet/statefulset-detail.png alt=statefulset-detail></p><p>StatefulSet 详情页除了可以管理 StatefulSet，还可以查看 StatefulSet 的详细信息，关联的副本信息和副本的监控数据，以及 StatefulSet 和关联副本的事件和 condition 信息。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1c1715029a9653f311b6e7f2eae48dd4>4.2.1.3 - Job</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 Job。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-job>创建 Job</h2><p>1、选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【Job】，进入 Job 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/Job/job-apply.png alt=job-apply></p><p>2、点击【部署】，编写 job 的 yaml 文件。点击【确定】，即可部署该 job。</p><p>job 的 规范可参考：https://v1-20.docs.kubernetes.io/docs/concepts/workloads/controllers/job/。</p><h2 id=管理-job>管理 Job</h2><p>选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【Job】，进入 Job 管理页面。在管理页面，可以看到该命名空间下的所有 job 名称以及对应的状态、执行情况、运行时长，并可以在该界面对 job 进行删除操作。同时也可以根据名称对 job 进行搜索。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/Job/job-manage.png alt=job-manage></p><h2 id=查看-job-详情>查看 Job 详情</h2><p>在 Job 管理页面，点击任一 job 名称，即可进入到该 job 详情页。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/Job/job-detail.png alt=job-detail></p><p>Job 详情页除了可以管理 Job，还可以查看 Job 的详细信息，关联的副本信息和副本的监控数据，以及 Job 和关联副本的事件和 condition 信息。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-359ccce9eb5b678be164211be1ac6674>4.2.1.4 - CronJob</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 CronJob。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-cronjob>创建 CronJob</h2><p>1、选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【CronJob】，进入 CronJob 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/CronJob/cronjob-apply.png alt=cronjob-apply></p><p>2、点击【部署】，编写 CronJob 的 yaml 文件。点击【确定】，即可部署该 CronJob。</p><p>CronJob 的 规范可参考：https://v1-20.docs.kubernetes.io/docs/concepts/workloads/controllers/cron-jobs/。</p><h2 id=管理-cronjob>管理 CronJob</h2><p>选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【CronJob】，进入 CronJob 管理页面。在管理页面，可以看到该命名空间下的所有 CronJob ，包括对应的名称、空间、状态、定时调度设置、正在运行的任务数以及创建时间。并可以在该界面对 CronJob 进行删除和修改操作。同时也可以根据名称对 CronJob 进行搜索。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/CronJob/cronjob-manage.png alt=cronjob-manage></p><h2 id=查看-cronjob-详情>查看 CronJob 详情</h2><p>在 CronJob 管理页面，点击任一 CronJob 名称，即可进入到该 CronJob 详情页。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/CronJob/cronjob-detail.png alt=cronjob-detail></p><p>CronJob 详情页除了可以管理 CronJob，还可以查看 CronJob 的详细信息，根据状态过滤该 CronJob 关联的任务列表，以及查看该 CronJob 和该 CronJob 所关联的副本的事件。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d4b33d551e5eb6dd7a8d90fbeeaa23ae>4.2.1.5 - Pod</h1><p>本文档介绍了如何在 KubeCube 上管理 Pods。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=管理-pod>管理 Pod</h2><p>选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【Pod】，进入 Pod 管理页面。在管理页面，可以看到该命名空间下的所有 pod，包括每个 pod 的名称、IP、状态、重启次数、CPU 使用量、内存使用量以及创建时间。</p><p>同时也可以根据名称对列表进行搜索，或对单个 pod 进行查看和删除。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/Pod/pod-manage.png alt=pod-manage></p></div><div class=td-content style=page-break-before:always><h1 id=pg-567f7238e4941a79e1ce1cf4cac8a2d5>4.2.1.6 - CRD</h1><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-crd>创建 CRD</h2><p>选择租户和项目，选择集群和空间，点击左侧【自定义资源 CRD】，进入自定义资源列表页面。点击【创建自定义资源】可以以 YAML 的模式创建自定义资源 CRD。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/CRD/manage.png alt=manage></p><h2 id=创建-cr>创建 CR</h2><p>在 CRD 列表页面，点击具体一条记录的版本，进入 CRD 关联的实例页面，可以管理和创建相应的 CR。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/CRD/createcr.png alt=creatercr></p></div><div class=td-content style=page-break-before:always><h1 id=pg-b0384913470a4be6d30a31aa6569ba7b>4.2.1.7 - DaemonSet</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 DaemonSet。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-daemonset>创建 DaemonSet</h2><p>1、选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击 【DaemonSets】，进入 DaemonSet 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/DaemonSet/daemonset-apply.png alt=daemonset-apply></p><p>2、点击【部署】，编写 daemonSet 的 yaml 文件。点击【确定】，即开始部署该 daemonSet。</p><p>daemonSet 的 规范可参考：https://v1-20.docs.kubernetes.io/zh/docs/concepts/workloads/controllers/daemonset/。</p><p>注意，daemonSet 的 namespace 应与当前所在 namespace 一致。</p><h2 id=管理-daemonset>管理 DaemonSet</h2><p>选择租户和项目，选择集群和空间，展开【工作负载】菜单，点击【DaemonSets】，进入 DaemonSet 管理页面，可以看到该命名空间下的所有 daemonSet，包括名称、级别以及创建时间。</p><p>同时也可以根据名称对列表进行搜索，或对单个 daemonSet 进行删除或修改。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/DaemonSet/daemonset-manage.png alt=daemonset-manage></p><h2 id=查看-daemonset-详情>查看 DaemonSet 详情</h2><p>在 DaemonSet 管理页面，点击任一 daemonSet 名称，可进入到该 daemonSet 详情页。</p><p><img src=/imgs/user-guide/ns-scoped-res/workload/DaemonSet/daemonset-detail.png alt=daemonset-detail></p><p>在 DaemonSet 详情页，可以查看到 daemonSet 的具体信息，以及该 daemonSet 所关联的所有副本的详情、副本的监控数据以及该 daemonSet 和副本的事件信息和 condition 信息。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ee61de2534aadcceda73d6d0ab9b344e>4.2.2 - 服务与发现</h1></div><div class=td-content><h1 id=pg-22aff6c7da936928435b042b223fe5c1>4.2.2.1 - Service</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 Service。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，在命名空间下创建一个 Deployment，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-service>创建 Service</h2><p>1、选择租户和项目，选择集群和空间，展开【服务与发现】菜单，点击【Services】菜单按钮，进入 Service 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/service-discovery/service/manage.png alt=manage.png></p><p>2、点击【创建服务】按钮，进入创建服务页面，填写信息后，点击【立即创建】按钮，即可创建一个 Service。</p><p><img src=/imgs/user-guide/ns-scoped-res/service-discovery/service/create.png alt=create.png></p><ul><li><p>名称：输入服务名称</p></li><li><p>类型：选择服务类型为 ClusterIP 或者 NodePort</p></li><li><p>使用方式：对于 ClusterIP 类型，需要选择使用方式为常规服务、Headless 服务或外部服务</p></li><li><p>Selector：选择关联的工作负载，支持高级自定义</p></li><li><p>标签：定义标签</p></li><li><p>Ports：添加应用端口与服务端口的映射关系</p></li><li><p>会话保持：开通/关闭会话保持</p></li></ul><h2 id=管理-service>管理 Service</h2><p>选择租户和项目，选择集群和空间，展开【服务与发现】菜单，点击【Services】菜单按钮，进入 Service 管理页面，可以对 Service 列表进行设置重编辑，删除和 Yaml 设置。</p><p><img src=/imgs/user-guide/ns-scoped-res/service-discovery/service/manage.png alt=manage.png></p><h2 id=查看-service-详情>查看 Service 详情</h2><p>在 Service 管理页面，点击具体一条服务名称，进入 Service 详情页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/service-discovery/service/servicedetail.png alt=servicedetail.png></p><p>Service 详情页面除了可以管理 Service，还可以查看 Service 的详细信息、关联的副本信息和事件信息，支持设置 Nginx Ingress 类型的对外服务端口供外部访问。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-866cdaed77cae1df8312e1634fe342d5>4.2.2.2 - Ingress</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 Ingress。KubeCube 默认使用 Nginx Ingress。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，命名空间下创建一个 Service，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-ingress>创建 Ingress</h2><p>1、选择租户和项目，选择集群和空间，展开【服务与发现】菜单，点击【Ingresses】菜单按钮，进入 Ingress 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/service-discovery/ingress/manage.png alt=manage.png></p><p>2、点击【创建负载均衡】按钮，进入创建负载均衡页面，填写信息后，点击【立即创建】按钮，即可创建一个 Ingress。</p><p><img src=/imgs/user-guide/ns-scoped-res/service-discovery/ingress/create.png alt=create.png></p><ul><li><p>名称：输入 Ingress 名称</p></li><li><p>端口：选择对外暴露访问的端口</p></li><li><p>调度算法：选择负载均衡轮询策略</p></li><li><p>转发规则：设置 Host，设置 Path 与 Service 端口的映射关系，可以添加多条转发规则</p></li><li><p>会话保持：开通/关闭会话保持</p></li></ul><h2 id=管理-ingress>管理 Ingress</h2><p>选择租户和项目，选择集群和空间，展开【服务与发现】菜单，点击【Ingresses】菜单按钮，进入 Ingress 管理页面，可以对 Ingress 列表进行设置重编辑，删除和 Yaml 设置。</p><p><img src=/imgs/user-guide/ns-scoped-res/service-discovery/ingress/manage.png alt=manage.png></p><h2 id=查看-ingress-详情>查看 Ingress 详情</h2><p>在 Ingress 管理页面，点击具体一条 Ingress 记录的名称，进入详情页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/service-discovery/ingress/ingressdetail.png alt=ingressdetail.png></p><p>Ingress 详情页面除了可以管理 Ingress，还可以查看 Ingress 的详细信息、关联的 Service 信息和事件信息。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-dfe90e26dd8c5f2bbd351b3c8a3f04f1>4.2.3 - 配置管理</h1></div><div class=td-content><h1 id=pg-498270f9948d4c7c2fbbc06e6f83f203>4.2.3.1 - Secret</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 Secret。</p><p>Kubernetes Secret 用于存储和管理一些敏感数据，比如密码密钥等敏感信息。它把 Pod 想要访问的加密数据存放到 Etcd 中。然后用户就可以通过在 Pod 的容器里挂载 Volume 的方式或者环境变量的方式访问 Secret 里保存的信息。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-secret>创建 Secret</h2><p>1、选择租户和项目，选择集群和空间，展开【配置】菜单，点击【Secret】菜单按钮，进入 Secret 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/config/secret/manage.png alt=manage.png></p><p>2、点击【创建 Secret】按钮，进入创建 Secret 页面，填写信息后，点击【立即创建】按钮，即可创建一个 Secret。</p><p><img src=/imgs/user-guide/ns-scoped-res/config/secret/create.png alt=create.png></p><ul><li>名称：输入 Secret 名称。</li><li>类型：<ul><li>Opaque：base64 编码格式的 Secret，用来存储密码、密钥等。</li><li>DockerConfigJson ： 用来存储私有 docker registry 的认证信息。</li><li>IngressTLS：配置 Ingress TLS 密钥。</li></ul></li><li>根据选择的类型，输入相应的信息。</li></ul><h2 id=查看-secret-详情>查看 Secret 详情</h2><p>在 Secret 管理页面，点击具体一条 Secret 记录的名称，进入详情页面查看 Secret 的详细信息。</p><p><img src=/imgs/user-guide/ns-scoped-res/config/secret/detail.png alt=detail.png></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c0919adee8d182e2019d6d5ebbb44d54>4.2.3.2 - ConfigMap</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 ConfigMap。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-configmap>创建 ConfigMap</h2><p>1、选择租户和项目，选择集群和空间，展开【配置】菜单，点击【ConfigMap】菜单按钮，进入 ConfigMap 管理页面。</p><p><img src=/imgs/user-guide/ns-scoped-res/config/configmap/manage.png alt=manage.png></p><p>2、点击【创建 ConfigMap】按钮，进入创建 ConfigMap 页面，填写信息后，点击【立即创建】按钮，即可创建一个 ConfigMap。</p><p><img src=/imgs/user-guide/ns-scoped-res/config/configmap/create.png alt=create.png></p><ul><li>名称：输入 ConfigMap 名称。</li><li>数据：输入键值对形式的数据信息。</li></ul><h2 id=管理-configmap>管理 ConfigMap</h2><p>选择租户和项目，选择集群和空间，展开配置菜单，点击 ConfigMap 菜单按钮，进入 ConfigMap 管理页面。在 ConfigMap 管理页面可以对 ConfigMap 进行设置、删除和 Yaml 设置。</p><p><img src=/imgs/user-guide/ns-scoped-res/config/configmap/manage2.png alt=manage2.png></p><h2 id=查看-configmap-详情>查看 ConfigMap 详情</h2><p>在 ConfigMap 管理页面，点击具体一条 ConfigMap 记录的名称，进入详情页面查看 ConfigMap 的详细信息。</p><p><img src=/imgs/user-guide/ns-scoped-res/config/configmap/detail.png alt=detail.png></p></div><div class=td-content style=page-break-before:always><h1 id=pg-79b55e097198558e403125cdfbc32689>4.2.4 - 存储管理</h1></div><div class=td-content><h1 id=pg-dc0724a49c70a4409332e139d6e548cc>4.2.4.1 - PVC</h1><p>本文档介绍了如何在 KubeCube 上创建、使用和编辑 PVC（Persistent Volume Claim）。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=创建-pvc>创建 PVC</h2><p>1、选择租户和项目，选择集群和空间，点击【存储】菜单，进入 PVC 管理页面。在管理页面可以进行 PVC 记录的添加、设置、删除和 Yaml 设置。</p><p><img src=/imgs/user-guide/ns-scoped-res/storage/pvc/manage1.png alt=manage1.png></p><p>2、点击【创建存储声明】，弹出创建存储声明的窗口。</p><p><img src=/imgs/user-guide/ns-scoped-res/storage/pvc/create.png alt=create.png></p><ul><li>存储类别：选择存储类别，存储类别可以在集群管理页面添加</li><li>名称：存储声明名称</li><li>容量：填写所需存储容量</li><li>模式：独占读写（ ReadWriteOnce：读写权限，并且只能被单个节点挂载 ）、只读共享（ ReadOnlyMany：只读权限，允许被多个节点挂载 ）、共享读写（ ReadWriteMany：读写权限，允许被多个节点挂载 ）</li></ul><h2 id=查看-pvc-详情>查看 PVC 详情</h2><p>在 PVC 管理页面选择一条 PVC 记录，可以查看该 PVC 记录的详细信息，可以查看绑定的副本信息和监控信息。并且可以管理操作，包括删除、设置和 Yaml 设置。</p><p><img src=/imgs/user-guide/ns-scoped-res/storage/pvc/detail.png alt=detail.png></p></div><div class=td-content style=page-break-before:always><h1 id=pg-82e8b1c2057cbb52f8b8bf3f153fab19>4.2.5 - 其他</h1></div><div class=td-content><h1 id=pg-cf4b1f8c4b2aa8cb554e7e20df5d61ff>4.2.5.1 - 密钥管理</h1><p>本文档介绍了如何在 KubeCube 上进行密钥管理。</p><p>密钥管理提供 AccessKey 和 SecretKey 供用户系统调用 OpenAPI 接口时进行认证。</p><h2 id=管理密钥>管理密钥</h2><p>用户登录后，鼠标移动到右上角用户名称，在下拉菜单中点击【密钥管理】，进入密钥管理页面。在密钥管理页面可以添加密钥、删除密钥和查看密钥信息。</p><p><img src=/imgs/user-guide/ns-scoped-res/others/key-manage/keymanage.png alt=keymanage.png></p><h2 id=使用密钥>使用密钥</h2><p>使用 AccessKey 和 SecretKey 可以获取用户 token，将token放到请求头可以请求 KubeCube 的 OpenAPI 接口。</p><p>HTTP Request：</p><pre><code>GET /api/v1/cube/key/token
</code></pre><p>Query Parameters：</p><table><thead><tr><th style=text-align:left>Parameter</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left><code>accessKey</code></td><td style=text-align:left>AccessKey</td></tr><tr><td style=text-align:left><code>secretKey</code></td><td style=text-align:left>SecretKey</td></tr></tbody></table><p>Response：</p><table><thead><tr><th style=text-align:left>Code</th><th style=text-align:left>Info</th></tr></thead><tbody><tr><td style=text-align:left><code>200</code></td><td style=text-align:left>{&ldquo;token&rdquo;: &ldquo;token info&rdquo;}</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-ce8d51f35837b81d146741b8306c0c6f>4.2.5.2 - Yaml 编排</h1><p>本文档介绍了如何在 KubeCube 上使用 YAML 编排。</p><h2 id=准备工作>准备工作</h2><p>创建一个租户，在租户下创建一个项目，在项目下一个创建一个命名空间，创建一个账号并赋予该命名空间操作权限。</p><h2 id=yaml-编排>YAML 编排</h2><p>选择租户和项目，选择集群和空间，点击【 YAML 编排】 菜单，弹出 YAML 编排界面。</p><p><img src=/imgs/user-guide/ns-scoped-res/others/yaml-deploy/yamlcreate.png alt=yamlcreate.png></p><p>填写要创建的资源的 YAML 格式定义，或者从文件导入，或者从已有资源导入，编辑完成后点击【确定】完成 YAML 编排。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8ae19508dbb7625349737720db3348ba>4.3 - 日志</h1></div><div class=td-content><h1 id=pg-277d44191dc43d26b54c20111a0ca942>4.3.1 - 采集任务管理</h1><blockquote><p>采集任务管理，用于采集Kubernetes集群中容器的日志，包括容器的标准输出和容器中的日志文件。</p></blockquote><h2 id=创建日志采集任务>创建日志采集任务</h2><p><img src=/imgs/user-guide/logs/logconfig-list.png alt=日志采集任务列表>
如图所示，点击【创建日志任务】，创建指定服务的日志采集任务。</p><p><strong>基础配置：</strong></p><p>基础配置部分如图所示：<br><img src=/imgs/user-guide/logs/logconfig-create-stdout-base.png alt=日志采集任务基础配置></p><ul><li><p>日志任务名称：可任意填写服务的日志采集任务名，比如nginx等；</p></li><li><p>日志源类型：</p><ul><li>容器标准输出：容器中的标准输出流；</li><li>容器日志：容器内产生的日志文件；</li></ul></li><li><p>标签选择器：标签选择器类似Kubernetes中的LabelSelector，用于指定日志采集任务匹配的Pods，需要和需要被采集日志的Pods中Label保持一致；</p></li><li><p>日志采集路径：如果选择采集容器日志文件，需要输入日志路径，路径为glob表达式的形式，例如：<code>/var/log/*.log</code>。另外需注意的是，如果填写<code>/var/log</code>，不会采集目录下的所有文件，会被认为是采集<code>/var</code>目录下的<code>log</code>文件。如果填写<code>/var/log/*</code>，则会采集<code>/var/log</code>下本级的目录，如果需要遍历，可以填写<code>/var/log/**</code>；</p></li></ul><p><strong>高级配置：</strong></p><p><img src=/imgs/user-guide/logs/logconfig-create-advance-1.png alt=日志采集任务高级配置1></p><ul><li><p>容器：如果Pod中有多个容器，则建议指定具体的容器名称，否则会给采集所有容器下的日志；</p></li><li><p>元信息/注入Pod标记：在日志配置中注入Pod的label(标签)、env(环境变量)、annotation(注解)，可用作日志查询页面的筛选条件；</p></li><li><p>元信息/自定义标记：自定义Key-Value值，可用作日志查询页面的筛选条件；</p></li></ul><p><img src=/imgs/user-guide/logs/logconfig-create-advance-2.png alt=日志采集任务高级配置1></p><ul><li><p>日志多行配置：日志多行配置用于指定处理跨多行消息的处理方式</p><ul><li>pattern：指定用于匹配多行的正则表达式；</li><li>negate：定义模式是否被否定；</li><li>match：指定如何把多行合并成一条；</li></ul></li><li><p>单条日志大小上限：避免单行日志太大会导致日志采集Agent OOM异常等；</p></li><li><p>排除日志：该路径下的文件将被忽略，日志内容不被收集；支持正则匹配，建议排除压缩文件，例如：.gz$；</p></li><li><p>忽略日志文件：将忽略日志任务创建时间起对应时间段内的日志文件；</p></li><li><p>日志保留：可指定日志保留文件数或日志保留天数，日志Agent会帮助定时清理；</p></li></ul><h2 id=更新日志采集任务>更新日志采集任务</h2><p>在日志任务管理的列表中，点击<code>操作</code>列的<code>设置</code>即可，更新字段可参考上面创建部分。</p><h2 id=删除日志采集任务>删除日志采集任务</h2><p>在日志任务管理的列表中，点击<code>操作</code>列的<code>删除</code>即可，删除后不再采集匹配的Pod的日志。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-13fcf9333e1399705c794b276af9548e>4.3.2 - 日志查询</h1><h2 id=搜索模式>搜索模式</h2><h4 id=查询条件>查询条件</h4><p>如下图所示，支持按以下条件筛选日志任务，查询日志数据：</p><p><img src=/imgs/user-guide/logs/logsearch.png alt=日志查询></p><ul><li>日志任务：选择在日志任务管理中创建的日志采集任务；</li><li>查询语句：输入查询语句，示例：status:200 AND extension:PHP；</li><li>筛选条件：选择Key-Value值，可组合条件，快速筛选所需日志数据；</li><li>时间范围：<ul><li>默认查询时间范围为近1小时；</li><li>提供快捷选项，可快速选择日志查询时间范围；</li><li>自定义时间：自定义选择开始日期和结束日期；点击【切换】，可自定义填写具体的开始时间和结束时间，时间粒度最小为秒级。</li></ul></li></ul><h4 id=日志柱形图>日志柱形图</h4><p>返回日志数据结果后，日志查询页面将展示日志柱形图。日志柱形图是时间横轴、日志采集数纵轴组成的蓝色柱形图表。根据蓝色柱形的波动可以直观看出该时间段内日志产生数量的变化趋势。如果当前日志为服务器的访问日志，就可以快速地发现这段时间内整个服务的负载情况以及用户访问情况。<br>日志柱状图还提供了丰富的交互，用户可快速定位日志。点击柱形即可定位到更细粒度的时间区间；或者拖动选择所需查找的时间区间，前端立即返回该时间段内的日志数据。<br>鼠标移动至柱形，即可展示该柱形对应日志的入库时间以及日志数目。<br>日志柱形图上方展示完整时间区间内的日志采集条数，并支持自定义柱形图展示粒度，最小粒度为秒级。</p><h4 id=日志内容展示>日志内容展示</h4><p>设置完成日志查询条件后，前端界面即可展示日志内容。左侧为日志采集时间，可正逆序排列。右侧为日志内容，点击左上方组件，可切换日志内容展示形式，提供的形式有原始日志以及Json形式。</p><p><strong>自定义日志内容展示列</strong><br><img src=/imgs/user-guide/logs/logsearch-fields.png alt=日志查询感兴趣字段><br>用户可自定义感兴趣字段，展示或者隐藏不必要的列信息。<br>如图所示，用户可按需选择字段，或输入字段名称进行模糊搜索，选择完成后，前端界面将展示用户所选字段的内容列。比如，选择<code>namespace</code>和<code>pod_name</code>这个两个字段后，可在日志查询页面看到日志的<code>namespace</code>和产生的<code>pod_name</code>信息，便于排查问题。</p><h2 id=实时流模式>实时流模式</h2><p>实时流模式可用于上线场景，用户可实时关注与跟踪日志数据。通过设置刷新频率，前端界面实时滚动输出日志数据。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0ec2263ff6b9810ff122b6aed8649ca7>4.4 - 告警管理</h1></div><div class=td-content><h1 id=pg-212812563f497c38bead288d83423588>4.4.1 - 平台组件告警</h1><p>本文档介绍了如何在 KubeCube 中配置<strong>平台级</strong>告警，包括配置集群内的 Alertmanager 、告警通知联系人、通知路由规则、告警规则。</p><h2 id=简介>简介</h2><p>默认情况下，KubeCube 会在平台部署<code>kubecube-monitoring</code> Chart，该 Chart 包含 <code>Alertmanager</code> 组件和默认的 <code>Alertmanager Config Secret</code>配置以及平台基础组件的告警规则。默认情况下，KubeCube 创建的 <code>Alertmanager Config Secret</code> 不会因为 Chart 的升级或删除操作而被修改，以防用户的配置丢失。</p><h2 id=准备工作>准备工作</h2><p>以平台管理员角色登录 KubeCube 平台。</p><h2 id=配置-alertmanager>配置 AlertManager</h2><p>登录到 KubeCube 平台，点击【运维管理】，侧边栏选择【告警&ndash;全局告警配置】，列表页可以看到各个集群的<code>AlertManager</code> 的配置信息，点击【设置】按钮进行配置，</p><h3 id=全局配置>全局配置</h3><p><img src=/imgs/user-guide/alerting/am-global.png alt=am-global></p><p>若使用企业邮箱作为告警通知方式，需要在全局配置中配置以下字段：</p><ul><li><code>smtp_smarthost</code> : 邮箱服务器域名和端口信息，e.g. imap.163.com:465</li><li><code>smtp_from</code> : 发件人邮箱</li><li><code>smtp_auth_username</code> : 邮件服务器认证用户名</li><li><code>smtp_auth_password</code> : 邮件服务器认证密码或授权码</li></ul><p>若使用企业微信作为告警通知方式，需要在全局配置中配置以下字段：</p><ul><li><code>wechat_api_url</code> : 默认使用<code>https://qyapi.weixin.qq.com/cgi-bin/</code></li><li><code>wechat_api_secret</code> : 第三方企业应用的密钥</li><li><code>wechat_api_corp_id</code> : 企业微信账号唯一 ID</li></ul><h3 id=通知方式>通知方式</h3><p>目前页面支持配置Email、WeChat、Webhook三种联系方式，其他联系方式如Slack、OpsEngine等会在后续版本支持
<img src=/imgs/user-guide/alerting/am-receivers.png alt=am-receivers></p><p>更多字段含义请参考<a href=https://www.prometheus.io/docs/alerting/latest/configuration/#receiver>Alertmanager官方文档中关于receivers的定义</a></p><h3 id=通知路由规则>通知路由规则</h3><p>相关配置如下：</p><ul><li><code>receiver</code> : 选择上一步骤中定义的联系人</li><li><code>group_by</code> : 当前 route 节点的分组规则</li><li><code>matchers</code> : 当前 route 节点的匹配规则</li><li><code>group_wait</code> : 告警组内的发送一条告警通知的等待时间</li><li><code>group_interval</code> : 告警组内发送两条告警通知的间隔时间</li><li><code>repeat_interval</code> : 相同告警发送的间隔时间</li></ul><p><img src=/imgs/user-guide/alerting/am-route.png alt=am-route></p><p>更多字段含义请参考<a href=https://www.prometheus.io/docs/alerting/latest/configuration/#route>Alertmanager官方文档中关于route的定义</a>，当前页面暂不支持子路由的配置，会在后续版本提供支持。</p><h2 id=管理告警规则>管理告警规则</h2><h3 id=查看告警规则组>查看告警规则组</h3><p>登录到 KubeCube 平台，点击【运维管理】，侧边栏选择【告警&ndash;告警规则】，列表页可以看到各个集群的<code>PrometheusRule</code> 的配置信息，默认情况下， KubeCube 为每个集群内置了基础资源以及平台组件的 <code>PrometheusRule</code>,</p><p><img src=/imgs/user-guide/alerting/component-alerting.png alt=component-alerting></p><h3 id=配置告警规则内容>配置告警规则内容</h3><p>可以点击【设置】按钮查看并配置每条告警规则的具体内容，包括</p><ul><li>表达式 : <code>Promql</code>表达式</li><li><code>for</code> : 告警持续时长</li><li>告警程度 : 可以在上述 <a href=#%E9%80%9A%E7%9F%A5%E6%96%B9%E5%BC%8F>通知方式</a>中配置不同告警程度对应的 Receiver 来接收告警通知</li><li>Annotations<ul><li>摘要: 接收告警通知的摘要信息</li><li>描述信息: 接收告警通知的具体描述信息，如发生故障的 Pod 所在的集群，空间等</li><li><code>Runbook Url</code>: 针对该告警规则的运维排障文档，应作为最佳实践在企业内部进行维护</li><li>也可以【展开更多配置】，添加更多自定义的Annotations(键-值对)</li></ul></li><li>Labels: 为告警规则附带的标签信息(键-值对)，可以配合<a href=#%E9%80%9A%E7%9F%A5%E8%B7%AF%E7%94%B1%E8%A7%84%E5%88%99>通知路由规则</a> 实现告警通知的高级配置</li></ul><p><img src=/imgs/user-guide/alerting/component-prometheusRule.png alt=component-PrometheusRule></p><p>更多字段含义请参考<a href=https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#rule>Prometheus-Operator的API文档</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-e9c3176c4ab8c82368326836dfd4fb38>4.4.2 - 通知策略管理</h1><p>本文档介绍了如何在 KubeCube 中管理<strong>项目级别</strong>的告警联系人与通知策略。</p><h2 id=准备工作>准备工作</h2><p>登录 KubeCube 平台并创建租户、项目、空间</p><h2 id=联系人管理>联系人管理</h2><blockquote><p>推荐在一个告警通知策略内配置多个联系人，代表联系人组信息，而不是为每个联系人都创建一个通知策略。</p></blockquote><ol><li><p>登录到 KubeCube 控制台，选择租户项目后，侧边栏展开【告警】菜单，选择【告警策略组】，并点击创建.</p></li><li><p>弹出对话框后，填写告警联系人基本信息，目前页面支持配置Email、WeChat、Webhook三种联系方式，其他联系方式如Slack、OpsEngine等会在后续版本支持，如有需求可以通过列表页的【yaml配置】进行设置。</p></li></ol><ul><li>名称: 标识联系人组的名称，如"frontend"，在后续创建告警规则时作为关联。</li></ul><h4 id=email配置>Email配置</h4><p><img src=/imgs/user-guide/alerting/create-amc-email.png alt=create-amc-email></p><ul><li>是否接收告警恢复通知</li><li>收件人: 收件人的邮箱地址</li><li>更多配置：
注意：以下配置默认使用集群全局配置，可以询问集群管理员获知。<ul><li>smarthost: 邮箱服务器域名和端口信息，e.g. imap.163.com:465</li><li>from: 发件人邮箱</li><li>authUsername: 邮件服务器认证用户名</li><li>authPassword: 邮件服务器认证密码，需要提前在项目空间(kubecube-project-<project-name>)创建一个Secret，再指定Secret和key<ul><li>Secret: 选择已创建的Secret的名称</li><li>key: 选择指定Secret的key</li></ul></li></ul></li></ul><p>更多配置请参考<a href=https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#emailconfig>EmailConfig</a></p><h4 id=wechat配置>WeChat配置</h4><p><img src=/imgs/user-guide/alerting/create-amc-wechat.png alt=create-amc-wechat></p><ul><li>是否接收告警恢复通知</li><li>toUser: 接收告警通知的企业微信用户名</li><li>toParty: 接收告警通知的企业微信用户组</li><li>toTag: 接收告警通知的企业微信用户标签</li><li>更多配置：
注意：以下配置默认使用集群全局配置，可以询问集群管理员获知。<ul><li>apiURL: 微信第三方通知的apiURL</li><li>corpID: 企业微信账号唯一 ID，可以在我的企业中查看。</li><li>agentID: 第三方企业应用的 ID，可以在已创建的第三方企业应用详情页面查看。</li><li>apiSecret: 需要根据第三方企业应用的密钥，提前在项目空间(kubecube-project-<project-name>)创建一个Secret，再指定Secret和key<ul><li>Secret: 选择已创建的Secret的名称</li><li>key: 选择指定Secret的key</li></ul></li></ul></li></ul><p>更多配置请参考<a href=https://work.weixin.qq.com/api/doc/#10167/%E6%96%87%E6%9C%AC%E6%B6%88%E6%81%AF>企业微信文档</a>以及<a href=https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#wechatconfig>WeChatConfig</a>。</p><h4 id=webhook配置>Webhook配置</h4><p><img src=/imgs/user-guide/alerting/create-amc-webhook.png alt=create-amc-webhook></p><ul><li>是否接收告警恢复通知</li><li>url: Webhook的url，用来接受HTTP POST请求</li><li>max_alerts: Alertmanager一次发往webhook通知中，包含告警的最大数量，当超过该值，告警会被截断，默认为全部发送。</li></ul><p>更多配置参考<a href=https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#webhookconfig>WebhookConfig</a></p><h2 id=高级功能>高级功能</h2><p>KubeCube 告警通知策略组支持高级策略配置，如</p><ul><li>配置告警组内的发送一条告警通知的等待时间(group_wait)</li><li>配置告警组内发送两条告警通知的间隔时间(group_interval)</li><li>配置相同告警发送的间隔时间(repeat_interval)</li><li>配置嵌套的告警路由策略</li><li>配置告警抑制规则</li><li>&mldr;</li></ul><p>如果需要实现更灵活的自定义通知策略，可以通过点击【列表】页面的【yaml设置】进行设置与修改，相关字段请参考<a href=https://github.com/prometheus-operator/prometheus-operator/blob/master/Documentation/api.md#alertmanagerconfig>AlertmanagerConfig-CRD文档</a>, 具体字段含义请参考<a href=https://prometheus.io/docs/alerting/latest/configuration/>Alertmanager配置</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-6e552205cbb956779382205554fca35d>4.4.3 - 告警规则管理</h1><p>本文档介绍了如何在 KubeCube 中管理<strong>项目级</strong>告警规则。</p><h2 id=准备工作>准备工作</h2><ol><li>登录 KubeCube 平台并创建租户、项目、空间</li><li>创建告警通知策略</li></ol><h2 id=告警规则管理>告警规则管理</h2><h4 id=创建告警规则>创建告警规则</h4><ol><li>登录到 KubeCube 控制台，选择租户项目后，侧边栏展开【告警】菜单，选择【告警规则】，并点击创建.</li><li>填写告警规则基本信息：</li></ol><p><img src=/imgs/user-guide/alerting/create-alertrule.png alt=create-alertrule></p><ul><li>告警名称: 告警规则名称</li><li>表达式：promql表达式，具体配置方式请参考<a href=https://prometheus.io/docs/prometheus/latest/querying/basics/>prometheus文档</a></li><li>持续时间：代表告警规则表达式持续被触发的时长，如果达到该期望时间，就触发一条告警。</li><li>告警程度：告警程度信息</li><li>通知策略组：选择告警触发后需要通知的联系人与相应的通知策略。</li><li>告警描述信息: 告警触发后发送的告警描述信息，具体配置方式请参考<a href=https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/#templating>Prometheus告警规则模版配置</a></li></ul><h4 id=告警状态查询>告警状态查询</h4><p><img src=/imgs/user-guide/alerting/list-alertrule.png alt=list-alertrule></p><p>在告警规则列表页面，可以查看项目下所有告警规则的状态，状态包含以下三种：</p><ul><li>normal: 代表该告警规则未触发告警</li><li>pending: 代表告警规则被触发，但未达到期望持续时间。</li><li>firing：代表告警规则被触发，并达到期望持续时间。</li></ul><p>点击【告警名称】的状态，可以查看触发该告警规则的具体对象信息，如空间信息，Pod信息等，静默功能将在后续版本中支持。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3fea0b4ff85acbc015b806853de5f518>4.5 - 集群监控</h1></div><div class=td-content><h1 id=pg-fa70bbc673b86ac69f0aeb6ebe99189b>4.5.1 - 平台组件监控</h1><p>本文档介绍了如何在 KubeCube 中查看平台核心组件监控。</p><h2 id=准备工作>准备工作</h2><p>以平台管理员角色登录 KubeCube 平台。</p><h2 id=查看组件监控视图>查看组件监控视图</h2><p>当前 KubeCube 平台支持对以下组件的监控视图可视化查询:</p><ul><li>管控面 Pod 监控</li><li>CoreDNS 监控</li><li>Etcd 监控</li><li>Kube ApiServer 监控</li><li>Kube Controller Manager 监控</li><li>Kube Proxy 监控</li><li>Kube Scheduler 监控</li><li>Kubelet 监控</li><li>Prometheus 监控</li><li>Thanos Query 监控</li></ul><p>可以登录到 KubeCube 平台，点击【运维管理】，侧边栏选择【组件监控】，进行查看</p><p><img src=/imgs/user-guide/monitoring/component-monitoring.png alt=component-monitoring></p><p>点击需要查看的组件，即可查看对应的监控视图，以平台组件 pod 监控为例，点击【control-plane-pods】后，可以查看不同集群中，管控组件 Pod 的资源使用情况；对于其他组件，可以查看相应的核心指标监控。</p><p><img src=/imgs/user-guide/monitoring/control-plane-pods.png alt=control-plane-pods></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5c5a86a8b94a28ac0698c10b6cb35bd5>4.6 - 镜像仓库</h1><p>KubeCube 支持主流的镜像仓库，如 registry.cn-hangzhou.aliyuncs.com，docker.io，hub.c.163.com 等，同时也支持私有仓库，KubeCube
推荐使用社区主流的 Harbor 进行私有仓库的搭建，下文详述了在 KubeCube 中部署 Harbor 的方法</p><h2 id=安装-helm3>安装 helm3</h2><p>参考 <a href=https://helm.sh/zh/docs/intro/install/>helm安装</a></p><h2 id=确认-storageclass>确认 StorageClass</h2><p>你可以选择 KubeCube 内置的 local-path 作为默认的 StorageClass，也可以使用自定义的 StorageClass</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-&gt; kubectl get storageclasses
NAME                   PROVISIONER             RECLAIMPOLICY   VOLUMEBINDINGMODE      ALLOWVOLUMEEXPANSION   AGE
local-path <span style=color:#ce5c00;font-weight:700>(</span>default<span style=color:#ce5c00;font-weight:700>)</span>   rancher.io/local-path   Delete          WaitForFirstConsumer   <span style=color:#204a87>false</span>                  28d
</code></pre></div><h2 id=创建-harbor-的-namespace>创建 Harbor 的 Namespace</h2><p>创建指定的 namespace 来部署 Harbor 的相关组件</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl create namespace harbor-system
</code></pre></div><h2 id=创建自定义证书可选>创建自定义证书（可选）</h2><p>安装 Harbor 推荐使用 HTTPS 协议，需要 TLS 证书，如果不提供证书，Harbor 将会自己生成一个，不过它的有效期仅为一年</p><ul><li>生成证书</li></ul><p>⚠️ Common Name 必须要设置为和你要给 Harbor 的域名保持一致</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># 获得证书</span>
openssl req -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days <span style=color:#0000cf;font-weight:700>3650</span> -out ca.crt

<span style=color:#8f5902;font-style:italic># 生成证书签名请求</span>
openssl req -newkey rsa:4096 -nodes -sha256 -keyout tls.key -out tls.csr

<span style=color:#8f5902;font-style:italic># 生成证书</span>
openssl x509 -req -days <span style=color:#0000cf;font-weight:700>3650</span> -in tls.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out tls.crt
</code></pre></div><ul><li>使用证书生成 secret</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kubectl create secret generic harbor-tls --from-file<span style=color:#ce5c00;font-weight:700>=</span>tls.crt --from-file<span style=color:#ce5c00;font-weight:700>=</span>tls.key --from-file<span style=color:#ce5c00;font-weight:700>=</span>ca.crt -n harbor-system
</code></pre></div><h2 id=设置-harbor-的自定义安装参数>设置 Harbor 的自定义安装参数</h2><p>通过编辑 values.yaml 来复写 Harbor Chart 的安装参数，完整的 values.yaml 文件可以参考 <a href=https://github.com/goharbor/harbor-helm/blob/master/values.yaml>goharbor</a></p><blockquote><p>KubeCube 内置了 nginx-ingress controller</p></blockquote><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#8f5902;font-style:italic>#Ingress 网关入口配置</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>expose</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ingress</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic>### 是否启用 https 协议</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ingress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic>### 配置 Harbor 的访问域名，需要注意的是配置 notary 域名要和 core 处第一个单词外，其余保持一致</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>core</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>harbor.kubecube.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>notary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>notary.kubecube.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ingress.kubernetes.io/ssl-redirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>ingress.kubernetes.io/proxy-body-size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic>#### 如果是 traefik ingress，则按下面配置：</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#      kubernetes.io/ingress.class: &#34;traefik&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#      traefik.ingress.kubernetes.io/router.tls: &#39;true&#39;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>#      traefik.ingress.kubernetes.io/router.entrypoints: websecure</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#8f5902;font-style:italic>#### 如果是 nginx ingress，则按下面配置：</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/ssl-redirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/proxy-body-size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>nginx.org/client-max-body-size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;0&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>## 如果Harbor部署在代理后，将其设置为代理的URL，这个值一般要和上面的 Ingress 配置的地址保存一致</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>externalURL</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://harbor.kubecube.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>### Harbor 各个组件的持久化配置，并设置各个组件 existingClaim 参数为上面创建的对应 PVC 名称</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>persistence</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>### 存储保留策略，当PVC、PV删除后，是否保留存储数据</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>resourcePolicy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;keep&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>persistentVolumeClaim</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>registry</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>storageClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;local-path&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>chartmuseum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>storageClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;local-path&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>jobservice</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>storageClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;local-path&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>storageClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;local-path&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>redis</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>storageClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;local-path&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>trivy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>storageClass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;local-path&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>### 默认用户名 admin 的密码配置，注意：密码中一定要包含大小写字母与数字</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>harborAdminPassword</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;admin@123&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#8f5902;font-style:italic>### 设置日志级别</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>logLevel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>info</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h2 id=安装-harbor>安装 Harbor</h2><ul><li>添加 Helm 仓库</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm repo add harbor https://helm.goharbor.io
</code></pre></div><ul><li>部署 Harbor</li></ul><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>helm install harbor harbor/harbor -f values.yaml -n harbor-system
</code></pre></div><ul><li>域名配置</li></ul><p>如果没有 DNS 服务，需要自行在 hosts 文件中配置域名和 node ip 的映射</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>-&gt; cat /etc/hosts
...
x.x.x.x harbor.kubecube.io
</code></pre></div><h2 id=访问-harbor>访问 harbor</h2><p>在浏览器中输入 harbor.kubecube.io 来访问 Harbor 仓库</p><pre><code>用户：admin
密码：admin@123
</code></pre><p><img src=/imgs/user-guide/harbor/harbor/harbor-view.png alt=harbor-view></p><h2 id=下载-harbor-证书并在-docker-中配置>下载 Harbor 证书并在 Docker 中配置</h2><p>在 Harbor 管理页面中证书</p><p><img src=/imgs/user-guide/harbor/harbor/ca-down.png alt=ca-down></p><p>进入服务器，创建以 Harbor 域名为名的文件夹</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>mkdir -p /etc/docker/certs.d/harbor.kubecube.io
</code></pre></div><p>将下载下来 ca.crt 放到该文件夹下面，然后登陆 Harbor 仓库</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker login -u admin -p admin@123 harbor.kubecube.io
</code></pre></div><h2 id=测试>测试</h2><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker pull ubuntu:16.04
docker tag ubuntu:16.04 harbor.kubecube.io/library/ubuntu:16.04
docker push harbor.kubecube.io/library/ubuntu:16.04
</code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-00a377bd4e65e6c156ab92b1f26089be>4.7 - 网络存储</h1></div><div class=td-content><h1 id=pg-001c322fad8d5b93ed1cf9679ad7ea4a>4.7.1 - NFS服务</h1><p>本文档介绍了如何在 KubeCube 上接入 NFS 服务。</p><h2 id=准备工作>准备工作</h2><p><strong>登录 NFS 服务器</strong></p><ol><li><p>通过 NFS 导出文件为 KubeCube 分配服务器访问权限</p><p>修改 <code>/etc/exports</code> 文件，添加 <code>{导出目录} {KubeCube应用所在节点IP}(rw,sync,no_subtree_check,insecure)</code>。如：</p><p><img src=/imgs/user-guide/network-storage/nfs/nfs-6.png alt=nfs-6></p></li><li><p>重新启动 NFS 服务器</p><pre><code class=language-ssh data-lang=ssh>systemctl restart nfs-kernel-server
</code></pre></li><li><p>为 KubeCube 打开防火墙</p><pre><code class=language-ssh data-lang=ssh>ufw allow from {KubeCube所在节点IP} to any port nfs
</code></pre></li></ol><p><strong>登录 K8s 集群 worker 节点</strong></p><ol><li><p>安装 NFS Common</p><p><code>apt-get install nfs-common</code> 或 <code>yum install nfs-utils</code>等。</p></li><li><p>修改<code>/etc/kubernetes/manifests/kube-apiserver.yaml</code>文件，添加<code>- --feature-gates=RemoveSelfLink=false</code>。</p></li></ol><h2 id=创建-storageclass>创建 StorageClass</h2><p>登录 KubeCube 所在节点，创建以下文件并 apply，请根据实际环境修改部分参数。</p><h3 id=配置-account-及相关权限>配置 account 及相关权限</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># replace with namespace where provisioner is deployed</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default       </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#根据实际环境设定namespace,下面类同</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterRole</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner-runner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>apiGroups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;persistentvolumes&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>verbs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;get&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;list&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;watch&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;create&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;delete&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>apiGroups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;persistentvolumeclaims&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>verbs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;get&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;list&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;watch&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;update&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>apiGroups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;storage.k8s.io&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;storageclasses&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>verbs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;get&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;list&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;watch&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>apiGroups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;events&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>verbs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;create&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;update&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;patch&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterRoleBinding</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>run-nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>subjects</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># replace with namespace where provisioner is deployed</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>roleRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterRole</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner-runner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiGroup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Role</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>leader-locking-nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># replace with namespace where provisioner is deployed</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>apiGroups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;endpoints&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>verbs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#34;get&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;list&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;watch&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;create&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;update&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;patch&#34;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>RoleBinding</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>leader-locking-nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>subjects</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ServiceAccount</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># replace with namespace where provisioner is deployed</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>roleRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Role</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>leader-locking-nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>apiGroup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>rbac.authorization.k8s.io</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=创建-nfs-provisioner>创建 NFS Provisioner</h3><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># replace with namespace where provisioner is deployed</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#与RBAC文件中的namespace保持一致</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Recreate</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>serviceAccountName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-provisioner</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>quay.io/external_storage/nfs-client-provisioner:latest</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>volumeMounts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-root</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>mountPath</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/persistentvolumes</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>PROVISIONER_NAME</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>qgg-nfs-storage </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#provisioner名称,请确保该名称与 nfs-StorageClass.yaml文件中的provisioner名称保持一致</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NFS_SERVER</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10.173.32.164</span><span style=color:#f8f8f8;text-decoration:underline>   </span><span style=color:#8f5902;font-style:italic>#NFS Server IP地址</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>NFS_PATH  </span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/mnt/linuxidc   </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#NFS挂载卷</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nfs-client-root</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>nfs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10.173.32.164</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#NFS Server IP地址</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/mnt/linuxidc    </span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#NFS 挂载卷</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=创建-storageclass-1>创建 StorageClass</h3><p>方式一：命令行操作</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StorageClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>managed-nfs-storage</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>provisioner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>qgg-nfs-storage</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic>#这里的名称要和provisioner配置文件中的环境变量PROVISIONER_NAME保持一致</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>  	      
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>archiveOnDelete</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>方式二：页面操作</p><ol><li>以平台管理员身份登录 KubeCube；</li><li>展开左侧菜单栏里的【资源管理】，点击【集群管理】进入集群管理页面，点击需要创建 StorageClass 的集群名称，进入集群详情页面，点击【存储类别】进入存储类别管理页面，点击【创建存储类别】，将方式一中的文件内容写入，点击【确定】，即创建出该 StorageClass。</li></ol><p><img src=/imgs/user-guide/network-storage/nfs/nfs-1.png alt=nfs-1></p><h2 id=创建-pvc>创建 PVC</h2><p>在控制台页面，选择租户和项目，选择集群和空间，点击左侧菜单栏【存储】进入存储管理页面。点击【创建存储声明】，存储类别可以选择已创建过的 StorageClass。</p><p><img src=/imgs/user-guide/network-storage/nfs/nfs-2.png alt=nfs-2></p><p>创建后可以看到 PVC 状态为 Bound。具体配置说明见 <a href=https://www.kubecube.io/docs/user-guide/ns-scoped-res/storage/pvc/>PVC管理</a>。</p><p><img src=/imgs/user-guide/network-storage/nfs/nfs-3.png alt=nfs-3></p><h2 id=创建工作负载>创建工作负载</h2><p>在创建工作负载时，点击【展开更多配置】-【挂载数据卷】-【PVC】-【参数】，可以选择上述创建的 PVC。</p><p><img src=/imgs/user-guide/network-storage/nfs/nfs-4.png alt=nfs-4></p><p>具体配置说明见 <a href=https://www.kubecube.io/docs/user-guide/ns-scoped-res/workload/>工作负载管理</a>。</p><h2 id=检查结果>检查结果</h2><p>创建挂载 PVC 的工作负载后，登录 NFS 服务器，进入导出目录，可以看到已经创建出一个新的文件夹，文件夹命名为 ${namespace}-${pvcName}-${pvName}。</p><p><img src=/imgs/user-guide/network-storage/nfs/nfs-5.png alt=nfs-5></p></div><div class=td-content style=page-break-before:always><h1 id=pg-dd73f2d4468a1047db562f521be9af8a>4.7.2 - Ceph集群</h1><p>本文档介绍了如何在 KubeCube 上接入 Ceph 集群。</p><h2 id=环境说明>环境说明</h2><table><thead><tr><th style=text-align:left>产品</th><th style=text-align:left>版本</th></tr></thead><tbody><tr><td style=text-align:left>Kubernetes</td><td style=text-align:left>v1.20.9</td></tr><tr><td style=text-align:left>KubeCube</td><td style=text-align:left>v1.0.0</td></tr><tr><td style=text-align:left>Ceph</td><td style=text-align:left>15.2.1</td></tr></tbody></table><h2 id=准备工作>准备工作</h2><p><strong>登录 Ceph master 节点</strong></p><ol><li><p>获取管理 key</p><pre><code>ceph auth get-key client.admin | base64
</code></pre></li><li><p>在 Ceph 集群中创建一个 KubeCube 专用的 pool 和用户</p><pre><code class=language-ssh data-lang=ssh>ceph osd pool create kube 8 8
ceph auth get-or-create client.kube mon 'allow r' osd 'allow class-read object_prefix rbd
</code></pre></li><li><p>获取该用户 key</p><pre><code>ceph auth get-key client.kube｜base64
</code></pre></li></ol><p><strong>登录 K8s 集群 worker 节点</strong></p><ol><li><p>安装 ceph-common</p><p><code>apt-get install ceph-common</code> 或 <code>yum install ceph-common</code>等。</p></li><li><p>使用外部的 Provisioner 提供服务</p><pre><code>git clone https://github.com/kubernetes-incubator/external-storage.git    # v5.5.0
cd external-storage/ceph/rbd/deploy 
sed -r -i &quot;s/namespace: [^ ]+/namespace: kube-system/g&quot; ./rbac/clusterrolebinding.yaml ./rbac/rolebinding.yaml 
kubectl -n kube-system apply -f ./rbac
</code></pre></li></ol><h2 id=创建-secret>创建 Secret</h2><p>登录 KubeCube 所在节点，执行以下命令：</p><pre><code class=language-ssh data-lang=ssh># 替换为 Ceph 集群生成的 key
kubectl create secret generic ceph-secret --type=&quot;kubernetes.io/rbd&quot; --from-literal=key='QVFEcGpqbGhqczJnQWhBQTByN3NNbHB4cTAwdGR1eWdqWk1LaUE9PQ==' --namespace=kube-system
kubectl create secret generic ceph-kube-secret --type=&quot;kubernetes.io/rbd&quot; --from-literal=key='QVFDTHhUcGhMS0VMQWhBQWx3NU1MNzZneVRpR1dNYVdVckgxN0E9PQ==' --namespace=default
</code></pre><h2 id=创建-storageclass>创建 StorageClass</h2><p>方式一：命令行操作</p><p><code>vi sc.yaml</code> 文件并 apply，以下为示例，需要根据 Ceph 集群信息修改参数。</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>storage.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>StorageClass</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ceph-rbd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>     </span><span style=color:#204a87;font-weight:700>storageclass.beta.kubernetes.io/is-default-class</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>provisioner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ceph.com/rbd</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>monitors</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>10.173.32.173</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>6789</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic>#修改成实际 Ceph Monitor IP</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>adminId</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>admin</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>adminSecretName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ceph-secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>adminSecretNamespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kube-system</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>pool</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kube</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>userId</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kube</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>userSecretName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ceph-kube-secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>userSecretNamespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>default</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>fsType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ext4</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>imageFormat</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;2&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>imageFeatures</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;layering&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><p>关于上面的 adminId 等字段的具体含义请参考 <a href=https://kubernetes.io/zh/docs/concepts/storage/storage-classes/#ceph-rbd>Ceph RBD</a>。</p><p>方式二：页面操作</p><ol><li>以平台管理员身份登录 KubeCube；</li><li>展开左侧菜单栏里的【资源管理】，点击【集群管理】进入集群管理页面，点击需要创建 StorageClass 的集群名称，进入集群详情页面，点击【存储类别】进入存储类别管理页面，点击【创建存储类别】，将方式一中的文件内容写入，点击【确定】，即创建出该 StorageClass。</li></ol><p><img src=/imgs/user-guide/network-storage/ceph/ceph-1.png alt=ceph-1></p><h2 id=创建-pvc>创建 PVC</h2><p>在控制台页面，选择租户和项目，选择集群和空间，点击左侧菜单栏【存储】进入存储管理页面。点击【创建存储声明】，存储类别选择 Ceph 对应的 StorageClass。</p><p><img src=/imgs/user-guide/network-storage/ceph/ceph-2.png alt=nfs-2></p><p>创建后可以看到 PVC 状态为 Bound。具体配置说明见 <a href=https://www.kubecube.io/docs/user-guide/ns-scoped-res/storage/pvc/>PVC管理</a>。</p><h2 id=创建工作负载>创建工作负载</h2><p>在创建工作负载时，点击【展开更多配置】-【挂载数据卷】-【PVC】-【参数】，可以选择上述创建的 PVC。</p><p><img src=/imgs/user-guide/network-storage/nfs/nfs-4.png alt=nfs-4></p><p>具体配置说明见 <a href=https://www.kubecube.io/docs/user-guide/ns-scoped-res/workload/>工作负载管理</a>。</p><h2 id=检查结果>检查结果</h2><p>检查相关 pod 是否正常运行，如果正常则配置成功。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-dece28c3c2f52b05590fc745428b6c67>4.8 - 排障系统</h1><p>本文档介绍了如何在 KubeCube 上集成 <a href=https://github.com/kubediag/kubediag>KubeDiag</a> 排障系统。</p><h2 id=准备工作>准备工作</h2><ol><li>由于 KubeDiag 使用 CertManager 进行证书管理，如果集群中已安装 CertManager，可跳过这一步骤， 否则可参考<a href=https://cert-manager.io/docs/installation/kubernetes/>官方文档</a>进行安装，或运行以下命令进行快速安装。</li></ol><pre><code>kubectl apply --validate=false -f https://github.com/jetstack/cert-manager/releases/download/v1.0.2/cert-manager.yaml
</code></pre><h3 id=集成-kubediag>集成 KubeDiag</h3><p>1、使用平台管理员账号登录 KubeCube；</p><p>2、点击页面右上角【切换到控制台】，点击任意空间，进入到控制台页面；</p><ol start=3><li><p>在左侧菜单栏点击【自定义资源CRD】，进入到集群级别 CRD 列表，可以点击右上方输入 &ldquo;hotplug&rdquo; 进行搜索，找到 “hotplugs.hotplug.kubecube.io” CRD，点击【v1】版本进入 CRD 详情页；</p></li><li><p>选择 common 实例，点击【设置YAML】，将 KubeDiag 的状态改为启用, 即可为所有集群开启kubediag系统，如下所示:</p></li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubediag</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubediag</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>pkgName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>kubediag-helm-0.1.1.tgz</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span>- <span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>+     status</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>enabled</span><span style=color:#f8f8f8;text-decoration:underline>
</span></code></pre></div><h3 id=使用-kubediag>使用 KubeDiag</h3><p>如果希望非集群管理员角色的平台用户也能使用 KubeDiag 的资源进行集群诊断操作，需要将 KubeDiag 提供的相关 CRD 操作权限接入 KubeCube 的内置角色中，具体操作如下(在执行以下操作前，需要获取 Kubernetes 集群<code>cluster-admin</code>角色的 KubeConfig )：</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=color:#8f5902;font-style:italic># 为平台所有角色赋予view权限</span>
kubectl label clusterrole kubediag-view rbac.authorization.k8s.io/aggregate-to-reviewer<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
kubectl label clusterrole kubediag-view rbac.authorization.k8s.io/aggregate-to-project-admin<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
kubectl label clusterrole kubediag-view rbac.authorization.k8s.io/aggregate-to-tenant-admin<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
kubectl label clusterrole kubediag-view rbac.authorization.k8s.io/aggregate-to-platform-admin<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>

<span style=color:#8f5902;font-style:italic># 为项目管理员以上级别的角色赋予edit权限</span>
kubectl label clusterrole kubediag-edit rbac.authorization.k8s.io/aggregate-to-project-admin<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
kubectl label clusterrole kubediag-edit rbac.authorization.k8s.io/aggregate-to-tenant-admin<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
kubectl label clusterrole kubediag-edit rbac.authorization.k8s.io/aggregate-to-platform-admin<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</code></pre></div><p>完成以上操作后，即可使用平台用户登录 KubeCube 平台，在【自定义资源CRD】页面内，完成对 KubeDiag 相关 CRD 的管理，具体配置方式参考 KubeDiag <a href=https://github.com/kubediag/kubediag/tree/master/docs/api>API文档</a></p><p><img src=/imgs/user-guide/kubediag/create-diagnosis.png alt=create-diag></p></div><div class=td-content style=page-break-before:always><h1 id=pg-a7c9e10a31abdecaec5a338462a220a8>5 - 开发指南</h1></div><div class=td-content><h1 id=pg-b07c2acd70ea534eec1eeb8eed0b4f85>5.1 - OpenAPI使用指南</h1><h3 id=1获取密钥>1、获取密钥</h3><p>登录KubeCube，在右上角的下拉菜单中找到【密钥管理】页面，可以在该页面管理您账户的访问密钥对。</p><p><img src=/imgs/developer-guide/openapi-guide/key-manage.png alt=key-manage></p><blockquote><p>若进入到该页面中无密钥则点击【添加密钥】按钮创建，最多可以创建5对密钥。</p></blockquote><h3 id=2根据密钥对生成-token>2、根据密钥对生成 token</h3><blockquote><p>token有效期默认1小时，可以在启动时修改配置。</p></blockquote><p>生成token的接口如下：</p><p>请求url</p><pre><code>/api/v1/cube/key/token?accessKey=&amp;secretKey=
</code></pre><p>Method：GET</p><p>描述：根据密钥对生成token，token有效期默认为1小时。</p><p>请求参数</p><table><thead><tr><th>参数名</th><th>说明</th><th>参数类型</th><th>是否必填</th></tr></thead><tbody><tr><td>accessKey</td><td>密钥对Ak</td><td>string</td><td>是</td></tr><tr><td>secretKey</td><td>密钥对Sk</td><td>string</td><td>是</td></tr></tbody></table><p>返回参数</p><table><thead><tr><th>参数名</th><th>说明</th><th>参数类型</th></tr></thead><tbody><tr><td>token</td><td>可以用于访问KubeCube OpenAPI的token</td><td>string</td></tr></tbody></table><p>请求示例</p><pre><code class=language-linux data-lang=linux>curl https://kubecube.com/api/v1/cube/key/token?accessKey=0ad66675488c4855a07113a8e65719e3&amp;secretKey=8f732a291795418f81cec6f1b064334a -X GET
</code></pre><p>返回示例</p><pre><code>{&quot;token&quot;:&quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySW5mbyI6eyJ1c2VybmFtZSI6ImFkbWluIiwiZ3JvdXBzIjpbImt1YmVjdWJlIl19LCJleHAiOjE2MjQwMDMxMTJ9.DuR36vDDhLe_F5gw_T-8FCV7ZZVCJ1ye0dEpfELSa3g&quot;}
</code></pre><h3 id=3使用-token-访问-api>3、使用 token 访问 API</h3><p>在访问KubeCube openAPI时，在请求中加上请求头<code>Authorization:Bearer ${token}</code>以标识访问者的身份，其中${token}是第二步中获取到的token值，具体接口信息见下接口文档。</p><p><strong>请求示例</strong></p><pre><code>curl -X GET -H 'Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySW5mbyI6eyJ1c2VybmFtZSI6ImFkbWluIiwiZ3JvdXBzIjpbImt1YmVjdWJlIl19LCJleHAiOjE2MjQwMDMxMTJ9.DuR36vDDhLe_F5gw_T-8FCV7ZZVCJ1ye0dEpfELSa3g' https://kubecube.com/api/v1/cube/proxy/clusters/pivot-cluster/api/v1/pods -k
</code></pre><p><strong>得到结果</strong></p><pre><code>{&quot;apiVersion&quot;:&quot;v1&quot;,&quot;code&quot;:404,&quot;details&quot;:{&quot;kind&quot;:&quot;pods&quot;,&quot;name&quot;:&quot;kubecube&quot;},&quot;kind&quot;:&quot;Status&quot;,&quot;message&quot;:&quot;pods \&quot;kubecube\&quot; not found&quot;,&quot;metadata&quot;:{},&quot;reason&quot;:&quot;NotFound&quot;,&quot;status&quot;:&quot;Failure&quot;}
</code></pre><h3 id=4接口文档>4、接口文档</h3><h4 id=访问-kubecube-自研接口>访问 KubeCube 自研接口</h4><p>点击【开发指南】-【自研接口文档】，该接口文档描述了 KubeCube 的自研接口。</p><h4 id=访问-kubernetes-资源>访问 Kubernetes 资源</h4><p>访问 Kubernetes 原生资源的接口文档如下：</p><p><strong>请求url</strong>：</p><pre><code>https://{管控节点IP}:30443/api/v1/cube/proxy/clusters/{clusterName}/*url?selector=&amp;pageSize=&amp;pageNum=&amp;sortName=&amp;sortOrder=sortFunc=
</code></pre><ul><li><p><code>*url</code>指的是直接调用 Kubernetes 时的接口，</p><p>接口文档为：https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.19/#watch-pod-v1-core。</p></li><li><p>selector：查询条件，支持精准匹配和模糊匹配：</p><ul><li>精准匹配：eg. selector=key1=value1,key2=value2,key3=value3；</li><li>模糊匹配：eg. selector=key1~value1,key2~value2,key3~value3；</li><li>混合匹配：eg. selector=key1~value1,key2=value2,key3=value3；</li></ul></li><li><p>pageSize：查询结果每页的数量，默认值为10；</p></li><li><p>pageNum：查询结果的页数，默认为1；</p></li><li><p>sortName：查询结果排序依据的字段，默认为 &ldquo;metadata.name&rdquo;；</p></li><li><p>sortOrder：查询结果正序或倒序显示：正序为 &ldquo;asc&rdquo;，倒序为 &ldquo;desc&rdquo;，默认为正序；</p></li><li><p>sortFunc：sortName 的数据类型，默认为 &ldquo;string&rdquo;。</p></li></ul><p>返回参数同 Kubernetes 的返回参数。</p><p><strong>请求示例</strong></p><p>如果需要查询某个namespace下的 deployment 列表，并希望结果以 deployment 的创建时间倒序排序、以20条结果为1页，返回第2页的结果：</p><p>1、查询 Kubernetes 接口文档：查询 deployment 列表的接口为</p><pre><code>GET /apis/apps/v1/namespaces/{namespace}/deployments
</code></pre><p>2、因此， KubeCube 查询 deployment 的对应接口为</p><pre><code>GET /api/v1/cube/proxy/clusters/{clusterName}/apis/apps/v1/namespaces/{namespace}/deployments?sortName=CreationTimestamp&amp;sortOrder=desc&amp;pageSize=20&amp;pageNum=2
</code></pre><p>3、使用 token 访问则为：</p><pre><code class=language-linux data-lang=linux>curl -X GET -H 'Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySW5mbyI6eyJ1c2VybmFtZSI6ImFkbWluIiwiZ3JvdXBzIjpbImt1YmVjdWJlIl19LCJleHAiOjE2MjQ2MTY3MjZ9.FCfuVzADMAgYeOm39Wlhs-3B6kW-Z6bZ9js1lKoNub0' https://kubecube.com/api/v1/cube/proxy/clusters/pivot-cluster/apis/apps/v1/namespaces/namespaceA/deployments?sortName=metadata.creationTimestamp&amp;sortOrder=desc&amp;pageSize=20&amp;pageNum=2 -k
</code></pre><h5 id=访问-crd-资源>访问 CRD 资源</h5><p>访问 CRD 资源的接口文档如下：</p><p><strong>请求url</strong>：</p><pre><code>https://{管控节点IP}:30443/api/v1/cube/proxy/clusters/{clusterName}/apis/{CRDGroup}/v1/{CRDKinds}/*url?selector=&amp;pageSize=&amp;pageNum=&amp;sortName=&amp;sortOrder=sortFunc=
</code></pre><p>参数含义同上。</p><p><strong>请求示例</strong></p><p>如果需要查询"pivot-cluster"集群里的租户列表，则对应接口为：</p><pre><code>GET /api/v1/cube/proxy/clusters/pivot-cluster/apis/tenant.kubecube.io/v1/tenants
</code></pre><p>使用 token 访问则为：</p><pre><code class=language-linux data-lang=linux>curl -X GET -H 'Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySW5mbyI6eyJ1c2VybmFtZSI6ImFkbWluIiwiZ3JvdXBzIjpbImt1YmVjdWJlIl19LCJleHAiOjE2MjQ2MTY3MjZ9.FCfuVzADMAgYeOm39Wlhs-3B6kW-Z6bZ9js1lKoNub0' https://kubecube.com/api/v1/cube/proxy/clusters/pivot-cluster/apis/tenant.kubecube.io/v1/tenants -k
</code></pre></div><div class=td-content style=page-break-before:always><h1 id=pg-9ad7e56bcc725275dc9706e2f85e840a>5.2 - 自研接口文档</h1><div id=ohpen_swagger_ui></div><script>window.onload=function(){const a=SwaggerUIBundle({url:"/swagger.json",dom_id:'#ohpen_swagger_ui',presets:[SwaggerUIBundle.presets.apis,SwaggerUIStandalonePreset]});window.ui=a}</script></div><div class=td-content style=page-break-before:always><h1 id=pg-644345609da22c61e3a674258f71713e>5.3 - 参与贡献</h1><p>Welcome to KubeCube community! If you are looking for information on how to join us, you are in the right place. We encourage you to help out by reporting issues, improving documentation, fixing bugs, or adding new features. Every contribution is precious for KubeCube.</p><h2 id=reporting-issues>Reporting issues</h2><p>To be honest, we regard every user of KubeCube as a very kind contributor. After experiencing KubeCube, you may have some feedback for the project. Then feel free to open an issue.</p><p>There are lot of cases when you could open an issue:</p><ul><li>bug report</li><li>feature request</li><li>performance issues</li><li>feature proposal</li><li>feature design</li><li>help wanted</li><li>doc incomplete</li><li>test improvement</li><li>any questions on project</li><li>&mldr;</li></ul><p>Also we must remind that when filing a new issue, please remember to remove the sensitive data from your post. Sensitive data could be password, secret key, network locations, private business data and so on.</p><h2 id=contribution>Contribution</h2><p>To put forward a PR, we assume you have registered a GitHub ID. Then you could finish the preparation in the following steps:</p><ol><li>Fork the repository you wish to work on. You just need to click the button Fork in right-left of project repository main page. Then you will end up with your repository in your GitHub username.</li><li>Clone your own repository to develop locally. Use git clone <a href=https://github.com/>https://github.com/</a><your-username>/<project>.git to clone repository to your local machine. Then you can create new branches to finish the change you wish to make.</li><li>Set remote upstream to be <a href=https://github.com/kubecube-io/>https://github.com/kubecube-io/</a><project>.git using the following two commands:</li></ol><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git remote add upstream https://github.com/kubecube-io/&lt;project&gt;.git
git remote set-url --push upstream no-pushing
</code></pre></div><p>Adding this, we can easily synchronize local branches with upstream branches.</p><ol start=4><li><strong>Create a branch</strong> to add a new feature or fix issues</li></ol><p>Update local working directory:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#204a87>cd</span> &lt;project&gt;
git fetch upstream
git checkout master
git rebase upstream/master
</code></pre></div><p>Create a new branch:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>git checkout -b &lt;new-branch&gt;
</code></pre></div><p>Make any change on the new-branch then build and test your codes.</p><h3 id=pr-description>PR Description</h3><p>PR is the only way to make changes to KubeCube project files. To help reviewers better get your purpose, PR description could not be too detailed. We encourage contributors to follow the <a href=https://github.com/kubecube-io/kubecube/blob/main/.github/PULL_REQUEST_TEMPLATE.md>PR template</a> to finish the pull request.</p><h3 id=developing-environment>Developing Environment</h3><p>As a contributor, if you want to make any contribution to KubeCube project, we should reach an agreement on the version of tools used in the development environment. Here are some dependents with specific version:</p><p>Golang : v1.14+ (1.16 is best)
Kubernetes: v1.18+</p><h3 id=developing-guide>Developing guide</h3><p>There&rsquo;s a <code>Makefile</code> in the root folder which describes the options to build and install. Here are some common ones:</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># Run the tests</span>
make <span style=color:#204a87>test</span>

<span style=color:#8f5902;font-style:italic># Swag doc generate</span>
make swag-gen

<span style=color:#8f5902;font-style:italic># Cube binary build</span>
make docker-build-cube

<span style=color:#8f5902;font-style:italic># Warden binary build</span>
make docker-build-warden

<span style=color:#8f5902;font-style:italic># Install dependence into env</span>
make install
</code></pre></div><p>If you want to start KubeCube and Warden locally to work with a Kubernetes cluster, you should follow the <a href=https://www.kubecube.io/docs/developer-guide/debug/>debug guide</a>.</p><h2 id=join-kubecube-as-a-member>Join KubeCube as a member</h2><p>It is also welcomed to join KubeCube team if you are willing to participate in KubeCube community continuously and keep active.</p><h3 id=requirements>Requirements</h3><ul><li>Have read the <a href=https://www.kubecube.io/docs/developer-guide/contributing/>Contributing to KubeCube</a> carefully</li><li>Have submitted multi PRs to the community</li><li>Be active in the community, may including but not limited<ul><li>Submitting or commenting on issues</li><li>Contributing PRs to the community</li><li>Reviewing PRs in the community</li></ul></li></ul><h3 id=how-to-do-it>How to do it</h3><p>You can try in either of two ways:</p><ul><li><p>Report a issues</p></li><li><p>Submit a PR in the project repo</p></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-1841a4f03855471e6ec8d83e4fe1ce99>5.4 - 如何调试</h1><h2 id=如何进行本地调试>如何进行本地调试</h2><p><strong>安装 docker</strong></p><p>参照 <a href=https://docs.docker.com/install/>official docker installation guide</a>.</p><p><strong>安装 minikube</strong></p><p>参照 <a href=https://kubernetes.io/docs/tasks/tools/install-minikube/>official minikube installation guide</a>.</p><p><strong>使用 kubeadm 创建集群</strong></p><p>参照 <a href=https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/>official creating a cluster with kubeadm</a></p><h3 id=本地调试>本地调试</h3><p>安装 manifests 依赖</p><p>⚠️ K8S_API_SERVER_ENDPOINT 为 k8s 的 api-server 地址，请根据环境填入对应的地址</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#000>K8S_API_SERVER_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;0.0.0.0:6443&#34;</span>
bash hack/install_local.sh <span style=color:#4e9a06>${</span><span style=color:#000>K8S_API_SERVER_ENDPOINT</span><span style=color:#4e9a06>}</span>
</code></pre></div><p>调试 kubecube</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make run-cube
</code></pre></div><p>调试 warden</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make run-warden
</code></pre></div><p>卸载 manifests 依赖</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>bash hack/uninstall_local.sh
</code></pre></div><h3 id=使用-pod-进行调试>使用 pod 进行调试</h3><p>请参照 <a href=https://www.kubecube.io/docs/quick-start/installation/#all-in-one-%E9%83%A8%E7%BD%B2>all in one 部署</a> 进行 kubecube 安装</p><p>构建 kubecube 镜像</p><div class=highlight><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>make docker-build-cube <span style=color:#000>IMG</span><span style=color:#ce5c00;font-weight:700>={</span>image-tag<span style=color:#ce5c00;font-weight:700>}</span>
</code></pre></div><p>构建 warden 镜像</p><pre><code>make docker-build-wardeb IMG={image-tag}
</code></pre><p>使用构建完成的镜像替换对应 deployment 中的镜像，并使用 <code>kubectl logs</code> 进行 debug</p></div><div class=td-content style=page-break-before:always><h1 id=pg-1c91a59640f4d19bcf14ebed849a10e0>6 - FAQ</h1><p>FAQ</p></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank rel=noopener href=https://github.com/kubecube-io/kubecube aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"><small class=text-white>&copy; 2021 KubeCube Project Authors All Rights Reserved</small>
<small class=ml-1><a href=http://www.apache.org/licenses/LICENSE-2.0 target=_blank rel=noopener>隐私政策</a></small></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.3b172c13b62c2bea8b1c9d2599cddc8cf89718a92d792c680871c81ba43d8c85.js integrity="sha256-OxcsE7YsK+qLHJ0lmc3cjPiXGKkteSxoCHHIG6Q9jIU=" crossorigin=anonymous></script></body></html>